<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Wing Chun Simon Game</title>
<style>
  :root{--panel:#1c1715;--panel2:#241d1b;--ink:#e8d6b8;
    --red:#d34b43;--blue:#3d74d6;--green:#4cb36c;--gold:#d1a341;}
  html,body{margin:0;height:100%;background:#0b0a0a;color:#eee;font-family:system-ui,Segoe UI,Roboto,Arial}
  #app{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr auto}
  header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:linear-gradient(180deg,var(--panel),var(--panel2));border-bottom:1px solid #2a2322}
  header .score{font-size:14px} header .best{opacity:.8}
  footer{padding:6px 12px;font-size:12px;opacity:.6;text-align:center;background:linear-gradient(180deg,var(--panel2),#120f0f)}
  #stageWrap{position:relative;overflow:hidden;background:#0f0e0e}
  #stage{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(100vw,960px);height:min(56vw,540px);max-height:72vh}
  canvas{position:absolute;inset:0;width:100%;height:100%;image-rendering:pixelated;image-rendering:crisp-edges}
  /* BOUTONS: gris par d√©faut, n'√©clairent qu'en lecture */
  #board{position:absolute;left:20px;bottom:20px;display:grid;grid-template-columns:repeat(2,132px);grid-gap:14px;z-index:5}
  .pad{width:132px;height:100px;border-radius:14px;background:linear-gradient(#2a2a2a,#1e1e1e);
    color:#cfcfcf;display:flex;align-items:center;justify-content:center;font-weight:700;letter-spacing:.3px;
    box-shadow:inset 0 0 0 2px #000,0 6px 22px rgba(0,0,0,.45);cursor:pointer;transition:transform .06s ease,filter .12s}
  .pad:active{transform:translateY(2px)}
  .pad small{display:block;font-weight:400;opacity:.8;margin-top:2px}
  /* Effet d‚Äôillumination Simon (couleurs internes uniquement quand jou√©) */
  .lit{filter:brightness(1.7);box-shadow:inset 0 0 0 2px #fff3,0 0 42px currentColor}
  .lit.red{color:var(--red)} .lit.blue{color:var(--blue)} .lit.green{color:var(--green)} .lit.gold{color:var(--gold)}
  /* Menu */
  #menu{position:absolute;inset:0;display:grid;place-items:center;background:linear-gradient(180deg,#0b0a0a 0,#151213 70%,#0b0a0a 100%);z-index:10}
  .panel{background:linear-gradient(180deg,#1d1816,#231d1c);border:1px solid #2a2322;border-radius:16px;padding:28px 24px;width:min(760px,92vw);box-shadow:0 20px 80px rgba(0,0,0,.6)}
  .title{font-size:44px;text-align:center;margin:0 0 10px;color:var(--ink);text-shadow:0 2px 0 #000,0 0 24px rgba(209,163,65,.35)}
  .zh{font-weight:900;letter-spacing:2px;color:#d1a341}
  .actions{display:flex;gap:12px;justify-content:center}
  .btn{background:linear-gradient(180deg,#2a221f,#1f1a18);border:1px solid #3a302d;color:#e9d9bc;padding:12px 18px;border-radius:10px;font-weight:700;cursor:pointer}
  .btn:hover{filter:brightness(1.08)}
  .hi{font-size:14px;text-align:center;margin-top:10px;opacity:.85}
  /* Onomatop√©e + flash erreur */
  #onom{position:absolute;left:50%;top:12%;transform:translate(-50%,0) scale(.6);font-size:72px;font-weight:900;color:#ffe9a8;text-shadow:0 4px 0 #000,0 0 22px #ffec9a;opacity:0;pointer-events:none;z-index:6}
  .pop{animation:pop .65s cubic-bezier(.2,.8,.2,1)}
  @keyframes pop{0%{opacity:0;transform:translate(-50%,0) scale(.6)}28%{opacity:1;transform:translate(-50%,0) scale(1.07)}100%{opacity:0;transform:translate(-50%,0) scale(1)}}
  #flash{position:absolute;inset:0;background:#ff000022;opacity:0;pointer-events:none;z-index:7}
  .boom{animation:boom .4s ease}@keyframes boom{0%{opacity:.65}100%{opacity:0}}
</style>
</head>
<body>
<div id="app">
  <header>
    <div><strong>Wing Chun Simon</strong></div>
    <div class="score">Score: <span id="score">0</span> ‚Ä¢ <span class="best">Meilleur: <span id="best">0</span></span></div>
  </header>

  <div id="stageWrap">
    <div id="stage">
      <canvas id="cx" width="768" height="432"></canvas>

      <div id="board" aria-label="Boutons">
        <button class="pad" data-tech="pak"><div>Pak Sao<small>[1]</small></div></button>
        <button class="pad" data-tech="tan"><div>Tan Sao<small>[2]</small></div></button>
        <button class="pad" data-tech="bon"><div>Bon Sao<small>[3]</small></div></button>
        <button class="pad" data-tech="punch"><div>Punch<small>[4]</small></div></button>
      </div>

      <div id="onom"></div>
      <div id="flash"></div>

      <div id="menu">
        <div class="panel">
          <h1 class="title"><span class="zh">Wing Chun</span> Simon Game</h1>
          <p class="subtitle">Reproduis la s√©quence. √Ä chaque tour, un bouton s‚Äôajoute. Les couleurs n‚Äôapparaissent que pendant la lecture.</p>
          <div class="actions">
            <button id="startBtn" class="btn">Commencer</button>
            <button id="muteBtn"  class="btn">üîä Son</button>
          </div>
          <div class="hi">Meilleur score: <span id="bestMenu">0</span></div>
        </div>
      </div>
    </div>
  </div>

  <footer>Canvas ‚Äú64-bit style‚Äù. Sons WAV dans <code>assets/sounds/</code>.</footer>
</div>

<script>
/* ======== SONS (WAV) ======== */
const SFX = {
  pak:   new Audio('assets/sounds/pak.wav'),
  tan:   new Audio('assets/sounds/tan.wav'),
  bon:   new Audio('assets/sounds/bon.wav'),
  punch: new Audio('assets/sounds/punch.wav'),
  wrong: new Audio('assets/sounds/wrong.wav')
};
Object.values(SFX).forEach(a=>{a.preload='auto';a.volume=.9;});

/* ======== ETAT ======== */
const pads = [...document.querySelectorAll('.pad')];
const scoreEl = document.getElementById('score');
const bestEl  = document.getElementById('best');
const bestMenuEl  = document.getElementById('bestMenu');
const menu   = document.getElementById('menu');
const startBtn = document.getElementById('startBtn');
const muteBtn  = document.getElementById('muteBtn');
const onom  = document.getElementById('onom');
const flash = document.getElementById('flash');
let muted=false; muteBtn.onclick=()=>{muted=!muted; muteBtn.textContent = muted?'üîá Muet':'üîä Son';};
const play=(a)=>{ if(!muted){ try{a.currentTime=0;a.play()}catch(e){} } };

let seq=[], userIndex=0, locked=true, score=0;
let best=+localStorage.getItem('wcs_best')||0; bestEl.textContent=best; bestMenuEl.textContent=best;

/* ======== MAPPINGS ======== */
const TECHS=['pak','tan','bon','punch'];
const TECH_TO_COLOR={pak:'gold',tan:'green',bon:'blue',punch:'red'}; // couleurs visibles seulement en lecture
const TECH_TO_SHOUT={pak:'PAK!',tan:'TAN!',bon:'BON!',punch:'PUNCH!'};

/* ======== CANVAS ======== */
const cx=document.getElementById('cx'); const ctx=cx.getContext('2d'); ctx.imageSmoothingEnabled=false;
const W=cx.width,H=cx.height;
const bgImg=new Image(); bgImg.src='https://i.imgur.com/D772Q4m.png';

function drawBG(){
  if(bgImg.complete) ctx.drawImage(bgImg,0,0,W,H);
  else { ctx.fillStyle='#111'; ctx.fillRect(0,0,W,H); }
  // assombrir l√©g√®rement pour lisibilit√©
  ctx.fillStyle='rgba(0,0,0,.25)'; ctx.fillRect(0,0,W,H);
}

/* Mannequin */
function drawDummy(){
  const x=W*0.66,y=H-100;
  ctx.fillStyle='#8a552b'; ctx.fillRect(x-10,y-92,20,90);
  ctx.fillStyle='#7a4b27'; ctx.fillRect(x-8,y-74, 38,6);
  ctx.fillRect(x-8,y-46, 34,6);
  ctx.fillRect(x-6,y-12, 12,28);
}

/* Perso simplifi√© (placeholder 64-bit) */
const fighter={x:W*0.42,y:H-64,pose:'idle',t0:0};
function drawFighter(t){
  const x=fighter.x,y=fighter.y;
  ctx.fillStyle='rgba(0,0,0,.35)'; ctx.beginPath(); ctx.ellipse(x-24,y-6,38,10,0,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#1b1d20'; ctx.fillRect(x-40,y-112,56,68); // torse
  ctx.fillStyle='#c7a880'; ctx.fillRect(x-20,y-132,24,24); // t√™te
  ctx.fillStyle='#171a1d'; ctx.fillRect(x-44,y-50,22,50); ctx.fillRect(x+2,y-50,22,50); // jambes
  ctx.fillStyle='#111'; ctx.fillRect(x-44,y,26,8); ctx.fillRect(x+2,y,26,8);
  ctx.fillStyle='#171a1d';
  if(fighter.pose==='idle'){ ctx.fillRect(x-54,y-88,18,40); ctx.fillRect(x+18,y-88,18,40); }
  if(fighter.pose==='pak'){  ctx.fillRect(x+12,y-88,18,40); ctx.fillStyle='#c7a880'; ctx.fillRect(x+28,y-72,26,10); }
  if(fighter.pose==='tan'){  ctx.fillRect(x+10,y-90,18,40); ctx.fillStyle='#c7a880'; ctx.fillRect(x+26,y-64,30,8); }
  if(fighter.pose==='bon'){  ctx.fillRect(x+6,y-96,18,46);  ctx.fillStyle='#c7a880'; ctx.fillRect(x+18,y-98,12,16); }
  if(fighter.pose==='punch'){ctx.fillRect(x+8,y-92,18,42);  ctx.fillStyle='#c7a880'; ctx.fillRect(x+26,y-72,24,10); }
}

/* Onomatop√©e */
function shout(txt){ onom.textContent=txt; onom.classList.remove('pop'); void onom.offsetWidth; onom.classList.add('pop'); }
/* Pose courte */
function doPose(name){ fighter.pose=name; fighter.t0=performance.now(); setTimeout(()=>{fighter.pose='idle';}, 280); }

/* ======== SIMON ======== */
function randTech(){ return TECHS[Math.random()*TECHS.length|0]; }
async function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

function setLit(tech,on){
  const color=TECH_TO_COLOR[tech];
  const btn=pads.find(b=>b.dataset.tech===tech);
  btn.classList.toggle('lit',on);
  btn.classList.toggle(color,on);
}

async function playSequence(){
  locked=true; await sleep(560);
  for(const tech of seq){
    setLit(tech,true);
    if(SFX[tech]) play(SFX[tech]);
    doPose(tech); shout(TECH_TO_SHOUT[tech]);
    await sleep(460);
    setLit(tech,false);
    await sleep(160);
  }
  locked=false; userIndex=0;
}

async function press(tech){
  if(locked) return;
  setLit(tech,true);
  if(SFX[tech]) play(SFX[tech]);
  doPose(tech); shout(TECH_TO_SHOUT[tech]);
  await sleep(200);
  setLit(tech,false);

  if(tech!==seq[userIndex]){
    play(SFX.wrong); flash.classList.remove('boom'); void flash.offsetWidth; flash.classList.add('boom');
    seq=[]; score=0; scoreEl.textContent=0; locked=true; await sleep(600); startGame(); return;
  }
  userIndex++;
  if(userIndex===seq.length){
    score++; scoreEl.textContent=score;
    if(score>best){best=score;bestEl.textContent=best;bestMenuEl.textContent=best;localStorage.setItem('wcs_best',best);}
    seq.push(randTech()); await sleep(420); playSequence();
  }
}

/* INPUT */
pads.forEach(b=>b.addEventListener('click',()=>press(b.dataset.tech)));
window.addEventListener('keydown',e=>{
  if(e.key==='1') press('pak');
  if(e.key==='2') press('tan');
  if(e.key==='3') press('bon');
  if(e.key==='4') press('punch');
});

/* FLOW */
function startGame(){
  menu.style.display='none';
  Object.values(SFX).forEach(a=>{ try{a.play().then(()=>a.pause()).catch(()=>{});}catch{} });
  seq=[randTech()]; score=0; scoreEl.textContent=0; playSequence();
}
document.getElementById('startBtn').addEventListener('click',startGame);

/* LOOP */
function loop(t){ drawBG(); drawDummy(); drawFighter(t); requestAnimationFrame(loop); }
requestAnimationFrame(loop);
</script>
</body>
</html>
