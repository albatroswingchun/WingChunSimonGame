"<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <!-- Anti-cache HTML (utile mais insuffisant seul) -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Wing Chun - Simon Game</title>

  <!-- Police -->
  <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">

  <!-- Preload images (URL EXACTEMENT identiques Ã  celles utilisÃ©es dans le JS) -->
  <link rel="preload" as="image" href="https://i.imgur.com/QW70yEx.png?v=20250817">
  <link rel="preload" as="image" href="https://i.imgur.com/I4gOsXm.png?v=20250817">

  <style>
    :root{
      --panel:#1c1715; --panel2:#241d1b; --ink:#e8d6b8; --gold:#d1a341;
      --scoreYellow:#FFD700;

      /* === Couleurs Simon + intensitÃ© halo === */
      --simon-red:#d34b43;
      --simon-green:#4cb36c;
      --simon-blue:#3d74d6;
      --simon-yellow:#d1a341;
      --tech-glow-spread: 24px;
      --tech-glow-blur: 36px;

      --bestBadgeShift: 20px;
    }

    /* Hauteur viewport stable mobiles */
    :root{ --vh: 100svh; }
    @supports (height: 100dvh) { :root{ --vh: 100dvh; } }

    /* Taille du stage exposÃ©e au CSS */
    :root { --stageW: 100vw; --stageH: var(--vh); }

    html,body{margin:0;height:100%;background:#0b0a0a;color:#eee;font-family:system-ui,Segoe UI,Roboto,Arial;overflow:hidden}
    #app{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr auto; min-height: var(--vh);}

    header{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:8px 12px;background:linear-gradient(180deg,var(--panel),var(--panel2));border-bottom:1px solid #2a2322;z-index:20}
    .chip{padding:6px 10px;border-radius:9px;background:#2a2422;border:1px solid #3a302d}
    .btn{background:#1e1b1a;border:1px solid #3a302d;color:#e8d6b8;border-radius:10px;padding:10px 16px;cursor:pointer;font-weight:700}
    .btn:hover{filter:brightness(1.08)}
    footer{padding:6px 12px;font-size:12px;opacity:.6;text-align:center;background:linear-gradient(180deg,var(--panel2),#120f0f);z-index:5}

    #stageWrap{position:relative;display:grid;place-items:center;overflow:hidden;background:#000}
    #stage{position:relative}
    canvas{position:absolute;left:0;top:0;touch-action:none;image-rendering:pixelated;image-rendering:crisp-edges}

    #board{position:absolute;left:50%;bottom:18px;transform:translateX(-50%);display:flex;gap:14px;z-index:10}

    /* === .pad avec police du score, plus lisible === */
    .pad{
      width:132px;height:100px;border-radius:14px;
      background:linear-gradient(#2a2a2a,#1e1e1e);
      color:#cfcfcf;display:flex;align-items:center;justify-content:center;
      font-weight:900;
      font-family:'Permanent Marker',cursive;
      text-transform:uppercase; letter-spacing:.5px;
      box-shadow:inset 0 0 0 2px #000,0 6px 22px rgba(0,0,0,.45);
      cursor:pointer;user-select:none;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    /* === couleur par technique (sert au halo via currentColor) === */
    .pad[data-tech="punch"]{ color: var(--simon-red);   }
    .pad[data-tech="pak"]  { color: var(--simon-green); }
    .pad[data-tech="tan"]  { color: var(--simon-blue);  }
    .pad[data-tech="bon"]  { color: var(--simon-yellow);}

    /* === Surbrillance faÃ§on Simon === */
    .lit{
      filter: brightness(1.85) saturate(1.15);
      box-shadow:
        inset 0 0 0 2px #fff3,
        0 0 var(--tech-glow-spread) currentColor,
        0 0 var(--tech-glow-blur) currentColor,
        0 8px 26px rgba(0,0,0,.50);
    }

    /* OnomatopÃ©es */
    #onoImg{
      position:absolute; left:50%; top:50%;
      width:auto; height:360px; opacity:0; pointer-events:none; z-index:11;
      transform:translate(-50%,-50%);
    }
    .onoShow{animation:onoFade .9s ease forwards}
    @keyframes onoFade{0%{opacity:0}20%{opacity:1}80%{opacity:1}100%{opacity:0}}
    #flash{position:absolute;inset:0;background:#ff000022;opacity:0;pointer-events:none;z-index:12}
    .boom{animation:boom .4s ease}@keyframes boom{0%{opacity:.65}100%{opacity:0}}

    #menu{position:absolute;inset:0;display:grid;place-items:center;background:transparent;z-index:15}
    .panel{background:rgba(0,0,0,.55);border-radius:16px;padding:28px 24px;text-align:center;border:1px solid #2f2724;min-width:560px}
    .title-main{font-family:'Permanent Marker',cursive;font-size:96px;line-height:0.9;margin:0;color:#e8d6b8;text-shadow:0 2px 0 #000,0 0 24px rgba(209,163,65,.35)}
    .title-sub{font-size:32px;margin:6px 0 12px;color:var(--gold)}
    .subtitle{opacity:.95;margin:0 0 16px}
    .actions{display:flex;gap:12px;justify-content:center}

    #skinsPanel{margin-top:14px;background:#1118;border:1px solid #2f2724;border-radius:12px;padding:14px;display:none}
    #skinsGrid{display:grid;grid-template-columns:repeat(2, minmax(160px,1fr));gap:12px}
    .skinCard{position:relative;background:#1a1716;border:1px solid #3a302d;border-radius:10px;padding:10px;cursor:pointer;text-align:center}
    .skinCard:hover{filter:brightness(1.05)}
    .skinActive{outline:2px solid var(--gold)}
    .skinThumb{display:block;margin:0 auto 8px;height:96px;width:auto;image-rendering:pixelated}
    /* verrou visuel */
    .skinLocked{opacity:.55; cursor:not-allowed;}
    .skinLocked::after{
      content:"ðŸ”’ VerrouillÃ©";
      position:absolute; left:50%; top:8px; transform:translateX(-50%);
      background:#000a; border:1px solid #3a302d; color:#e8d6b8; padding:3px 8px; border-radius:8px; font-size:12px;
    }

    /* Panneau rÃ©glages (T) */
    #devPanel{
      position:fixed; top:68px; right:12px; width:380px; max-height:85vh; overflow:auto;
      background:#111c; backdrop-filter: blur(6px); border:1px solid #2f2724; border-radius:12px; z-index:30;
      padding:12px; display:none;
    }
    #devPanel h2{margin:0 0 6px; font-size:18px}
    #devPanel h3{margin:12px 0 6px; font-size:15px; color:#ffd48a}
    #devPanel .row{display:grid; grid-template-columns:140px 1fr 64px; align-items:center; gap:6px; margin:6px 0}
    #devPanel .row input[type="range"]{width:100%}
    #devPanel .row input[type="number"]{width:64px; background:#1b1716; color:#e8d6b8; border:1px solid #3a302d; border-radius:6px; padding:6px}
    #devPanel .bar{display:flex; gap:8px; margin:8px 0 4px; flex-wrap:wrap}
    #devPanel .bar button, #devPanel .bar .seg{padding:8px 10px; border-radius:8px; border:1px solid #3a302d; background:#1e1b1a; color:#e8d6b8; cursor:pointer}
    #devPanel .seg{display:flex; gap:6px; flex:1; align-items:center; justify-content:space-between}
    #devPanel .seg button{flex:1; border-radius:6px}
    #devPanel .seg .active{outline:2px solid var(--gold)}
    .sep{margin:10px 0; height:1px; background:#2a2322}
    .hint{font-size:11px;opacity:.7;margin-top:6px}

    /* ============ UI FLUIDE (MENU + PADS) ============ */

    /* Menu proportionnel */
    #menu .panel{
      min-width: unset;
      width: min(92vw, calc(var(--stageW) * .90));
    }
    .title-main{ font-size: clamp(42px, calc(var(--stageW)*0.09), 96px); }
    .title-sub { font-size: clamp(18px, calc(var(--stageW)*0.035), 32px); }
    .subtitle  { font-size: clamp(14px, calc(var(--stageW)*0.022), 18px); }
    .btn{
      padding: clamp(8px, calc(var(--stageW)*0.012), 12px)
               clamp(12px, calc(var(--stageW)*0.02), 18px);
    }

    /* Pads 2Ã—2 en portrait (plus petits) */
    body.isPortrait #board{
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: min(18px, calc(var(--stageH)*0.03));
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: clamp(8px, calc(var(--stageW)*0.02), 18px);
      width: min(92vw, calc(var(--stageW) * .90));
    }
    body.isPortrait .pad{
      width: 80%;
      height: auto;
      aspect-ratio: 4 / 3;
      margin: 0 auto;
      font-size: clamp(14px, calc(var(--stageW)*0.04), 22px);
      max-width: 140px;
    }

    /* Pads proportionnels en paysage */
    body:not(.isPortrait) #board{ display:flex; gap: clamp(8px, calc(var(--stageW)*0.015), 14px); }
    body:not(.isPortrait) .pad{
      width:  clamp(100px,  calc(var(--stageW)*0.13), 148px);
      height: clamp(76px,  calc(var(--stageH)*0.12), 108px);
      font-size: clamp(14px, calc(var(--stageH)*0.032), 20px);
    }

    /* ============ HUD SCORE GÃ‰ANT ============ */
    #hud{ position:absolute; inset:0; z-index:13; pointer-events:none; }

    #scoreBox{
      position:absolute; left:50%; transform:translateX(-50%);
      top: clamp(8px, calc(var(--stageH)*0.06), 64px);
      text-align:center;
    }
    #scoreTitle{
      font-family:'Permanent Marker',cursive;
      color: var(--scoreYellow);
      font-weight: 900;
      font-size: clamp(22px, calc(var(--stageW)*0.06), 56px);
      line-height: 1;
      margin-bottom: clamp(2px, calc(var(--stageH)*0.005), 8px);
      text-shadow: 0 1px 0 #000, 0 0 18px rgba(209,163,65,.35);
      letter-spacing: .5px;
    }
    #bigScore{
      font-family:'Permanent Marker',cursive;
      font-weight:900;
      font-size: clamp(42px, calc(var(--stageW)*0.12), 160px);
      color: var(--scoreYellow);
      text-shadow: 0 2px 0 #000, 0 0 24px rgba(209,163,65,.35);
      letter-spacing: 1px;
      line-height: .9;
    }

    #bestBadge{
      position:absolute; left:50%; transform:translateX(-50%);
      top: calc(
        clamp(8px, calc(var(--stageH)*0.06), 64px)
        + clamp(60px, calc(var(--stageW)*0.16), 200px)
        + var(--bestBadgeShift)
      );
      font-size: clamp(12px, calc(var(--stageW)*0.028), 16px);
      opacity:.85;
      color:#ffd48a;
      text-shadow: 0 1px 0 #000;
    }

    /* On vire les chips score/best du header visuellement */
    header .chip{ display:none; }

    /* === Popup Game Over (empilÃ©e + boutons redimensionnÃ©s) === */
    #gameOver{
      position:fixed; inset:0; display:none; place-items:center;
      background:rgba(0,0,0,0.55); z-index:40; backdrop-filter: blur(2px);
    }
    #gameOver.open{ display:grid; }
    .go-panel{
      background:#1a1716; border:1px solid #3a302d; border-radius:16px;
      padding:22px; width:min(92vw, 420px); text-align:center;
      box-shadow: 0 16px 48px rgba(0,0,0,.45);
    }
    .go-title{
      font-family:'Permanent Marker',cursive; font-size:28px; margin:0 0 8px; color:var(--ink);
      text-shadow:0 1px 0 #000;
    }

    /* Bloc central empilÃ© */
    .go-main{
      display:grid; gap:6px; justify-items:center; margin:6px 0 12px;
    }
    #goScore{
      font-family:'Permanent Marker',cursive;
      font-size: 28px;
      color: var(--scoreYellow);
      text-shadow: 0 1px 0 #000, 0 0 12px rgba(209,163,65,.28);
      line-height:1;
    }
    #goBest{
      font-family:'Permanent Marker',cursive;
      font-size: 20px;
      color:#ffd48a;
      text-shadow: 0 1px 0 #000;
      opacity:.95;
      line-height:1;
    }

    /* Actions */
    .go-actions{ display:flex; gap:10px; justify-content:center; margin-top:8px; flex-wrap:wrap; }

    /* Gros bouton Rejouer */
    .go-replay{
      background:#1e1b1a; border:1px solid #3a302d; color:#e8d6b8; border-radius:14px;
      padding:14px 22px; cursor:pointer; font-weight:900; font-size:20px;
      box-shadow: 0 8px 22px rgba(0,0,0,.4);
    }
    .go-replay:hover{ filter:brightness(1.06); }

    /* Bouton Skins dans Game Over */
    .go-skins{
      background:#1e1b1a; border:1px solid #3a302d; color:#e8d6b8; border-radius:12px;
      padding:10px 14px; font-weight:800; cursor:pointer;
    }

    /* Petit bouton Partager: icÃ´ne seule */
    .go-share{
      display:inline-flex; align-items:center; justify-content:center;
      width:44px; height:44px; border-radius:999px;
      background:#1e1b1a; border:1px solid #3a302d; color:#e8d6b8; cursor:pointer;
      font-size:20px;
    }
    .go-share:hover{ filter:brightness(1.06); }
    .go-share::before{ content:"ðŸ“¤"; }  /* icÃ´ne seule */

    /* === NEW SKIN POPUP === */
    #newSkin{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.55); z-index:50; backdrop-filter: blur(2px); }
    #newSkin.open{ display:grid; }
    .ns-panel{ background:#1a1716; border:1px solid #3a302d; border-radius:16px; padding:22px; width:min(92vw, 460px); text-align:center; box-shadow: 0 16px 48px rgba(0,0,0,.45); }
    .ns-title{ font-family:'Permanent Marker',cursive; font-size:32px; margin:0 0 10px; color:var(--gold); text-shadow:0 1px 0 #000; }
    .ns-thumb{ display:block; margin:8px auto 10px; height:140px; width:auto; image-rendering:pixelated; }
    .ns-name{ font-weight:900; margin:6px 0 14px; }
    .ns-actions{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    .ns-btn{ background:#1e1b1a; border:1px solid #3a302d; color:#e8d6b8; border-radius:12px; padding:10px 16px; font-weight:800; cursor:pointer; }
    .ns-btn:hover{ filter:brightness(1.06); }

    /* === BEST SCORE POPUP + CONFETTIS === */
    #bestPopup{
      position:fixed; inset:0; display:none; place-items:center;
      background:rgba(0,0,0,.55); z-index:60; backdrop-filter: blur(2px);
    }
    #bestPopup.open{ display:grid; }
    #bestPopup .bp-panel{
      position:relative;
      background:#1a1716; border:1px solid #3a302d; border-radius:16px;
      padding:24px 22px; width:min(92vw, 420px); text-align:center;
      box-shadow: 0 16px 48px rgba(0,0,0,.45);
    }
    #bestPopup .bp-title{
      font-family:'Permanent Marker',cursive;
      font-weight:900;
      font-size: clamp(32px, calc(var(--stageW)*0.10), 64px);
      color: var(--scoreYellow);
      text-shadow: 0 2px 0 #000, 0 0 24px rgba(209,163,65,.35);
      letter-spacing: 1px;
      line-height: .9;
      margin: 0 0 10px;
    }
    #bestPopup .bp-sub{ opacity:.9; margin-bottom:12px; }
    #bestPopup .bp-ok{
      background:#1e1b1a;border:1px solid #3a302d;color:#e8d6b8;
      border-radius:12px; padding:12px 18px; font-weight:900; cursor:pointer;
    }
    #confetti{
      position:fixed; inset:0; pointer-events:none; z-index:59;
    }

    /* Noms de skins en blanc */
    .skinCard div { color: #fff; }

    /* === RULES POPUP === */
    #rulesPopup{
      position:fixed; inset:0; display:none; place-items:center;
      background:rgba(0,0,0,.55); z-index:55; backdrop-filter: blur(2px);
    }
    #rulesPopup.open{ display:grid; }
    #rulesPopup .rp-panel{
      background:#1a1716; border:1px solid #3a302d; border-radius:16px;
      padding:22px; width:min(92vw, 520px); text-align:center;
      box-shadow: 0 16px 48px rgba(0,0,0,.45);
    }
    #rulesPopup .rp-title{
      font-weight:900; color:var(--gold); margin:0 0 8px;
      font-family:'Permanent Marker',cursive;
    }
    #rulesPopup .rp-text{
      margin:8px 0 14px; line-height:1.35;
    }
    #rulesPopup .rp-close{
      background:#1e1b1a; border:1px solid #3a302d; color:#e8d6b8;
      border-radius:12px; padding:10px 16px; font-weight:800; cursor:pointer;
    }
    #rulesPopup .rp-close:hover{ filter:brightness(1.06); }
      
  </style>
</head>
<body>
<div id="app">
  <header>
    <div class="left">
      <strong>Wing Chun Simon</strong>
      <!-- chips masquÃ©es par CSS -->
      <span class="chip">Score: <span id="scoreHeader">0</span></span>
      <span class="chip">Meilleur: <span id="bestHeader">0</span></span>
    </div>
    <div class="right"></div>
  </header>

  <!-- Bouton d'accÃ¨s tactile au panneau de rÃ©glages -->
  <button style="position:fixed;top:10px;right:10px;z-index:999;" onclick="toggleDevPanel()">âš™</button>

  <div id="stageWrap">
    <div id="stage">
      <canvas id="cx"></canvas>

      <!-- HUD score gÃ©ant -->
      <div id="hud">
        <div id="scoreBox">
          <div id="scoreTitle">Score</div>
          <div id="bigScore">0</div>
        </div>
        <div id="bestBadge">Meilleur: <span id="best">0</span></div>
      </div>

      <div id="board">
        <button class="pad" data-tech="pak">Pak Sao</button>
        <button class="pad" data-tech="tan">Tan Sao</button>
        <button class="pad" data-tech="bon">Bon Sao</button>
        <button class="pad" data-tech="punch">Punch</button>
      </div>

      <img id="onoImg" alt="OnomatopÃ©e"/>
      <div id="flash"></div>

      <div id="menu">
        <div class="panel">
          <h1 class="title-main">Wing Chun</h1>
          <div class="title-sub">Simon Game</div>
          <p class="subtitle"></p>
          <div class="actions">
            <button id="startBtn" class="btn">Commencer</button>
            <button id="muteBtn"  class="btn">ðŸ”Š Son</button>
            <button id="skinsBtn" class="btn">ðŸŽ¨ Skins</button>
          </div>

          <div id="skinsPanel">
            <div style="margin-bottom:8px;opacity:.85">Choisis un skin de personnage</div>
            <div id="skinsGrid"></div>
          </div>

          <div id="appVersion" class="hint" style="margin-top:10px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- === Popup Game Over (empilÃ©e) === -->
  <div id="gameOver" aria-modal="true" role="dialog">
    <div class="go-panel" role="document">
      <h2 class="go-title">Game Over</h2>
      <div class="go-main">
        <div id="goScore">Score: 0</div>
        <div id="goBest">Meilleur: 0</div>
      </div>
      <div class="go-actions">
        <button id="replayBtn" class="go-replay">Rejouer</button>
        <button id="skinsGoBtn" class="go-skins">Skins</button>
        <button id="shareBtn"  class="go-share" title="Partager"></button>
      </div>
    </div>
  </div>

  <!-- === BEST SCORE POPUP === -->
  <div id="bestPopup" aria-modal="true" role="dialog">
    <div class="bp-panel" role="document">
      <div class="bp-title">Best Score!</div>
      <div class="bp-sub">Nouveau record battu ðŸŽ‰</div>
      <button id="bpOk" class="bp-ok">OK</button>
    </div>
  </div>
  <canvas id="confetti"></canvas>

  <!-- === RULES POPUP (au clic sur Commencer) === -->
  <div id="rulesPopup" aria-modal="true" role="dialog">
    <div class="rp-panel" role="document">
      <h3 class="rp-title">RÃ¨gles</h3>
      <div class="rp-text">
        Une case sâ€™allume. Le joueur doit appuyer dessus. Ã€ chaque tour, la sÃ©quence recommence depuis le dÃ©but et sâ€™allonge dâ€™une nouvelle case.
      </div>
      <button id="rulesCloseBtn" class="rp-close">Fermer</button>
    </div>
  </div>

  <!-- === NEW SKIN unlocked === -->
  <div id="newSkin" aria-modal="true" role="dialog">
    <div class="ns-panel" role="document">
      <h2 class="ns-title">Nouveau Skin !</h2>
      <img id="nsThumb" class="ns-thumb" alt="Skin dÃ©bloquÃ©"/>
      <div id="nsName" class="ns-name"></div>
      <div class="ns-actions">
        <button id="nsViewBtn" class="ns-btn">Voir les Skins</button>
        <button id="nsOkBtn" class="ns-btn">OK</button>
      </div>
    </div>
  </div>

  <footer></footer>
</div>

<div id="devPanel"></div>

<script>
/* ===== Version app ===== */
const APP_VERSION = '2025'; // version unique
const APP_LABEL   = 'v3.151'; /* label + best popup */

/* ===== Cache-buster (stable par version) ===== */
const CB = (new URL(location.href)).searchParams.get('v') || APP_VERSION;
function bust(url){
  try{
    const u = new URL(url, location.href);
    u.searchParams.set('v', CB);
    return u.toString();
  }catch{
    return url + (url.includes('?') ? '&' : '?') + 'v=' + encodeURIComponent(CB);
  }
}

/* Optionnel: nettoyer dâ€™anciens SW */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistrations().then(regs => regs.forEach(r => r.unregister()));
}

/* ===== Ratios ===== */
const PC_RATIO = 4/3;      // paysage
const MB_RATIO = 9/16;     // portrait
function isPortrait(){ return window.innerHeight >= window.innerWidth; }
function activeRatio(){ return isPortrait() ? MB_RATIO : PC_RATIO; }

/* ===== Refs ===== */
const pads=[...document.querySelectorAll('.pad')];
const bigScoreEl=document.getElementById('bigScore');
const bestEl=document.getElementById('best');
const menu=document.getElementById('menu');
const startBtn=document.getElementById('startBtn');
const muteBtn=document.getElementById('muteBtn');
const skinsBtn=document.getElementById('skinsBtn');
const skinsPanel=document.getElementById('skinsPanel');
const skinsGrid=document.getElementById('skinsGrid');
const onoImg=document.getElementById('onoImg');
const flash=document.getElementById('flash');
const devPanel=document.getElementById('devPanel');
const stageWrap=document.getElementById('stageWrap');
const stage=document.getElementById('stage');
const cx=document.getElementById('cx');
const ctx=cx.getContext('2d',{alpha:true}); ctx.imageSmoothingEnabled=false;

/* === Popup refs === */
const gameOverEl = document.getElementById('gameOver');
const goScoreEl  = document.getElementById('goScore');
const goBestEl   = document.getElementById('goBest');
const replayBtn  = document.getElementById('replayBtn');
const shareBtn   = document.getElementById('shareBtn');
const skinsGoBtn = document.getElementById('skinsGoBtn');

const newSkinEl = document.getElementById('newSkin');
const nsThumbEl = document.getElementById('nsThumb');
const nsNameEl  = document.getElementById('nsName');
const nsViewBtn = document.getElementById('nsViewBtn');
const nsOkBtn   = document.getElementById('nsOkBtn');

  // Ferme la popup
nsOkBtn?.addEventListener('click', hideNewSkinPopup);

// Ouvre le panneau Skins et ferme la popup
nsViewBtn?.addEventListener('click', ()=>{
  hideNewSkinPopup();
  openSkinsPanel();
});

/* === Best Score popup refs === */
const bestPopup = document.getElementById('bestPopup');
const bpOk      = document.getElementById('bpOk');
const confettiCv= document.getElementById('confetti');
const confettiCx= confettiCv.getContext('2d');

  /* === Rules popup refs === */
const rulesPopup   = document.getElementById('rulesPopup');
const rulesCloseBtn= document.getElementById('rulesCloseBtn');

function showRules(){
  rulesPopup.classList.add('open');
  setTimeout(()=>rulesCloseBtn?.focus(), 0);
}
function hideRules(){
  rulesPopup.classList.remove('open');
}

// === AJOUT 1 : fermer hors du panneau + touche Echap ===
rulesPopup.addEventListener('click', (e)=>{
  if(e.target === rulesPopup){ hideRules(); startGame(); }
});
window.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape' && rulesPopup.classList.contains('open')){
    hideRules(); startGame();
  }
});

// === Fermeture via bouton Fermer : sÃ©curiser double clic ===
let gameStarting = false;
function safeStartGame(){
  if(gameStarting) return;
  gameStarting = true;
  startGame();
  setTimeout(()=> gameStarting = false, 300);
}
rulesCloseBtn?.addEventListener('click', ()=>{
  hideRules();
  safeStartGame();
});

let currentSkinId = null;


/* On mÃ©morise le best au dÃ©but de chaque partie */
let runPrevBest = 0;

/* ===== Audio (chargement paresseux) ===== */
function A(src){ const a=new Audio(src); a.preload='none'; try{a.src=bust(a.src);}catch{} return a; }
const SFX = {
  pak:   A('assets/sounds/pak.wav'),
  tan:   A('assets/sounds/tan.wav'),
  bon:   A('assets/sounds/bon.wav'),
  punch: A('assets/sounds/punch.wav'),
  wrong: A('assets/sounds/wrong.wav'),

  /* Pack par dÃ©faut */
  voice_pak:   A('assets/sounds/Yah1.wav'),
  voice_tan:   A('assets/sounds/Yah2.wav'),
  voice_bon:   A('assets/sounds/Yah3.wav'),
  voice_punch: A('assets/sounds/Yah4.wav'),

  /* Pack DEMON (espaces encodÃ©s en %20) */
  demon_pak:   A('assets/sounds/Son1 Demon.wav'),
  demon_tan:   A('assets/sounds/Son2 Demon.wav'),
  demon_bon:   A('assets/sounds/Son3 Demon.wav'),
  demon_punch: A('assets/sounds/Son4 Demon.wav'),

  music: new Audio('assets/sounds/Digital Mosaic.mp3')
};
Object.values(SFX).forEach(a=>{
  if (!(a instanceof Audio)) return;
  a.preload = a === SFX.music ? 'auto' : 'none';
  try { a.src = bust(a.src); } catch {}
});
SFX.music.loop = true; SFX.music.volume = 0.5;
try{ SFX.music.load(); }catch{}
SFX.voice_pak.volume=SFX.voice_tan.volume=SFX.voice_bon.volume=SFX.voice_punch.volume=0.8;
SFX.demon_pak.volume=SFX.demon_tan.volume=SFX.demon_bon.volume=SFX.demon_punch.volume=0.8;

/* Pool audio crÃ©Ã© Ã  la demande */
const POOL={}; let audioReady=false;
function ensureAudioPool(){
  if(audioReady) return;
  const keys=Object.keys(SFX);
  keys.forEach(k=>{
    const a=SFX[k]; if(!(a instanceof Audio)) return;
    const v=a.volume ?? 1;
    const clones=Array.from({length:3},()=>{const c=a.cloneNode(); c.volume=v; try{c.src=bust(a.src);}catch{} return c});
    POOL[k]=[a,...clones];
  });
  audioReady=true;
}
function playKey(key){
  if(muted) return;
  ensureAudioPool();
  const arr=POOL[key]; if(!arr) return;
  let s=arr.find(x=>x.paused);
  if(!s){ const t=arr[0]; s=t.cloneNode(); try{s.src=bust(t.src);}catch{} s.volume=t.volume; if(arr.length<6) arr.push(s); }
  try{ s.currentTime=0; s.play().catch(()=>{}); }catch{}
}
let muted=false;
muteBtn.onclick=()=>{
  muted=!muted;
  muteBtn.textContent=muted?'ðŸ”‡ Muet':'ðŸ”Š Son';
  if(muted) SFX.music.pause(); else SFX.music.play().catch(()=>{});
};

/* === Packs voix par skin === */
const VOICE_PACK_ID = { classic:'default', demon:'demon' };
const VOICE_PACKS = {
  default: { pak:'voice_pak', tan:'voice_tan', bon:'voice_bon', punch:'voice_punch' },
  demon:   { pak:'demon_pak', tan:'demon_tan', bon:'demon_bon', punch:'demon_punch' }
};
let currentVoicePack = VOICE_PACKS.default;

/* IMPORTANT: sons du mannequin conservÃ©s (technique + voix) */
function playTechniqueSounds(tech){ playKey(tech); }
function playVoiceFor(tech){
  const key = (currentVoicePack[tech] || VOICE_PACKS.default[tech]);
  if(key) playKey(key);
}

/* === Autoplay musique sur premier geste === */
let musicPrimed = false;
function primeMusicOnce(){
  if(musicPrimed) return;
  musicPrimed = true;
  ensureAudioPool();
  SFX.music.play().catch(()=>{});
  ['pointerdown','mousedown','touchstart','keydown'].forEach(ev=>{
    window.removeEventListener(ev, primeMusicOnce, true);
  });
}
['pointerdown','mousedown','touchstart','keydown'].forEach(ev=>{
  window.addEventListener(ev, primeMusicOnce, true);
});

/* ===== BG assets (lazy + prioritÃ©) ===== */
function mkImg(url, priority='auto'){
  const img=new Image();
  img.crossOrigin='anonymous';
  img.decoding='async';
  img.fetchPriority=priority;
  img.src=bust(url);
  return img;
}
const SKY    = mkImg('https://i.imgur.com/QW70yEx.png','high'); // => ...?v=20250817
const MT_FAR = mkImg('https://i.imgur.com/I4gOsXm.png','high'); // => ...?v=20250817
let MT_NEAR=null, ALLEY=null;
const rICB = window.requestIdleCallback || (cb=>setTimeout(cb,1));
rICB(()=>{ MT_NEAR = mkImg('https://i.imgur.com/bQDYgSH.png','low'); ALLEY = mkImg('https://i.imgur.com/hVGwPdp.png','low'); });

/* ===== Sprites & skins (lazy) ===== */
function load(url, priority='auto'){ const img=new Image(); img.crossOrigin='anonymous'; img.decoding='async'; img.fetchPriority=priority; img.src=bust(url); return img; }
const SKINS = [
  { id:'classic', name:'Classique', thumb:'https://i.imgur.com/AweXMem.png',
    f:{ pak:'https://i.imgur.com/AweXMem.png', tan:'https://i.imgur.com/ZrLk97U.png', bon:'https://i.imgur.com/CG30Yh6.png', punch:'https://i.imgur.com/JYL2S46.png' } },
  /* === DEMON verrouillÃ© de base === */
  { id:'demon', name:'Demon', thumb:'https://i.imgur.com/b60LiYf.png', locked:true,
    f:{ bon:'https://i.imgur.com/Eg1mCJq.png', tan:'https://i.imgur.com/wNewS04.png', punch:'https://i.imgur.com/lpJkx50.png', pak:'https://i.imgur.com/FvJK22b.png' } }
];
const IMG={ f_pak:null, f_tan:null, f_bon:null, f_punch:null, o_pak:null, o_tan:null, o_bon:null, o_punch:null, d_unique:null };

/* Unlock logic */
const DEMON_UNLOCK_SCORE = 15;
const MONKING_UNLOCK_SCORE = 10; 
function isUnlocked(skin){ if(!skin.locked) return true; return localStorage.getItem('skin_unlocked_'+skin.id) === '1'; }
function isUnlockedSkinId(id){ const s=SKINS.find(x=>x.id===id); return s ? isUnlocked(s) : false; }
function unlockSkin(id){ localStorage.setItem('skin_unlocked_'+id, '1'); }
function lockSkin(id){ localStorage.removeItem('skin_unlocked_'+id); }

let activeSkinIdx = +localStorage.getItem('wcs_skin_idx') || 0;
function applySkin(idx){
  const s=SKINS[idx]||SKINS[0];
  if(s.locked && !isUnlocked(s)){ renderSkins(); return; }
  activeSkinIdx=idx;
  currentSkinId = s.id; // <â€” mÃ©morise l'id du skin actif
  IMG.f_pak   = load(s.f.pak,'high');
  rICB(()=>{ IMG.f_tan=load(s.f.tan,'low'); IMG.f_bon=load(s.f.bon,'low'); IMG.f_punch=load(s.f.punch,'low'); });
  localStorage.setItem('wcs_skin_idx', idx);
  currentFighter = IMG['f_'+currentTech] || IMG.f_pak;

  // pack voix du skin
  const packId = VOICE_PACK_ID[s.id] || 'default';
  currentVoicePack = VOICE_PACKS[packId] || VOICE_PACKS.default;
}
rICB(()=>{
  IMG.d_unique = load('https://i.imgur.com/LwBpPL3.png','low');
  IMG.o_pak    = load('https://i.imgur.com/pVF4bt1.png','low');
  IMG.o_tan    = load('https://i.imgur.com/2Tmv5aC.png','low');
  IMG.o_bon    = load('https://i.imgur.com/TNvTSXc.png','low');
  IMG.o_punch  = load('https://i.imgur.com/p0nSWkS.png','low');
});

/* ===== Profils & stockage (v8) ===== */
const STORAGE_KEY = 'wcs_tune_v8';
const TUNE_VERSION = 8;

const SEEDED_PROFILES = {
  pc: {
    ratio: 1.3333333333333333,
    layers: {
      sky:  { zoom: 0.5,  offsetXPct: -0.031, yOffsetPct: -0.277, speedX: 0 },
      far:  { wPct: 1,    offsetXPct: -1.372, bottomPct: -0.019,  speedX: 0.004 },
      near: { wPct: 2.99, offsetXPct: 0.528,  bottomPct: 0.225,   speedX: 0.025 },
      alley:{ wPct: 1.2,  offsetXPct: 0,      bottomPct: 0,       speedX: 0 }
    },
    fighter: { wPct: 0.165, centerX: 0.51, bottomPct: 0.09 },
    dummy:   { wPct: 0.186, centerX: 0.5,  bottomPct: 0.083 },
    onoByTech: {
      pak:   { xPct: 0.598, yPct: 0.467, hPct: 0.404, rotDeg:  39 },
      tan:   { xPct: 0.417, yPct: 0.503, hPct: 0.310, rotDeg: -15 },
      bon:   { xPct: 0.593, yPct: 0.497, hPct: 0.382, rotDeg:  19 },
      punch: { xPct: 0.427, yPct: 0.513, hPct: 0.370, rotDeg: -37 }
    },
    // === NOUVEAU : rÃ©glages par skin (PC) ===
    skins: {
      classic: { wPct: 0.165, centerX: 0.51,  bottomPct: 0.09  },
      demon:   { wPct: 0.185, centerX: 0.515, bottomPct: 0.085 }
    }
  },
  mobile: {
    ratio: 0.5625,
    layers: {
      sky:  { zoom: 0.34, offsetXPct: 0.225,  yOffsetPct: -0.35, speedX: 0 },
      far:  { wPct: 1.38, offsetXPct: 0.025,  bottomPct: 0.319,  speedX: 0.011 },
      near: { wPct: 8,    offsetXPct: -1.462, bottomPct: 0.319,  speedX: 0.035 },
      alley:{ wPct: 4,    offsetXPct: 0,      bottomPct: 0,      speedX: 0 }
    },
    fighter: { wPct: 0.437, centerX: 0.51, bottomPct: 0.124 },
    dummy:   { wPct: 0.489, centerX: 0.5,  bottomPct: 0.119 },
    onoByTech: {
      pak:   { xPct: 0.719, yPct: 0.442, hPct: 0.310, rotDeg:  37 },
      tan:   { xPct: 0.332, yPct: 0.422, hPct: 0.310, rotDeg: -26 },
      bon:   { xPct: 0.724, yPct: 0.417, hPct: 0.310, rotDeg:  23 },
      punch: { xPct: 0.332, yPct: 0.397, hPct: 0.310, rotDeg: -44 }
    },
    // === NOUVEAU : rÃ©glages par skin (Mobile) ===
    skins: {
      classic: { wPct: 0.437, centerX: 0.51,  bottomPct: 0.124 },
      demon:   { wPct: 0.465, centerX: 0.515, bottomPct: 0.120 }
    }
  }
};

function deepClone(o){return JSON.parse(JSON.stringify(o));}

let CFG;
(function loadConfig(){
  try{
    const stored=JSON.parse(localStorage.getItem(STORAGE_KEY)||'null');
    if(stored && stored.version===TUNE_VERSION){ CFG=stored; return; }
  }catch{}
  let v7=null;
  try{ v7 = JSON.parse(localStorage.getItem('wcs_tune_v7')||'null'); }catch{}
  if(v7 && v7.profiles){
    CFG = {
      version:TUNE_VERSION, editingProfile:v7.editingProfile||'pc', previewLock:true,
      fighterDxPxByTech:v7.fighterDxPxByTech||{pak:-110,tan:110,bon:-110,punch:110},
      profiles:{
        pc: migrate7to8(v7.profiles.pc) || deepClone(SEEDED_PROFILES.pc),
        mobile: migrate7to8(v7.profiles.mobile||v7.profiles.pc) || deepClone(SEEDED_PROFILES.mobile),
      }
    };
 } else {
  const firstIsPortrait = window.innerHeight >= window.innerWidth;
  CFG = {
    version: TUNE_VERSION,
    previewLock: false,
    editingProfile: firstIsPortrait ? 'mobile' : 'pc',
    profiles: {
      pc: deepClone(SEEDED_PROFILES.pc),
      mobile: deepClone(SEEDED_PROFILES.mobile)
    },
    fighterDxPxByTech:{pak:-110,tan:110,bon:-110,punch:110}
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(CFG));
}
  if (CFG && typeof CFG.previewLock !== 'boolean') CFG.previewLock = false;
})();

function migrate7to8(p){
  if(!p) return null;
  const out = deepClone(SEEDED_PROFILES.pc);
  out.ratio = p.ratio||PC_RATIO;
  const skyIn = (p.layers&&p.layers.sky)||{};
  out.layers.sky.zoom = (typeof skyIn.zoom==='number')?skyIn.zoom : (typeof skyIn.scaleX==='number'?Math.max(0.2,skyIn.scaleX):1);
  out.layers.sky.offsetXPct = skyIn.offsetXPct||0;
  out.layers.sky.yOffsetPct = skyIn.yOffsetPct||0;
  out.layers.sky.speedX = skyIn.speedX||0;
  ['far','near','alley'].forEach(k=>{
    const s=(p.layers&&p.layers[k])||{};
    out.layers[k].wPct = (typeof s.scaleX==='number') ? Math.max(0.5, s.scaleX) : (s.wPct ?? out.layers[k].wPct);
    out.layers[k].offsetXPct = s.offsetXPct||0;
    out.layers[k].bottomPct  = s.bottomPct ?? out.layers[k].bottomPct;
    out.layers[k].speedX     = s.speedX||0;
  });
  out.fighter = p.fighter || out.fighter;
  out.dummy   = p.dummy   || out.dummy;
  out.onoByTech = (p.onoByTech) ? p.onoByTech
                 : (p.ono ? {pak:p.ono,tan:p.ono,bon:p.ono,punch:p.ono} : deepClone(SEEDED_PROFILES.pc.onoByTech));
  // Assure une structure skins si absente, basÃ©e sur fighter
if(!out.skins){
  out.skins = {};
  ['classic','demon'].forEach(id=>{
    out.skins[id] = { ...out.fighter };
  });
}
  return out;
}
function saveCFG(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(CFG)); }

/* Profil affichÃ© vs runtime */
const runtimeProfileName = ()=> (innerHeight>innerWidth ? 'mobile' : 'pc');
const viewingProfileName = ()=> (CFG.previewLock ? CFG.editingProfile : runtimeProfileName());
const P = ()=> CFG.profiles[viewingProfileName()];

/* ===== Canvas / Resize ===== */
let DPR=1, W=0, H=0;
let last = performance.now();

function resize(){
  const r = activeRatio();
  const wrapW=stageWrap.clientWidth, wrapH=stageWrap.clientHeight;
  let boxW=wrapW, boxH=Math.round(wrapW / r);
  if(boxH>wrapH){ boxH=wrapH; boxW=Math.round(wrapH * r); }

  /* RÃ©duction de charge en mobile portrait: DPR = 1 */
  const sysDPR = window.devicePixelRatio||1;
  DPR = isPortrait() ? 1 : Math.max(1, Math.min(2, sysDPR));

  cx.width = Math.round(boxW * DPR);
  cx.height= Math.round(boxH * DPR);
  cx.style.width=boxW+'px'; cx.style.height=boxH+'px';
  stage.style.width=boxW+'px'; stage.style.height=boxH+'px';

  ctx.setTransform(DPR,0,0,DPR,0,0);
  W=boxW; H=boxH;

  document.documentElement.style.setProperty('--stageW', W + 'px');
  document.documentElement.style.setProperty('--stageH', H + 'px');
  document.body.classList.toggle('isPortrait', isPortrait());

  fitConfetti();

  if(onoSticky) showOnoSticky();
}
addEventListener('resize', resize);
addEventListener('orientationchange', resize);

/* ===== DÃ©cor ===== */
function drawSkyCover(){
  const img=SKY, L=P().layers.sky;
  if(img && img.complete && img.naturalWidth){
    const iw=img.naturalWidth, ih=img.naturalHeight;
    const s = Math.max(W/iw, H/ih) * (L.zoom||1);
    const dw = iw*s, dh = ih*s;
    const dx = (W-dw)/2 + (L.offsetXPct||0)*W;
    const dy = (H-dh)/2 + (L.yOffsetPct||0)*H;
    ctx.drawImage(img, dx, dy, dw, dh);
  } else {
    const g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#0a0c12'); g.addColorStop(1,'#1a1f2a');
    ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  }
}
function tileScaledBottom(img, startOffsetXPct, wPct, bottomPct){
  if(!img || !img.complete || !img.naturalWidth) return;
  const targetW = Math.max(1, W * (wPct||1));
  const scale = targetW / img.naturalWidth;
  const targetH = img.naturalHeight * scale;
  const y = Math.round(H - targetH - (H*(bottomPct||0)));
  let x=((startOffsetXPct*W) % targetW); if(x>0) x-=targetW;
  for(; x<W; x+=targetW) ctx.drawImage(img, x, y, targetW, targetH);
}

/* Parallaxe */
let offSky=0, offFar=0, offNear=0, offAlley=0;
function drawBG(dt){
  const L=P().layers;
  const f = (dt/60)*W;
  offSky  -= (L.sky.speedX  ||0) * f;
  offFar  -= (L.far.speedX  ||0) * f;
  offNear -= (L.near.speedX ||0) * f;
  offAlley-= (L.alley.speedX||0) * f;

  drawSkyCover();
  tileScaledBottom(MT_FAR,  (L.far.offsetXPct||0)  + (offFar/W),  L.far.wPct,  L.far.bottomPct);
  ctx.fillStyle='rgba(0,0,0,.10)'; ctx.fillRect(0,0,W,H);
  if (MT_NEAR) tileScaledBottom(MT_NEAR, (L.near.offsetXPct||0) + (offNear/W), L.near.wPct, L.near.bottomPct);
  if (ALLEY)   tileScaledBottom(ALLEY,   (L.alley.offsetXPct||0)+ (offAlley/W),L.alley.wPct,L.alley.bottomPct);
}

/* ===== Mannequin & Perso ===== */
let dummyAnim={until:0};
function triggerDummyAnim(){ dummyAnim.until=performance.now()+200; }
function drawDummy(){
  const img=IMG.d_unique, D=P().dummy; if(!img || !img.complete || !img.naturalWidth) return;
  let scale=1; if(performance.now()<dummyAnim.until){ const t=1-((dummyAnim.until-performance.now())/200); scale=1+0.05*Math.sin(t*Math.PI); }
  const targetW=Math.max(60, D.wPct*W)*scale;
  const s=targetW/img.naturalWidth, targetH=img.naturalHeight*s;
  const xLeft=Math.round(W*D.centerX - targetW/2);
  const yTop =Math.round(H - targetH - H*(D.bottomPct||0));
  ctx.drawImage(img, xLeft, yTop, targetW, targetH);
}

let currentTech='pak', currentFighter=null;
let actionAnim={until:0,lunge:0,scale:1};
function setSpritesFor(tech){
  currentTech=tech; triggerDummyAnim();
  const now=performance.now();
  const LUNGE={pak:10,tan:12,bon:8,punch:14}; const SCALE={pak:1.03,tan:1.035,bon:1.03,punch:1.04};
  actionAnim={until: now+260, lunge:(LUNGE[tech]||10), scale:(SCALE[tech]||1.03)};
  const img = IMG['f_'+tech]; if(img) currentFighter = img;

  /* voix (Yah) depuis setSpritesFor, comme avant */
  setTimeout(()=> playVoiceFor(tech), 100);
}
function drawFighter(){
  const img=currentFighter, F=activeSkinCfg(); if(!img || !img.complete || !img.naturalWidth) return;
  const baseW=Math.max(60, F.wPct*W);
  const finalW=baseW*((performance.now()<actionAnim.until)?actionAnim.scale:1);
  const finalH=img.naturalHeight*(finalW/img.naturalWidth);

  const rawDx = (CFG.fighterDxPxByTech && CFG.fighterDxPxByTech[currentTech]) || 0;
  const isMobileView = (viewingProfileName && viewingProfileName() === 'mobile');
  const dxTech = isMobileView ? rawDx * (W / 800) : rawDx;

  const now=performance.now(), idleBob=(now>actionAnim.until)?Math.sin(now/420)*3:0;
  const t=1-Math.max(0,(actionAnim.until-now)/260); const ease=(now<actionAnim.until)?(1-Math.pow(1-t,3)):0;
  const extraX=(actionAnim.lunge||0)*ease, extraY=-2*ease;
  const centerX=W*(F.centerX||0.5);
  const xBase=Math.round(centerX - finalW/2 + dxTech + extraX);
  const yBase=Math.round(H - finalH - H*(F.bottomPct||0) + idleBob + extraY);
  ctx.drawImage(img, xBase, yBase, finalW, finalH);
}

/* ===== OnomatopÃ©es ===== */
function getOnoFor(tech){
  const prof = P(); const map = prof.onoByTech || {};
  return map[tech] || {xPct:0.5,yPct:0.3,hPct:0.31,rotDeg:0};
}
function applyOnoStyleFor(tech){
  const O=getOnoFor(tech);
  onoImg.style.left = (O.xPct*100).toFixed(3)+'%';
  onoImg.style.top  = (O.yPct*100).toFixed(3)+'%';
  onoImg.style.height = Math.max(10, O.hPct*H)+'px';
  onoImg.style.transform = `translate(-50%,-50%) rotate(${O.rotDeg||0}deg)`;
}
function showOno(tech){
  const img=IMG['o_'+tech]; if(!img) return;
  onoImg.src=img.src;
  applyOnoStyleFor(tech);
  onoImg.classList.remove('onoShow'); void onoImg.offsetWidth; onoImg.classList.add('onoShow');
}

/* AperÃ§u collant */
let onoSticky = false;
let onoEditTech = 'pak';
function showOnoSticky(){
  const img = IMG['o_'+onoEditTech]; if(!img) return;
  onoImg.src = img.src;
  applyOnoStyleFor(onoEditTech);
  onoImg.classList.remove('onoShow');
  onoImg.style.opacity = '1';
}
function hideOnoSticky(){ onoImg.style.opacity = '0'; onoImg.classList.remove('onoShow'); }

/* ===== Confettis (Best Score) ===== */
function fitConfetti(){
  confettiCv.width  = window.innerWidth;
  confettiCv.height = window.innerHeight;
}
window.addEventListener('resize', fitConfetti, {passive:true});
fitConfetti();

function launchConfetti(durationMs = 2500){
  const W = confettiCv.width, H = confettiCv.height;
  const N = Math.min(220, Math.floor((W*H)/18000));
  const g = 0.12;
  const pieces = Array.from({length:N}, ()=>({
    x: Math.random()*W,
    y: -20 - Math.random()*H*0.4,
    vx: (Math.random()*2-1)*1.2,
    vy: Math.random()*-1.5,
    w: 6+Math.random()*6,
    h: 8+Math.random()*8,
    rot: Math.random()*Math.PI*2,
    vr: (Math.random()*2-1)*0.15,
    c: `hsl(${Math.random()*360},90%,60%)`,
  }));

  let alive = true;
  const tEnd = performance.now() + durationMs;
  (function tick(){
    if(!alive) return;
    const t = performance.now();
    confettiCx.clearRect(0,0,W,H);
    for(const p of pieces){
      p.vy += g;
      p.x  += p.vx;
      p.y  += p.vy;
      p.rot+= p.vr;
      if(p.y > H + 24){ p.y = -24; p.x = Math.random()*W; p.vy = Math.random()*-2; }
      confettiCx.save();
      confettiCx.translate(p.x, p.y);
      confettiCx.rotate(p.rot);
      confettiCx.fillStyle = p.c;
      confettiCx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      confettiCx.restore();
    }
    if (t < tEnd) requestAnimationFrame(tick);
  })();
}

/* ===== Simon ===== */
let seq=[], userIndex=0, locked=true, score=0;
let best=+localStorage.getItem('wcs_best')||0; bestEl.textContent=best;
const TECHS=['pak','tan','bon','punch'];
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
const randTech=()=>TECHS[Math.random()*TECHS.length|0];
function setLit(tech,on){ const b=pads.find(x=>x.dataset.tech===tech); if(!b) return; b.classList.toggle('lit',on); }

async function playSequence(){
  locked=true; await sleep(420);
  for(const tech of seq){
    setSpritesFor(tech); setLit(tech,true); playTechniqueSounds(tech); showOno(tech);
    await sleep(360); setLit(tech,false); await sleep(120);
  }
  locked=false; userIndex=0;
}

/* === Popups helpers === */
function showGameOver(finalScore){
  goScoreEl.textContent = 'Score: ' + String(finalScore);
  goBestEl.textContent  = 'Meilleur: ' + String(best);
  gameOverEl.classList.add('open');
  setTimeout(()=>{ replayBtn?.focus(); }, 0);
}
function hideGameOver(){
  gameOverEl.classList.remove('open');
}
function showNewSkinPopup(skin){
  nsThumbEl.src = bust(skin.thumb);
  nsNameEl.textContent = skin.name;
  newSkinEl.classList.add('open');
  setTimeout(()=>{ nsViewBtn?.focus(); }, 0);
}
function hideNewSkinPopup(){ newSkinEl.classList.remove('open'); }

function showBestPopup(){
  bestPopup.classList.add('open');
  launchConfetti(3000);
  setTimeout(()=>bpOk?.focus(), 0);
}
function hideBestPopup(){
  bestPopup.classList.remove('open');
}
bpOk?.addEventListener('click', hideBestPopup);

let demonPopupShownThisRun = false;
let monkingPopupShownThisRun = false;

async function press(tech){
  if(locked) return;
  setSpritesFor(tech); setLit(tech,true); playTechniqueSounds(tech); showOno(tech);
  await sleep(180); setLit(tech,false);
  if(tech!==seq[userIndex]){
    playKey('wrong'); flash.classList.remove('boom'); void flash.offsetWidth; flash.classList.add('boom');
    locked = true;

    /* Fin de partie */
    showGameOver(score);

    /* Popup Best Score si score final > best du dÃ©but de la run */
    if (score > runPrevBest){
      if(score > best){ 
        best = score; 
        bestEl.textContent = best; 
        localStorage.setItem('wcs_best',best);
      }
      showBestPopup();
    }
    return;
  }
  userIndex++;
  if(userIndex===seq.length){
    score++; updateScoreUI();
    if(score>best){ best=score; bestEl.textContent=best; localStorage.setItem('wcs_best',best); }

    // === DÃ©blocage MONKING Ã  10 ===
    if(!isUnlockedSkinId('monking') && score >= MONKING_UNLOCK_SCORE){
      unlockSkin('monking');
      const monkingSkin = SKINS.find(s=>s.id==='monking');
      if(monkingSkin && !monkingPopupShownThisRun){
        monkingPopupShownThisRun = true;
        showNewSkinPopup(monkingSkin);
      }
    }

    /* === DÃ©blocage DEMON Ã  15 === */
    if(!isUnlockedSkinId('demon') && score>=DEMON_UNLOCK_SCORE){
      unlockSkin('demon');
      const demonSkin = SKINS.find(s=>s.id==='demon');
      if(demonSkin && !demonPopupShownThisRun){
        demonPopupShownThisRun = true;
        showNewSkinPopup(demonSkin);
      }
    }

    seq.push(randTech()); await sleep(360); playSequence();
  }
}
function updateScoreUI(){ bigScoreEl.textContent = String(score); }

/* ===== EntrÃ©es ===== */
pads.forEach(b=>{
  b.addEventListener('pointerdown',e=>{ e.preventDefault(); press(b.dataset.tech); }, {passive:false});
});

/* === Rejouer & Partager & Skins === */
replayBtn.addEventListener('click', ()=>{
  hideGameOver();
  startGame();
});
skinsGoBtn.addEventListener('click', ()=>{
  hideGameOver();
  openSkinsPanel();
});
async function shareBest(){
  const url = location.href.split('#')[0];
  const text = `Mon meilleur score sur Wing Chun Simon: ${best}`;
  const shareData = { title:'Wing Chun Simon', text, url };
  if(navigator.share){
    try{ await navigator.share(shareData); }catch{}
  } else {
    try{
      await navigator.clipboard.writeText(`${text} â€” ${url}`);
      shareBtn.style.transform = 'scale(1.05)';
      shareBtn.textContent = 'âœ…';
      setTimeout(()=>{ shareBtn.textContent = ''; shareBtn.style.transform=''; }, 900);
    }catch{}
  }
}
shareBtn.addEventListener('click', shareBest);

function startGame(){
  hideGameOver();
  hideNewSkinPopup();
  hideBestPopup();
  menu.style.display='none';
  ensureAudioPool();
  if(!muted){
    SFX.music.play().catch(()=>{});
  }
  /* mÃ©morise le best au dÃ©but de la partie pour la popup record */
  runPrevBest = +localStorage.getItem('wcs_best') || best || 0;

  seq=[randTech()]; score=0; demonPopupShownThisRun=false; monkingPopupShownThisRun=false; updateScoreUI(); playSequence();
}
const handleStartClick = (e)=>{ e.preventDefault(); showRules(); };
startBtn.addEventListener('pointerdown', handleStartClick, {passive:false});
startBtn.addEventListener('click', handleStartClick);

/* ===== Skins ===== */
applySkin(activeSkinIdx);
skinsBtn.onclick=()=>{ const show=skinsPanel.style.display!=='block'; skinsPanel.style.display=show?'block':'none'; if(show) renderSkins(); };
function openSkinsPanel(){
  menu.style.display='grid';
  skinsPanel.style.display='block';
  renderSkins();
}
function renderSkins(){
  skinsGrid.innerHTML='';
  SKINS.forEach((s,i)=>{
    const locked = s.locked && !isUnlocked(s);
    const card=document.createElement('button');
    card.className='skinCard'+(i===activeSkinIdx?' skinActive':'')+(locked?' skinLocked':'');
    card.title = locked ? 'DÃ©bloque ce skin pour lâ€™utiliser' : ('Choisir: '+s.name);
    const thumbSrc = locked ? s.thumb : (s.f?.pak || s.thumb);
    card.innerHTML = `
      <img class="skinThumb" alt="${s.name}" src="${bust(thumbSrc)}"/>
      <div style="font-weight:700">${s.name}</div>
    `;
    card.onclick=()=>{ if(locked) return; applySkin(i); renderSkins(); buildDevPanel(); };
    skinsGrid.appendChild(card);
  });
}

/* ===== Boucle ===== */
function loop(t = performance.now()){
  const dt = Math.min(33, t - last) / (1000/60);
  last = t;
  ctx.clearRect(0,0,W,H);
  drawBG(dt); drawDummy(); drawFighter();
  requestAnimationFrame(loop);
}

/* ===== Panneau (T) ===== */
function addRange(parent,label,obj,key,{min,max,step=0.01,after}){
  const row=document.createElement('div'); row.className='row';
  const lab=document.createElement('div'); lab.textContent=label; row.appendChild(lab);
  const r=document.createElement('input'); r.type='range'; r.min=min; r.max=max; r.step=step; r.value=obj[key];
  const n=document.createElement('input'); n.type='number'; n.step=step; n.value=obj[key]; n.min=min; n.max=max;
  function sync(v){ v=+v; obj[key]=v; r.value=v; n.value=v; saveCFG(); if(after) after(); }
  r.oninput=e=>sync(e.target.value); n.oninput=e=>sync(e.target.value);
  row.append(r,n); parent.appendChild(row);
}
function section(t){ const h=document.createElement('h3'); h.textContent=t; devPanel.appendChild(h); }
function sep(){ const d=document.createElement('div'); d.className='sep'; devPanel.appendChild(d); }
function header(){ const h=document.createElement('h2'); h.textContent='RÃ©glages (T pour fermer)'; devPanel.appendChild(h); }
function bar(){
  const wrap=document.createElement('div'); wrap.className='bar';
  const reset=document.createElement('button'); reset.textContent='RÃ©initialiser';
  const copy=document.createElement('button');  copy.textContent='Copier JSON';
  const paste=document.createElement('button'); paste.textContent='Coller JSON';
  const testOno=document.createElement('button'); testOno.textContent='Tester onomatopÃ©e';
  const seg=document.createElement('div'); seg.className='seg';
  const pcBtn=document.createElement('button'); const mbBtn=document.createElement('button'); const lock=document.createElement('button');
  pcBtn.textContent='Ã‰diter: PC (4:3)'; mbBtn.textContent='Ã‰diter: Mobile (9:16)';
  lock.textContent = (CFG.previewLock?'AperÃ§u = Profil Ã©ditÃ©':'AperÃ§u auto');
  function mark(){ pcBtn.classList.toggle('active', CFG.editingProfile==='pc'); mbBtn.classList.toggle('active', CFG.editingProfile==='mobile'); }
  pcBtn.onclick=()=>{ CFG.editingProfile='pc'; saveCFG(); mark(); lock.textContent=(CFG.previewLock?'AperÃ§u = Profil Ã©ditÃ©':'AperÃ§u auto'); buildDevPanel(); resize(); };
  mbBtn.onclick=()=>{ CFG.editingProfile='mobile'; saveCFG(); mark(); lock.textContent=(CFG.previewLock?'AperÃ§u = Profil Ã©ditÃ©':'AperÃ§u auto'); buildDevPanel(); resize(); };
  lock.onclick=()=>{ CFG.previewLock=!CFG.previewLock; saveCFG(); lock.textContent=(CFG.previewLock?'AperÃ§u = Profil Ã©ditÃ©':'AperÃ§u auto'); resize(); };
  mark(); seg.append(pcBtn,mbBtn);

  reset.onclick=()=>{ CFG.profiles.pc=deepClone(SEEDED_PROFILES.pc); CFG.profiles.mobile=deepClone(SEEDED_PROFILES.mobile); saveCFG(); buildDevPanel(); resize(); };
  copy.onclick =()=>{ navigator.clipboard.writeText(JSON.stringify(CFG,null,2)).catch(()=>{}); };
  paste.onclick=()=>{ const raw=prompt('Colle la config JSON:'); if(!raw) return; try{ const o=JSON.parse(raw); Object.assign(CFG,o); saveCFG(); buildDevPanel(); resize(); }catch{ alert('JSON invalide'); } };
  testOno.onclick=()=>{ showOno(currentTech); };

  wrap.append(reset,copy,paste,testOno,seg,lock); devPanel.appendChild(wrap);

  const hint=document.createElement('div'); hint.className='hint';
  const activeView = viewingProfileName()==='pc'?'PC (4:3)':'Mobile (9:16)';
  const activeRuntime = runtimeProfileName()==='pc'?'PC (4:3)':'Mobile (9:16)';
  hint.textContent='Profil en jeu (auto): '+activeRuntime+' â€¢ Profil affichÃ©: '+activeView;
  devPanel.appendChild(hint);
}
// === Gestion des skins dans les profils ===
function ensureSkinConfigObject(E){
  if(!E.skins) E.skins = {};
  SKINS.forEach(s=>{
    if(!E.skins[s.id]){
      E.skins[s.id] = { ...E.fighter }; // clone fighter comme base
    }
  });
}

function activeSkinCfg(){
  const E = CFG.profiles[viewingProfileName()];
  ensureSkinConfigObject(E);
  return (currentSkinId && E.skins[currentSkinId])
    ? E.skins[currentSkinId]
    : E.fighter;
}
  
function buildDevPanel(){
   devPanel.innerHTML=''; header(); bar(); sep();
    const E = CFG.profiles[CFG.editingProfile];
    const isMobileProfile = (CFG.editingProfile === 'mobile');
    const SCALE_RANGE = {
    sky:  { min: isMobileProfile ? 0.02 : 0.50, max: isMobileProfile ? 10.0 : 3.0 },
    far:  { min: isMobileProfile ? 0.05 : 0.50, max: isMobileProfile ?  8.0 : 3.0 },
    near: { min: isMobileProfile ? 0.05 : 0.50, max: isMobileProfile ?  8.0 : 3.0 },
    alley:{ min: isMobileProfile ? 0.20 : 0.50, max: isMobileProfile ?  4.0 : 3.0 }
  };

  section('Ciel');
  addRange(devPanel,'Zoom',E.layers.sky,'zoom',{min:SCALE_RANGE.sky.min,max:SCALE_RANGE.sky.max,step:0.01});
  addRange(devPanel,'DÃ©calage X %',E.layers.sky,'offsetXPct',{min:-3,max:3,step:0.001});
  addRange(devPanel,'DÃ©calage Y %',E.layers.sky,'yOffsetPct',{min:-1,max:1,step:0.001});
  addRange(devPanel,'Vitesse X (Ã©cran/s)',E.layers.sky,'speedX',{min:-3,max:3,step:0.01});
  sep();

  function R(label,key){
    section(label);
    addRange(devPanel,'Largeur Ã— Ã©cran (wPct)',E.layers[key],'wPct',{min:SCALE_RANGE[key].min,max:SCALE_RANGE[key].max,step:0.01});
    addRange(devPanel,'DÃ©calage X %',E.layers[key],'offsetXPct',{min:-3,max:3,step:0.001});
    addRange(devPanel,'Bas %',E.layers[key],'bottomPct',{min:-0.2,max:0.8,step:0.001});
    addRange(devPanel,'Vitesse X (Ã©cran/s)',E.layers[key],'speedX',{min:-3,max:3,step:0.01});
    sep();
  }
  R('Montagnes lointaines','far');
  R('Montagnes proches','near');
  R('AllÃ©e','alley');

  section('Mannequin');
  addRange(devPanel,'Largeur % Ã©cran',E.dummy,'wPct',{min:0.05,max:0.6,step:0.001});
  addRange(devPanel,'Centre X %',E.dummy,'centerX',{min:0,max:1,step:0.001});
  addRange(devPanel,'Bas %',E.dummy,'bottomPct',{min:-0.1,max:0.4,step:0.001});
  sep();

  section('Personnage');
  addRange(devPanel,'Largeur % Ã©cran',E.fighter,'wPct',{min:0.05,max:0.6,step:0.001});
  addRange(devPanel,'Centre X %',E.fighter,'centerX',{min:0,max:1,step:0.001});
  addRange(devPanel,'Bas %',E.fighter,'bottomPct',{min:-0.1,max:0.4,step:0.001});
  sep();

  // === RÃ©glages PAR SKIN (basÃ©s sur le skin actif) ===
  section('Skin courant: ' + (SKINS[activeSkinIdx]?.name || currentSkinId || 'inconnu'));
  ensureSkinConfigObject(E);
  const currId = currentSkinId || SKINS[activeSkinIdx]?.id || 'classic';
  const SC = (E.skins[currId] ||= { ...E.fighter });

  // Sliders par skin
  addRange(devPanel,'Largeur % Ã©cran',SC,'wPct',{min:0.05,max:0.6,step:0.001});
  addRange(devPanel,'Centre X %',SC,'centerX',{min:0,max:1,step:0.001});
  addRange(devPanel,'Bas %',SC,'bottomPct',{min:-0.1,max:0.4,step:0.001});
  sep();

// Petite barre utilitaire
const bar2 = document.createElement('div'); bar2.className='bar';
const syncFromF = document.createElement('button'); syncFromF.textContent='Copier depuis "Personnage"';
syncFromF.onclick=()=>{
  Object.assign(SC, E.fighter);
  saveCFG();
  buildDevPanel(); // refresh UI
};
const copyThis = document.createElement('button'); copyThis.textContent='Copier ce skin';
copyThis.onclick=()=>{
  navigator.clipboard.writeText(JSON.stringify(SC,null,2)).catch(()=>{});
};
const pasteThis = document.createElement('button'); pasteThis.textContent='Coller sur ce skin';
pasteThis.onclick=()=>{
  const raw=prompt('Colle le JSON du skin:');
  if(!raw) return;
  try{
    const obj=JSON.parse(raw);
    ['wPct','centerX','bottomPct'].forEach(k=>{ if(typeof obj[k]==='number') SC[k]=obj[k]; });
    saveCFG(); buildDevPanel();
  }catch{ alert('JSON invalide'); }
};
bar2.append(syncFromF, copyThis, pasteThis);
devPanel.appendChild(bar2);

  section('OnomatopÃ©es (par technique)');
  E.onoByTech = E.onoByTech || deepClone(SEEDED_PROFILES.pc.onoByTech);
  const barWrap=document.createElement('div'); barWrap.className='bar';
  const previewBtn=document.createElement('button');
  function refreshPreviewBtn(){ previewBtn.textContent='AperÃ§u: '+(onoSticky?'ON':'OFF'); }
  previewBtn.onclick=()=>{ onoSticky=!onoSticky; if(onoSticky) showOnoSticky(); else hideOnoSticky(); refreshPreviewBtn(); };
  refreshPreviewBtn(); barWrap.appendChild(previewBtn);
  const seg=document.createElement('div'); seg.className='seg';
  const techs=['pak','tan','bon','punch']; const buttons=[];
  techs.forEach(k=>{
    const b=document.createElement('button'); b.textContent=k; b.dataset.tech=k;
    b.onclick=()=>{ onoEditTech=k; buttons.forEach(x=>x.classList.toggle('active', x.dataset.tech===k)); if(onoSticky) showOnoSticky(); buildDevPanel(); };
    buttons.push(b); seg.appendChild(b);
  });
  buttons.forEach(b=> b.classList.toggle('active', b.dataset.tech===onoEditTech));
  barWrap.appendChild(seg); devPanel.appendChild(barWrap);

  const O = E.onoByTech[onoEditTech];
  const refreshOno = ()=>{ if(onoSticky) showOnoSticky(); };
  addRange(devPanel,'Pos X % Ã©cran',O,'xPct',{min:0,max:1,step:0.001,after:refreshOno});
  addRange(devPanel,'Pos Y % Ã©cran',O,'yPct',{min:0,max:1,step:0.001,after:refreshOno});
  addRange(devPanel,'Hauteur % Ã©cran',O,'hPct',{min:0.05,max:0.8,step:0.001,after:refreshOno});
  addRange(devPanel,'Rotation (deg)',O,'rotDeg',{min:-180,max:180,step:1,after:refreshOno});

  devPanel.style.display='none';
}

/* ===== Panneau (T) lock ===== */
let devUnlocked = (localStorage.getItem('wcs_dev_ok') === '1');
function askDevPassword(){
  if (devUnlocked) return true;
  const pwd = prompt('Mot de passe dÃ©veloppeur ?');
  if (pwd === 'Tocard'){
    devUnlocked = true;
    localStorage.setItem('wcs_dev_ok','1');
    return true;
  }
  return false;
}
function toggleDevPanel(){
  const open = devPanel.style.display === 'block';
  if (open) devPanel.style.display = 'none';
  else {
    if (!askDevPassword()) return;
    buildDevPanel();
    devPanel.style.display = 'block';
    resize();
  }
}
function onKeyT(e){
  const isT = (e.code === 'KeyT') || (e.key && e.key.toLowerCase() === 't');
  if (!isT || e.repeat) return;
  e.preventDefault(); e.stopPropagation();
  toggleDevPanel();
}
if (!window.__T_BIND) {
  window.addEventListener('keydown', onKeyT, { capture: true });
  document.addEventListener('keydown', onKeyT, { capture: true });
  devPanel.addEventListener('keydown', onKeyT, { capture: true });
  window.__T_BIND = true;
}

/* ===== Init ===== */
function init(){
  resize();
  // sÃ©curitÃ©: si le skin sauvegardÃ© est verrouillÃ©, repasser au classic
  if(SKINS[activeSkinIdx]?.locked && !isUnlocked(SKINS[activeSkinIdx])) activeSkinIdx = 0;
  applySkin(activeSkinIdx);
  const tag = document.getElementById('appVersion');
  if (tag) tag.textContent = APP_LABEL + ' / ' + APP_VERSION;
  requestAnimationFrame(loop);
}
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

/* Sync --vh avec visualViewport + re-resize */
(function(){
  const applyVH = () => {
    const h = window.visualViewport ? window.visualViewport.height : window.innerHeight;
    document.documentElement.style.setProperty('--vh', h + 'px');
    resize();
  };
  applyVH();
  if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', applyVH, {passive:true});
    window.visualViewport.addEventListener('scroll', applyVH, {passive:true});
  } else {
    window.addEventListener('resize', applyVH, {passive:true});
  }

  // === Cheat code DEBUG : double D pour (dÃ©)bloquer Demon ===
window.addEventListener('keydown', (e)=>{
  if(e.key.toLowerCase() === 'd'){
    if(window._lastCheat && Date.now()-window._lastCheat < 600){
      const demonSkin = SKINS.find(s=>s.id==='demon');
      if(!demonSkin) return;

      if(isUnlocked(demonSkin)){
        lockSkin('demon');
        alert("Cheat : Demon REBLOQUÃ‰");
      } else {
        unlockSkin('demon');
        showNewSkinPopup(demonSkin);
        alert("Cheat : Demon DÃ‰BLOQUÃ‰");
      }
      renderSkins(); // refresh vignettes
    }
    window._lastCheat = Date.now();
  }
});

})();
</script>
  
  <!-- === Addon SKIN: MONKING (drop-in) â€” FIXED === -->
<script>
(function(){
  // 0) Sanity check sans passer par window.*
  if (typeof SKINS === 'undefined' ||
      typeof SFX === 'undefined' ||
      typeof VOICE_PACKS === 'undefined' ||
      typeof VOICE_PACK_ID === 'undefined') {
    console.warn('[Monking] Script principal non prÃªt.');
    return;
  }

  // 1) Sons voix Monking
  function A(src){ const a=new Audio(src); a.preload='none'; try{ a.src=bust(a.src);}catch{} return a; }
  SFX.monking_pak   = SFX.monking_pak   || A('assets/sounds/Son1 Monking.wav');
  SFX.monking_tan   = SFX.monking_tan   || A('assets/sounds/Son2 Monking.wav');
  SFX.monking_bon   = SFX.monking_bon   || A('assets/sounds/Son3 Monking.wav');
  SFX.monking_punch = SFX.monking_punch || A('assets/sounds/Son4 Monking.wav');
  try {
    SFX.monking_pak.volume =
    SFX.monking_tan.volume =
    SFX.monking_bon.volume =
    SFX.monking_punch.volume = 0.8;
  } catch {}

  // 2) Pack de voix + mapping
  VOICE_PACKS.monking = {
    pak:'monking_pak', tan:'monking_tan', bon:'monking_bon', punch:'monking_punch'
  };
  VOICE_PACK_ID.monking = 'monking';

  // 3) DÃ©claration du skin
  const MONKING_DEF = {
    id:'monking',
    name:'Monking',
    thumb:'https://i.imgur.com/cCAmBya.png',
    locked: true,
    f:{
      tan:'https://i.imgur.com/CyyeLpi.png',
      bon:'https://i.imgur.com/aBXIgsS.png',
      punch:'https://i.imgur.com/zBsBY7G.png',
      pak:'https://i.imgur.com/NDj4Qyw.png'
    }
  };
  if (!SKINS.find(s => s.id === 'monking')) {
    SKINS.push(MONKING_DEF);
  }

  // 4) Placement par skin (cloner "classic" ou fallback "fighter")
  function ensureSkinConfigObject(E){
    if(!E.skins) E.skins = {};
    SKINS.forEach(s => { if(!E.skins[s.id]) E.skins[s.id] = { ...E.fighter }; });
  }
  try {
    ['pc','mobile'].forEach(p=>{
      const E = (typeof CFG !== 'undefined' && CFG.profiles && CFG.profiles[p]) ? CFG.profiles[p] : null;
      if(!E) return;
      ensureSkinConfigObject(E);
      if (!E.skins.monking) {
        E.skins.monking = E.skins.classic ? { ...E.skins.classic } : { ...E.fighter };
      }
    });
    if (typeof saveCFG === 'function') saveCFG();
  } catch(e){
    console.warn('[Monking] Config skins: ', e);
  }

  // 5) Refresh UI si dispo
  try { if (typeof renderSkins === 'function') renderSkins(); } catch {}
  try { if (typeof buildDevPanel === 'function') buildDevPanel(); } catch {}

  console.log('[Monking] Skin installÃ©.');
})();
</script>

<!-- ==== ContrÃ´le de version / Mise Ã  jour (coller avant </body>) ==== -->
<style>
  /* BanniÃ¨re non bloquante */
  #updateBanner{
    position: fixed; left: 0; right: 0; bottom: 0; z-index: 9999;
    display: none; gap: 10px; align-items: center; justify-content: space-between;
    padding: 12px 14px; background: #18222b; color: #eaf2fb; font: 14px/1.3 system-ui, sans-serif;
    box-shadow: 0 -8px 24px rgba(0,0,0,.45);
  }
  #updateBanner .txt{opacity:.95}
  #updateBanner button{ all: unset; padding: 8px 12px; background:#3d74d6; color:#fff; border-radius:8px; cursor: pointer; font-weight:600 }
  #updateBanner .close{ background: transparent; color:#a9bfd4; padding:6px 10px; border:1px solid #2a3b49 }

  /* Overlay bloquant */
  #forceUpdateOverlay{
    position: fixed; inset: 0; z-index: 10000; display: none;
    background: rgba(0,0,0,.88); color: #eaf2fb; font: 15px/1.4 system-ui, sans-serif;
  }
  #forceUpdateOverlay .pane{
    position:absolute; inset: 0; display:flex; align-items:center; justify-content:center; padding: 20px;
  }
  #forceUpdateOverlay .card{
    max-width: 520px; background:#111a21; border:1px solid #22313d; border-radius:14px; padding:22px;
    box-shadow: 0 12px 36px rgba(0,0,0,.5);
  }
  #forceUpdateOverlay h2{ margin:0 0 8px 0; font-size: 20px }
  #forceUpdateOverlay p{ margin:0 0 14px 0; opacity:.95 }
  #forceUpdateOverlay .row{ display:flex; gap:10px; margin-top:6px; flex-wrap:wrap }
  #forceUpdateOverlay button{ all: unset; padding: 10px 14px; background:#3d74d6; color:#fff; border-radius:10px; cursor:pointer; font-weight:600 }
</style>

<!-- BanniÃ¨re â€œmise Ã  jour disponibleâ€ -->
<div id="updateBanner" role="status" aria-live="polite">
  <div class="txt">
    <strong>Nouvelle version disponible.</strong>
    <span id="ubNotes"></span>
  </div>
  <div style="display:flex; gap:8px; align-items:center">
    <button id="ubLater" class="close" title="Me rappeler plus tard">Plus tard</button>
    <button id="ubUpdate">Mettre Ã  jour</button>
  </div>
</div>

<!-- Overlay â€œmise Ã  jour obligatoireâ€ -->
<div id="forceUpdateOverlay" aria-modal="true" role="dialog">
  <div class="pane">
    <div class="card">
      <h2>Veuillez mettre Ã  jour lâ€™app</h2>
      <p>Cette version nâ€™est plus supportÃ©e. Installe la derniÃ¨re mise Ã  jour pour continuer.</p>
      <p id="fuNotes" style="opacity:.8"></p>
      <div class="row">
        <button id="fuoUpdate">TÃ©lÃ©charger la mise Ã  jour</button>
      </div>
    </div>
  </div>
</div>

<script>
  /* ===== CONFIG Ã€ PERSONNALISER ===== */
  const VERSION_ENDPOINT = "https://albatroswingchun.github.io/WingChunSimonGame/meta/version.json"; // â† ton URL publique
  const APP_VERSION      = "1.0.4";  // â† DOIT correspondre Ã  versionName (Android)
  const SNOOZE_HOURS     = 24;       // rappel â€œPlus tardâ€ aprÃ¨s 24h

  /* ===== UTILITAIRES ===== */
  function cmpSemver(a,b){
    const pa = String(a).split('.').map(n=>parseInt(n,10)||0);
    const pb = String(b).split('.').map(n=>parseInt(n,10)||0);
    const len = Math.max(pa.length, pb.length);
    for(let i=0;i<len;i++){
      const x = pa[i]||0, y = pb[i]||0;
      if (x>y) return 1;
      if (x<y) return -1;
    }
    return 0;
  }
  function nowTs(){ return Date.now(); }
  function hours(n){ return n*3600*1000; }

  /* ===== UI HANDLERS ===== */
  const $banner = document.getElementById('updateBanner');
  const $ubNotes = document.getElementById('ubNotes');
  const $ubUpdate = document.getElementById('ubUpdate');
  const $ubLater = document.getElementById('ubLater');

  const $force = document.getElementById('forceUpdateOverlay');
  const $fuNotes = document.getElementById('fuNotes');
  const $fuoUpdate = document.getElementById('fuoUpdate');

  function openUrl(url){
    // Simple et universel: navigue vers lâ€™URL (le tÃ©lÃ©chargement dâ€™APK sâ€™ouvrira)
    location.href = url;
  }

  function hideBanner(){ $banner.style.display = 'none'; }
  function showBanner(info){
    $ubNotes.textContent = info?.notes ? ` â€” ${info.notes}` : '';
    $banner.style.display = 'flex';
    $ubUpdate.onclick = ()=> openUrl(info.url);
    $ubLater.onclick = ()=>{
      localStorage.setItem('updateSnoozeUntil', String(nowTs() + hours(SNOOZE_HOURS)));
      hideBanner();
    };
  }

  function showForce(info){
    if (info?.notes) $fuNotes.textContent = info.notes;
    $force.style.display = 'block';
    $fuoUpdate.onclick = ()=> openUrl(info.url);
  }

  /* ===== COEUR: CHECK VERSION ===== */
  async function fetchVersionInfo(){
    const url = VERSION_ENDPOINT + (VERSION_ENDPOINT.includes('?') ? '&' : '?') + 't=' + Date.now();
    const r = await fetch(url, { cache: 'no-store' });
    if (!r.ok) throw new Error('HTTP ' + r.status);
    return r.json();
  }

  let lastCheckTs = 0;
  async function checkUpdate(force=false){
    const since = nowTs() - lastCheckTs;
    if (!force && since < 15_000) return; // Ã©vite spam si tu rappelles souvent
    lastCheckTs = nowTs();

    let info;
    try{
      info = await fetchVersionInfo();
    }catch(e){
      // Pas dâ€™internet/en erreur: on laisse vivre lâ€™app
      return;
    }

    const cur = APP_VERSION;
    const latest = info?.latest || cur;
    const minSupported = info?.minSupported || cur;

    // 1) MAJ obligatoire
    if (cmpSemver(cur, minSupported) < 0){
      showForce(info);
      return;
    }

    // 2) MAJ conseillÃ©e
    if (cmpSemver(cur, latest) < 0){
      const snooze = parseInt(localStorage.getItem('updateSnoozeUntil')||'0',10) || 0;
      if (nowTs() >= snooze){
        showBanner(info);
      }
      return;
    }

    // Sinon: rien
    hideBanner();
  }

  // DÃ‰MARRAGE + rappel quand lâ€™app revient au premier plan
  document.addEventListener('DOMContentLoaded', ()=> checkUpdate(true));
  document.addEventListener('visibilitychange', ()=> { if (!document.hidden) checkUpdate(false); });
</script>
<!-- ==== /ContrÃ´le de version ==== -->
  
</body>
</html>
