<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Wing Chun Simon â€“ 1536Ã—1160</title>

<link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">
<style>
  :root{
    --panel:#1c1715;--panel2:#241d1b;--ink:#e8d6b8;
    --red:#d34b43;--blue:#3d74d6;--green:#4cb36c;--gold:#d1a341;
  }
  html,body{margin:0;height:100%;background:#0b0a0a;color:#eee;font-family:system-ui,Segoe UI,Roboto,Arial;overflow:hidden}
  #app{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr auto}
  header{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:8px 12px;background:linear-gradient(180deg,var(--panel),var(--panel2));border-bottom:1px solid #2a2322;z-index:10}
  header .left, header .right{display:flex;align-items:center;gap:8px}
  .chip{padding:6px 10px;border-radius:9px;background:#2a2422;border:1px solid #3a302d}
  .btn{background:#1e1b1a;border:1px solid #3a302d;color:#e8d6b8;border-radius:10px;padding:10px 16px;cursor:pointer;font-weight:700}
  .btn:hover{filter:brightness(1.08)}
  footer{padding:6px 12px;font-size:12px;opacity:.6;text-align:center;background:linear-gradient(180deg,var(--panel2),#120f0f)}
  #stageWrap{position:relative;overflow:auto;display:grid;place-items:center;background:#000}
  #stage{position:relative;width:1536px;height:1160px}
  canvas{position:absolute;inset:0;width:1536px;height:1160px;image-rendering:pixelated;image-rendering:crisp-edges;touch-action:none}

  #board{position:absolute;left:50%;bottom:18px;transform:translateX(-50%);display:flex;gap:14px;z-index:5}
  .pad{width:132px;height:100px;border-radius:14px;background:linear-gradient(#2a2a2a,#1e1e1e);color:#cfcfcf;display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:inset 0 0 0 2px #000,0 6px 22px rgba(0,0,0,.45);cursor:pointer;user-select:none}
  .lit{filter:brightness(1.7);box-shadow:inset 0 0 0 2px #fff3,0 0 42px currentColor}
  .lit.red{color:var(--red)} .lit.blue{color:var(--blue)} .lit.green{color:var(--green)} .lit.gold{color:var(--gold)}

  #onoImg{position:absolute;left:50%;top:12%;transform:translate(-50%,0);width:auto;height:200px;opacity:0;pointer-events:none;z-index:6}
  .onoShow{animation:onoFade .9s ease forwards}
  @keyframes onoFade{0%{opacity:0;transform:translate(-50%,0) scale(.9)}20%{opacity:1;transform:translate(-50%,0) scale(1)}80%{opacity:1}100%{opacity:0}}
  #flash{position:absolute;inset:0;background:#ff000022;opacity:0;pointer-events:none;z-index:7}
  .boom{animation:boom .4s ease}@keyframes boom{0%{opacity:.65}100%{opacity:0}}

  #menu{position:absolute;inset:0;display:grid;place-items:center;background:transparent;z-index:10}
  .panel{background:rgba(0,0,0,.55);border-radius:16px;padding:28px 24px;text-align:center;border:1px solid #2f2724;min-width:560px}
  .title-main{font-family:'Permanent Marker',cursive;font-size:96px;line-height:0.9;margin:0;color:#e8d6b8;text-shadow:0 2px 0 #000,0 0 24px rgba(209,163,65,.35)}
  .title-sub{font-size:32px;margin:6px 0 12px;color:#d1a341}
  .subtitle{opacity:.95;margin:0 0 16px}
  .actions{display:flex;gap:12px;justify-content:center}
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="left">
      <strong>Wing Chun Simon</strong>
      <span class="chip">Score: <span id="score">0</span></span>
      <span class="chip">Meilleur: <span id="best">0</span></span>
    </div>
    <div class="right"></div>
  </header>

  <div id="stageWrap">
    <div id="stage">
      <canvas id="cx" width="1536" height="1160"></canvas>

      <div id="board">
        <button class="pad" data-tech="pak">Pak Sao</button>
        <button class="pad" data-tech="tan">Tan Sao</button>
        <button class="pad" data-tech="bon">Bon Sao</button>
        <button class="pad" data-tech="punch">Punch</button>
      </div>

      <img id="onoImg" alt="OnomatopÃ©e"/>
      <div id="flash"></div>

      <div id="menu">
        <div class="panel">
          <h1 class="title-main">Wing Chun</h1>
          <div class="title-sub">Simon Game</div>
          <p class="subtitle">Reproduis les techniques dans le bon ordre.</p>
          <div class="actions">
            <button id="startBtn" class="btn">Commencer</button>
            <button id="muteBtn"  class="btn">ðŸ”Š Son</button>
          </div>
          <div class="hi" style="opacity:.8;margin-top:8px">Meilleur: <span id="bestMenu">0</span></div>
        </div>
      </div>
    </div>
  </div>

  <footer>ScÃ¨ne 1536Ã—1160. Parallax. Un seul mannequin. Permanent Marker.</footer>
</div>

<script>
/* ====== refs ====== */
const pads=[...document.querySelectorAll('.pad')];
const scoreEl=document.getElementById('score');
const bestEl=document.getElementById('best');
const bestMenuEl=document.getElementById('bestMenu');
const menu=document.getElementById('menu');
const startBtn=document.getElementById('startBtn');
const muteBtn=document.getElementById('muteBtn');
const onoImg=document.getElementById('onoImg');
const flash=document.getElementById('flash');

/* ====== sons ====== */
const SFX = {
  pak:   new Audio('assets/sounds/pak.wav'),
  tan:   new Audio('assets/sounds/tan.wav'),
  bon:   new Audio('assets/sounds/bon.wav'),
  punch: new Audio('assets/sounds/punch.wav'),
  wrong: new Audio('assets/sounds/wrong.wav'),
  music: new Audio('assets/sounds/Digital Mosaic.mp3')
};
SFX.music.loop=true; SFX.music.volume=0.5;
Object.values(SFX).forEach(a=>a.preload='auto');
let muted=false;
muteBtn.onclick=()=>{
  muted=!muted;
  muteBtn.textContent=muted?'ðŸ”‡ Muet':'ðŸ”Š Son';
  if(muted) SFX.music.pause(); else SFX.music.play().catch(()=>{});
};
const play=a=>{ if(!muted && a){ try{a.currentTime=0;a.play()}catch(e){} } };

/* ====== images BG ====== */
const SKY    = new Image(); SKY.src    = 'https://i.imgur.com/QW70yEx.png';
const MT_FAR = new Image(); MT_FAR.src = 'https://i.imgur.com/I4gOsXm.png';
const MT_NEAR= new Image(); MT_NEAR.src= 'https://i.imgur.com/6Hnun6T.png';
const ALLEY  = new Image(); ALLEY.src  = 'https://i.imgur.com/hVGwPdp.png';

/* ====== sprites ====== */
function load(url){ const img=new Image(); img.crossOrigin='anonymous'; img.src=url; return img; }
const IMG={
  f_pak:   load('https://i.imgur.com/AweXMem.png'),
  f_tan:   load('https://i.imgur.com/ZrLk97U.png'),
  f_bon:   load('https://i.imgur.com/CG30Yh6.png'),
  f_punch: load('https://i.imgur.com/JYL2S46.png'),
  d_neutral:   load('https://i.imgur.com/VS52QCf.png'),
  d_pak:       load('https://i.imgur.com/c5FD1Up.png'),
  d_tan:       load('https://i.imgur.com/3abOAT3.png'),
  d_afterPak:  load('https://i.imgur.com/6ZKmReD.png'),
  d_afterTan:  load('https://i.imgur.com/fHGNzYR.png'),
  o_pak:   load('https://i.imgur.com/Y4EEnZg.png'),
  o_tan:   load('https://i.imgur.com/ELUj44i.png'),
  o_bon:   load('https://i.imgur.com/6pHczNb.png'),
  o_punch: load('https://i.imgur.com/dVISKcB.png')
};

/* ====== canvas ====== */
const cx=document.getElementById('cx');
const ctx=cx.getContext('2d'); ctx.imageSmoothingEnabled=false;
const W=1536, H=1160;

/* ====== config ====== */
const DEFAULT_CFG = {
  fighter: { w: 0.16,  x: 0.25, bottom: 0.08 },
  dummy:   { w: 0.126, centerX: 0.58, bottom: 0.06 },
  parallax:{ sky:0, far:0.20, near:0.42 },
  // dÃ©calage fin par technique, en pixels (positif = vers la DROITE)
  fighterDxPxByTech: { pak: 12, tan: 2500, bon: 0, punch: 2500 }
};

let CFG = JSON.parse(localStorage.getItem('wcs_layout')||'null') || DEFAULT_CFG;

/* ====== tiling ====== */
function tileNative(img, offsetX, y){
  if(!img.complete || !img.naturalWidth) return;
  const iw = img.naturalWidth;
  let x = offsetX % iw; if(x>0) x -= iw;
  for(; x < W; x += iw) ctx.drawImage(img, x, y);
}

/* ====== BG + sprites ====== */
let offFar=0, offNear=0;
function drawBG(dt){
  // ciel : dessiner seulement si l'image est vraiment prÃªte
  if (SKY.complete && SKY.naturalWidth){
    ctx.drawImage(SKY, 0, 0);
  } else {
    // fallback visuel pour Ã©viter l'Ã©cran noir pendant le chargement/erreur
    const g = ctx.createLinearGradient(0, 0, 0, H);
    g.addColorStop(0, '#0a0c12');
    g.addColorStop(1, '#1a1f2a');
    ctx.fillStyle = g;
    ctx.fillRect(0, 0, W, H);
  }

  offFar  -= CFG.parallax.far  * dt;
  offNear -= CFG.parallax.near * dt;

  tileNative(MT_FAR,  offFar,  185);
  ctx.fillStyle='rgba(0,0,0,.10)'; ctx.fillRect(0,0,W,H);
  tileNative(MT_NEAR, offNear, 0);

  if (ALLEY.complete && ALLEY.naturalWidth){
    const y = H - ALLEY.naturalHeight;
    tileNative(ALLEY, 0, y);
  }
}


/* ====== Ã©tat sprites ====== */
let currentFighter = IMG.f_pak;
let dummyPhase = { img: IMG.d_neutral, until: 0 };

// tech courante et petite anim d'action
let currentTech = 'pak';
let actionAnim = { until: 0, lunge: 0, scale: 1 }; // lunge en px, scale multiplicatif


function setSpritesFor(tech){
  currentTech = tech;
  const now = performance.now();

  // petite impulsion sur le personnage
  actionAnim = { until: now + 260, lunge: 10, scale: 1.03 };

  // sprite du perso
  currentFighter = IMG['f_'+tech] || currentFighter;

  // mannequin: phase during -> after
  if(tech==='pak' || tech==='bon'){
    dummyPhase = { img: IMG.d_pak || IMG.d_neutral, until: now + 260 };
    setTimeout(()=>{
      if (performance.now() > dummyPhase.until){
        dummyPhase = { img: IMG.d_afterPak || IMG.d_neutral, until: performance.now() + 200 };
      }
    }, 260);
  } else if(tech==='tan' || tech==='punch'){
    dummyPhase = { img: IMG.d_tan || IMG.d_neutral, until: now + 260 };
    setTimeout(()=>{
      if (performance.now() > dummyPhase.until){
        dummyPhase = { img: IMG.d_afterTan || IMG.d_neutral, until: performance.now() + 200 };
      }
    }, 260);
  }
}


function drawFighter(){
  const img = currentFighter;
  if(!img || !img.complete || !img.naturalWidth) return;

  // tailles de base
  const baseW = Math.max(90, CFG.fighter.w*W);
  const baseScale = baseW / img.naturalWidth;
  const baseH = img.naturalHeight * baseScale;

  // offset fin par technique
  const dxTech = (CFG.fighterDxPxByTech && CFG.fighterDxPxByTech[currentTech]) || 0;

  // animation: idle bob + impulsion d'action
  const now = performance.now();

  // idle: lÃ©ger "bob" vertical quand aucune action
  const idleBob = (now > actionAnim.until) ? Math.sin(now/420)*3 : 0;

  // action: lunge + petit scale progressif
  let extraX = 0, extraY = 0, scaleMul = 1;
  if(now < actionAnim.until){
    const dur = actionAnim.until - (now - 260);  // ~260ms
    const t = 1 - Math.max(0,(actionAnim.until - now)/Math.max(1,dur));
    const ease = 1 - Math.pow(1 - t, 3); // easeOutCubic
    extraX = actionAnim.lunge * ease;           // pousse un peu vers lâ€™adversaire
    scaleMul = 1 + (actionAnim.scale - 1) * ease;
    extraY = -2 * ease;                         // micro impulsion vers le haut
  }

  // position finale
  const xBase = W*CFG.fighter.x + dxTech + extraX;
  const yBase = H - (baseH*scaleMul) - H*CFG.fighter.bottom + idleBob + extraY;

  // rendu
  ctx.drawImage(img, xBase, yBase, baseW*scaleMul, baseH*scaleMul);
}
function drawDummy(){
  const now=performance.now();
  const active = now < dummyPhase.until ? dummyPhase.img : IMG.d_neutral;
  const img=active; if(!img||!img.complete||!img.naturalWidth) return;
  const targetW = Math.max(90, CFG.dummy.w*W);
  const s = targetW / img.naturalWidth;
  const targetH = img.naturalHeight * s;
  const cxCenter = W*CFG.dummy.centerX;
  const xLeft = cxCenter - targetW/2;
  const y = H - targetH - H*CFG.dummy.bottom;
  ctx.drawImage(img, xLeft, y, targetW, targetH);
}

/* ====== onomatopÃ©es ====== */
function showOno(tech){
  const img = IMG['o_'+tech];
  if(!img) return;
  onoImg.src = img.src;
  onoImg.classList.remove('onoShow'); void onoImg.offsetWidth; onoImg.classList.add('onoShow');
}

/* ====== Simon ====== */
let seq=[], userIndex=0, locked=true, score=0, best=+localStorage.getItem('wcs_best')||0;
bestEl.textContent=best; if(bestMenuEl) bestMenuEl.textContent=best;
const TECHS=['pak','tan','bon','punch'];
const TECH_TO_COLOR={pak:'gold',tan:'green',bon:'blue',punch:'red'};

function setLit(tech,on){
  const b=pads.find(x=>x.dataset.tech===tech);
  if(!b) return;
  b.classList.toggle('lit',on);
  b.classList.toggle(TECH_TO_COLOR[tech],on);
}
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
const randTech=()=>TECHS[Math.random()*TECHS.length|0];

async function playSequence(){
  locked=true; await sleep(560);
  for(const tech of seq){
    setSpritesFor(tech);
    setLit(tech,true); play(SFX[tech]); showOno(tech);
    await sleep(460);
    setLit(tech,false);
    await sleep(160);
  }
  locked=false; userIndex=0;
}
async function press(tech){
  if(locked) return;
  setSpritesFor(tech); setLit(tech,true); play(SFX[tech]); showOno(tech);
  await sleep(200); setLit(tech,false);

  if(tech!==seq[userIndex]){
    play(SFX.wrong);
    flash.classList.remove('boom'); void flash.offsetWidth; flash.classList.add('boom');
    seq=[]; score=0; scoreEl.textContent=0; locked=true; await sleep(600); startGame(); return;
  }
  userIndex++;
  if(userIndex===seq.length){
    score++; scoreEl.textContent=score;
    if(score>best){
      best=score; bestEl.textContent=best; if(bestMenuEl) bestMenuEl.textContent=best;
      localStorage.setItem('wcs_best',best);
    }
    seq.push(randTech()); await sleep(420); playSequence();
  }
}

/* ====== EntrÃ©es unifiÃ©es ====== */
pads.forEach(b=>{
  b.addEventListener('pointerdown',e=>{
    e.preventDefault();
    const tech=b.dataset.tech;
    press(tech);
  }, {passive:false});
});

/* ====== DÃ©marrage ====== */
function startGame(){
  menu.style.display='none';
  if(!muted) SFX.music.play().catch(()=>{});
  dummyPhase={img:IMG.d_neutral, until:0};
  seq=[randTech()]; score=0; scoreEl.textContent=0; playSequence();
}
startBtn.addEventListener('pointerdown',e=>{e.preventDefault();startGame();},{passive:false});

/* ====== boucle ====== */
let last=performance.now();
function loop(t=performance.now()){
  const dt = Math.min(33, t-last) / (1000/60); last=t;
  ctx.clearRect(0,0,W,H);
  drawBG(dt);
  drawDummy();
  drawFighter();
  requestAnimationFrame(loop);
}

/* ====== init ====== */
requestAnimationFrame(loop);
</script>
</body>
</html>
