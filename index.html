<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Wing Chun Simon Game</title>
<style>
  :root{
    --panel:#1c1715;--panel2:#241d1b;--ink:#e8d6b8;
    --red:#d34b43;--blue:#3d74d6;--green:#4cb36c;--gold:#d1a341;
    --portrait-stage-offset: 18%;
  }

  html,body{margin:0;height:100%;background:#0b0a0a;color:#eee;font-family:system-ui,Segoe UI,Roboto,Arial;overflow:hidden}
  #app{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr auto}

  header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:linear-gradient(180deg,var(--panel),var(--panel2));border-bottom:1px solid #2a2322;z-index:10}
  header .score{font-size:14px} header .best{opacity:.8}
  footer{padding:6px 12px;font-size:12px;opacity:.6;text-align:center;background:linear-gradient(180deg,var(--panel2),#120f0f);z-index:10}

  #stageWrap{position:relative;overflow:hidden;background:#0f0e0e}
  #stage{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(100vw,960px);height:min(56vw,540px);max-height:72vh}
  canvas{position:absolute;inset:0;width:100%;height:100%;image-rendering:pixelated;image-rendering:crisp-edges;touch-action:none}

  /* Boutons (ligne) */
  #board{position:absolute;left:50%;bottom:20px;transform:translateX(-50%);display:flex;gap:14px;z-index:5}
  .pad{width:132px;height:100px;border-radius:14px;background:linear-gradient(#2a2a2a,#1e1e1e);color:#cfcfcf;display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:inset 0 0 0 2px #000,0 6px 22px rgba(0,0,0,.45);cursor:pointer;transition:transform .06s ease,filter .12s;-webkit-tap-highlight-color:transparent}
  .pad:active{transform:translateY(2px)}
  .lit{filter:brightness(1.7);box-shadow:inset 0 0 0 2px #fff3,0 0 42px currentColor}
  .lit.red{color:var(--red)} .lit.blue{color:var(--blue)} .lit.green{color:var(--green)} .lit.gold{color:var(--gold)}

  /* Menu */
  #menu{position:absolute;inset:0;display:grid;place-items:center;background:url('https://i.imgur.com/bLV8zWf.png') center/cover no-repeat;z-index:10}
  .panel{background:rgba(0,0,0,.6);border-radius:16px;padding:28px 24px;width:min(760px,92vw);box-shadow:0 20px 80px rgba(0,0,0,.6);text-align:center}
  .title-main{font-size:48px;color:#d1a341;text-shadow:0 2px 0 #000,0 0 24px rgba(209,163,65,.35);margin:0}
  .title-sub{font-size:32px;color:#e8d6b8;margin:5px 0 15px}
  .subtitle{font-size:18px;color:#fff;margin-bottom:20px}
  .actions{display:flex;gap:20px;justify-content:center;flex-wrap:wrap}
  .btn{background:linear-gradient(180deg,#2a221f,#1f1a18);border:1px solid #3a302d;color:#e9d9bc;padding:14px 26px;border-radius:10px;font-weight:700;cursor:pointer;font-size:18px}
  .btn:hover{filter:brightness(1.08)}
  .hi{font-size:14px;text-align:center;margin-top:10px;opacity:.85}

  /* Onomatop√©es image + fondu */
  #onoImg{position:absolute;left:50%;top:12%;transform:translate(-50%,0);width:auto;height:min(26vh,200px);opacity:0;pointer-events:none;z-index:6}
  .onoShow{animation:onoFade .9s ease forwards}
  @keyframes onoFade{0%{opacity:0;transform:translate(-50%,0) scale(.9)}20%{opacity:1;transform:translate(-50%,0) scale(1)}80%{opacity:1}100%{opacity:0}}
  #flash{position:absolute;inset:0;background:#ff000022;opacity:0;pointer-events:none;z-index:7}
  .boom{animation:boom .4s ease}@keyframes boom{0%{opacity:.65}100%{opacity:0}}

  /* ===== Portrait mobile ===== */
  @media (max-width:768px) and (orientation:portrait){
    html, body { height: 100svh; }
    body.touch #stage{ top: var(--portrait-stage-offset); transform: translate(-50%,0); width: min(100svw, 900px); height: calc(100svh - 240px); max-height: none }
    @supports (height: 100dvh){ body.touch #stage{ height: calc(100dvh - 240px) } }
    body.touch #board{ position:absolute; left:50%; bottom:max(8px, env(safe-area-inset-bottom)); transform:translateX(-50%); display:flex; gap:10px; padding:0 8px; width:auto }
    body.touch .pad{ width: clamp(86px, 22vw, 130px); height: clamp(58px, 11vh, 92px); font-size: clamp(14px, 3.4vh, 18px); border-radius:12px }
    #menu .panel{ width:min(92vw,680px); padding:18px 16px; backdrop-filter:blur(2px) }
    .title-main{ font-size: clamp(28px, 6.2vh, 36px) } .title-sub{ font-size: clamp(20px, 4.6vh, 28px) } .subtitle{ font-size: clamp(14px, 2.8vh, 18px); margin-bottom:14px }
    .actions{ gap:12px } .btn{ font-size: clamp(14px, 2.8vh, 18px); padding:12px 18px }
    footer{ display:none }
  }
</style>
</head>
<body>
<div id="app">
  <header>
    <div><strong>Wing Chun Simon</strong></div>
    <div class="score">Score: <span id="score">0</span> ‚Ä¢ <span class="best">Meilleur: <span id="best">0</span></span></div>
  </header>

  <div id="stageWrap">
    <div id="stage">
      <canvas id="cx"></canvas>

      <div id="board" aria-label="Boutons">
        <button class="pad" data-tech="pak">Pak Sao</button>
        <button class="pad" data-tech="tan">Tan Sao</button>
        <button class="pad" data-tech="bon">Bon Sao</button>
        <button class="pad" data-tech="punch">Punch</button>
      </div>

      <img id="onoImg" alt="Onomatop√©e"/>
      <div id="flash"></div>

      <div id="menu">
        <div class="panel">
          <h1 class="title-main">Wing Chun</h1>
          <h2 class="title-sub">Simon Game</h2>
          <p class="subtitle">Reproduis les techniques dans le bon ordre !</p>
          <div class="actions">
            <button id="startBtn" class="btn">Commencer</button>
            <button id="muteBtn"  class="btn">üîä Son</button>
          </div>
          <div class="hi">Meilleur score: <span id="bestMenu">0</span></div>
        </div>
      </div>
    </div>
  </div>

  <footer>Canvas optimis√©. Sons WAV dans <code>assets/sounds/</code>.</footer>
</div>

<script>
/* D√©tection tactile pour layout mobile */
const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints>0;
if(isTouch) document.body.classList.add('touch');

/* ======== SONS ======== */
const SFX = {
  pak:   new Audio('assets/sounds/pak.wav'),
  tan:   new Audio('assets/sounds/tan.wav'),
  bon:   new Audio('assets/sounds/bon.wav'),
  punch: new Audio('assets/sounds/punch.wav'),
  wrong: new Audio('assets/sounds/wrong.wav'),
  music: new Audio('assets/sounds/Digital Mosaic.mp3')
};
SFX.music.loop = true; SFX.music.volume = 0.5;
Object.values(SFX).forEach(a=>{a.preload='auto';});

/* ======== √âTAT UI ======== */
const pads=[...document.querySelectorAll('.pad')];
const scoreEl=document.getElementById('score');
const bestEl=document.getElementById('best');
const bestMenuEl=document.getElementById('bestMenu');
const menu=document.getElementById('menu');
const startBtn=document.getElementById('startBtn');
const muteBtn=document.getElementById('muteBtn');
const onoImg=document.getElementById('onoImg');
const flash=document.getElementById('flash');

let muted=false;
muteBtn.onclick=()=>{
  muted=!muted;
  muteBtn.textContent = muted?'üîá Muet':'üîä Son';
  if(muted) SFX.music.pause(); else SFX.music.play().catch(()=>{});
};
const play=a=>{ if(!muted){ try{a.currentTime=0;a.play()}catch(e){} } };

let seq=[], userIndex=0, locked=true, score=0;
let best=+localStorage.getItem('wcs_best')||0;
bestEl.textContent=best; bestMenuEl.textContent=best;

/* ======== ASSETS ======== */
/* Couches 1536x1160 */
const SKY    = new Image(); SKY.src    = 'https://i.imgur.com/bLV8zWf.png';
const MT_FAR = new Image(); MT_FAR.src = 'https://i.imgur.com/D2n1796.png';
const MT_NEAR= new Image(); MT_NEAR.src= 'https://i.imgur.com/6Hnun6T.png';
const ALLEY  = new Image(); ALLEY.src  = 'https://i.imgur.com/hVGwPdp.png';

/* Perso + mannequin + onomatop√©es (d√©j√† fournis pr√©c√©demment) */
const IM = {
  fighter: {
    bon:   'https://i.imgur.com/CG30Yh6.png',
    tan:   'https://i.imgur.com/ZrLk97U.png',
    pak:   'https://i.imgur.com/AweXMem.png',
    punch: 'https://i.imgur.com/JYL2S46.png'
  },
  dummy: {
    pakDuring: 'https://i.imgur.com/c5FD1Up.png',
    pakAfter:  'https://i.imgur.com/6ZKmReD.png',
    tanDuring: 'https://i.imgur.com/3abOAT3.png',
    tanAfter:  'https://i.imgur.com/fHGNzYR.png'
  },
  ono: {
    pak:   'https://i.imgur.com/Y4EEnZg.png',
    tan:   'https://i.imgur.com/ELUj44i.png',
    bon:   'https://i.imgur.com/6pHczNb.png',
    punch: 'https://i.imgur.com/dVISKcB.png'
  }
};
function load(url){ const img=new Image(); img.src=url; return img; }
const IMG = {};
for(const k in IM.fighter) IMG['f_'+k]=load(IM.fighter[k]);
for(const k in IM.dummy)   IMG['d_'+k]=load(IM.dummy[k]);
for(const k in IM.ono)     IMG['o_'+k]=load(IM.ono[k]);

/* ======== CANVAS / DIMENSIONS ======== */
const cx=document.getElementById('cx');
const ctx=cx.getContext('2d',{alpha:true});
ctx.imageSmoothingEnabled=false;

let DPR=1, W=0, H=0;
let raiseY=0;

/* Mise √† l‚Äô√©chelle bas√©e sur ta compo 1536√ó1160 */
const BASE_W=1536, BASE_H=1160;

/* Parallaxe: vitesses relatives (px/frame @60fps) */
const PAR = document.body.classList.contains('touch')
  ? { sky:0.08, far:0.18, near:0.36 }
  : { sky:0.10, far:0.22, near:0.45 };

let offSky=0, offFar=0, offNear=0, offAlley=0;

/* Placement et tailles: cal√©s sur ta r√©f (ratios), ajustables vite fait */
const CFG = document.body.classList.contains('touch')
  ? {
      fighter: { w: 0.19, x: 0.33, bottom: 0.06 },
      dummy:   { w: 0.17, x: 0.50, bottom: 0.06 },
      alleyH:  0.24       // hauteur de l'all√©e vs √©cran
    }
  : {
      fighter: { w: 0.20, x: 0.35, bottom: 0.06 },
      dummy:   { w: 0.18, x: 0.52, bottom: 0.06 },
      alleyH:  0.24
    };

function updateRaiseY(){
  const isPortrait = matchMedia('(orientation: portrait)').matches;
  raiseY = (document.body.classList.contains('touch') && isPortrait) ? 180 : 0;
}
function resizeCanvas(){
  const rect = cx.parentElement.getBoundingClientRect();
  DPR = Math.min(3, window.devicePixelRatio||1);
  cx.width  = Math.max(320, Math.floor(rect.width  * DPR));
  cx.height = Math.max(240, Math.floor(rect.height * DPR));
  cx.style.width  = rect.width + 'px';
  cx.style.height = rect.height + 'px';
  W = cx.width; H = cx.height;
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(DPR, DPR);
  updateRaiseY();
}
window.addEventListener('resize', resizeCanvas, {passive:true});
window.addEventListener('orientationchange', ()=>setTimeout(resizeCanvas,150), {passive:true});

/* Outils dessin tuil√© */
function tile(img, offset, y, targetH){
  if(!img.complete || !img.naturalWidth) return;
  const CW=W/DPR;
  const s = targetH / img.height;
  const w = img.width * s;
  let x = offset % w; if(x>0)x-=w;
  for(; x < CW; x += w){
    ctx.drawImage(img, 0, 0, img.width, img.height, x, y, w, targetH);
  }
}

function drawBG(dt){
  const CW=W/DPR, CH=H/DPR;
  // avance offsets
  offSky  -= PAR.sky   * dt;
  offFar  -= PAR.far   * dt;
  offNear -= PAR.near  * dt;

  // ciel, montagnes lointaines, montagnes proches
  tile(SKY,    offSky,  -raiseY, CH);
  tile(MT_FAR, offFar,  -raiseY, CH);
  ctx.fillStyle='rgba(0,0,0,.10)'; ctx.fillRect(0,-raiseY,CW,CH); // l√©ger voile
  tile(MT_NEAR,offNear, -raiseY, CH);

  // all√©e fixe
  const alleyH = Math.max(0.18, CFG.alleyH) * CH;
  const y = CH - alleyH - raiseY;
  tile(ALLEY, 0, y, alleyH);
}

/* Sprites actifs */
let currentFighter = IMG['f_pak'];
let currentDummy   = IMG['d_pakAfter'];

function drawDummy(){
  const CW=W/DPR, CH=H/DPR;
  const img=currentDummy; if(!img || !img.complete) return;
  const w = Math.max(120, CFG.dummy.w*CW);
  const s = w / img.width;
  const h = img.height*s;
  const x = CW*CFG.dummy.x;
  const y = CH - h - CH*CFG.dummy.bottom - raiseY;
  ctx.drawImage(img, x, y, w, h);
}
function drawFighter(){
  const CW=W/DPR, CH=H/DPR;
  const img=currentFighter; if(!img || !img.complete) return;
  const w = Math.max(120, CFG.fighter.w*CW);
  const s = w / img.width;
  const h = img.height*s;
  const x = CW*CFG.fighter.x;
  const y = CH - h - CH*CFG.fighter.bottom - raiseY;
  ctx.drawImage(img, x, y, w, h);
}

/* Onomatop√©es */
function showOno(tech){
  const img = IMG['o_'+tech];
  if(!img) return;
  onoImg.src = img.src;
  onoImg.classList.remove('onoShow'); void onoImg.offsetWidth; onoImg.classList.add('onoShow');
}

/* ======== SIMON ======== */
const TECHS=['pak','tan','bon','punch'];
const TECH_TO_COLOR={pak:'gold',tan:'green',bon:'blue',punch:'red'};

function setLit(tech,on){
  const btn=pads.find(b=>b.dataset.tech===tech);
  btn.classList.toggle('lit',on);
  btn.classList.toggle(TECH_TO_COLOR[tech],on);
}
const sleep = ms => new Promise(r=>setTimeout(r,ms));
function randTech(){ return TECHS[Math.random()*TECHS.length|0]; }

function setSpritesFor(tech){
  currentFighter = IMG['f_'+tech] || currentFighter;
  if(tech==='pak' || tech==='bon'){
    currentDummy = IMG['d_pakDuring'];
    setTimeout(()=>{ currentDummy = IMG['d_pakAfter']; }, 260);
  }else{
    currentDummy = IMG['d_tanDuring'];
    setTimeout(()=>{ currentDummy = IMG['d_tanAfter']; }, 260);
  }
}

async function playSequence(){
  locked=true; await sleep(560);
  for(const tech of seq){
    setSpritesFor(tech);
    setLit(tech,true);
    play(SFX[tech]);
    showOno(tech);
    await sleep(460);
    setLit(tech,false);
    await sleep(160);
  }
  locked=false; userIndex=0;
}

async function press(tech){
  if(locked) return;
  setSpritesFor(tech);
  setLit(tech,true);
  play(SFX[tech]);
  showOno(tech);
  await sleep(200);
  setLit(tech,false);

  if(tech!==seq[userIndex]){
    play(SFX.wrong);
    flash.classList.remove('boom'); void flash.offsetWidth; flash.classList.add('boom');
    seq=[]; score=0; scoreEl.textContent=0; locked=true; await sleep(600); startGame(); return;
  }
  userIndex++;
  if(userIndex===seq.length){
    score++; scoreEl.textContent=score;
    if(score>best){best=score;bestEl.textContent=best;bestMenuEl.textContent=best;localStorage.setItem('wcs_best',best);}
    seq.push(randTech()); await sleep(420); playSequence();
  }
}

/* Entr√©es */
pads.forEach(b=>{
  b.addEventListener('click',()=>press(b.dataset.tech));
  b.addEventListener('touchstart',e=>{e.preventDefault();press(b.dataset.tech)},{passive:false});
});
window.addEventListener('keydown',e=>{
  if(e.key==='1') press('pak');
  if(e.key==='2') press('tan');
  if(e.key==='3') press('bon');
  if(e.key==='4') press('punch');
});

/* Flow */
function startGame(){
  menu.style.display='none';
  if(!muted) SFX.music.play().catch(()=>{});
  seq=[randTech()]; score=0; scoreEl.textContent=0; playSequence();
}
document.getElementById('startBtn').addEventListener('click',startGame);

/* Boucle ‚Äî dt bas√© sur raf pour parallaxe douce partout */
let last=performance.now();
function loop(t=performance.now()){
  const dt = Math.min(33, t - last) / (1000/60); // normalise ~60fps
  last = t;
  ctx.clearRect(0,0,cx.width,cx.height);
  drawBG(dt); drawDummy(); drawFighter();
  requestAnimationFrame(loop);
}

/* Init */
resizeCanvas();
requestAnimationFrame(loop);
</script>
</body>
</html>
