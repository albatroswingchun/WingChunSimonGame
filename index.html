<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Wing Chun - Simon Game</title>
<link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">
<style>
  :root{ --panel:#1c1715;--panel2:#241d1b;--ink:#e8d6b8; --gold:#d1a341; }
  html,body{margin:0;height:100%;background:#0b0a0a;color:#eee;font-family:system-ui,Segoe UI,Roboto,Arial;overflow:hidden}
  #app{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr auto}
  header{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:8px 12px;background:linear-gradient(180deg,var(--panel),var(--panel2));border-bottom:1px solid #2a2322;z-index:20}
  .chip{padding:6px 10px;border-radius:9px;background:#2a2422;border:1px solid #3a302d}
  .btn{background:#1e1b1a;border:1px solid #3a302d;color:#e8d6b8;border-radius:10px;padding:10px 16px;cursor:pointer;font-weight:700}
  .btn:hover{filter:brightness(1.08)}
  footer{padding:6px 12px;font-size:12px;opacity:.6;text-align:center;background:linear-gradient(180deg,var(--panel2),#120f0f);z-index:5}

  #stageWrap{position:relative;display:grid;place-items:center;overflow:hidden;background:#000}
  #stage{position:relative}
  canvas{position:absolute;left:0;top:0;touch-action:none;image-rendering:pixelated;image-rendering:crisp-edges}

  #board{position:absolute;left:50%;bottom:18px;transform:translateX(-50%);display:flex;gap:14px;z-index:10}
  .pad{width:132px;height:100px;border-radius:14px;background:linear-gradient(#2a2a2a,#1e1e1e);color:#cfcfcf;display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:inset 0 0 0 2px #000,0 6px 22px rgba(0,0,0,.45);cursor:pointer;user-select:none}
  .lit{filter:brightness(1.7);box-shadow:inset 0 0 0 2px #fff3,0 0 42px currentColor}

  /* Onomatop√©es: position/rotation/hauteur g√©r√©es en JS, aper√ßu collant */
  #onoImg{
    position:absolute; left:50%; top:50%;
    width:auto; height:360px; opacity:0; pointer-events:none; z-index:11;
    transform:translate(-50%,-50%);
  }
  .onoShow{animation:onoFade .9s ease forwards}
  @keyframes onoFade{0%{opacity:0}20%{opacity:1}80%{opacity:1}100%{opacity:0}}
  #flash{position:absolute;inset:0;background:#ff000022;opacity:0;pointer-events:none;z-index:12}
  .boom{animation:boom .4s ease}@keyframes boom{0%{opacity:.65}100%{opacity:0}}

  #menu{position:absolute;inset:0;display:grid;place-items:center;background:transparent;z-index:15}
  .panel{background:rgba(0,0,0,.55);border-radius:16px;padding:28px 24px;text-align:center;border:1px solid #2f2724;min-width:560px}
  .title-main{font-family:'Permanent Marker',cursive;font-size:96px;line-height:0.9;margin:0;color:#e8d6b8;text-shadow:0 2px 0 #000,0 0 24px rgba(209,163,65,.35)}
  .title-sub{font-size:32px;margin:6px 0 12px;color:var(--gold)}
  .subtitle{opacity:.95;margin:0 0 16px}
  .actions{display:flex;gap:12px;justify-content:center}

  #skinsPanel{margin-top:14px;background:#1118;border:1px solid #2f2724;border-radius:12px;padding:14px;display:none}
  #skinsGrid{display:grid;grid-template-columns:repeat(2, minmax(160px,1fr));gap:12px}
  .skinCard{background:#1a1716;border:1px solid #3a302d;border-radius:10px;padding:10px;cursor:pointer;text-align:center}
  .skinCard:hover{filter:brightness(1.05)}
  .skinActive{outline:2px solid var(--gold)}
  .skinThumb{display:block;margin:0 auto 8px;height:96px;width:auto;image-rendering:pixelated}

  /* Panneau r√©glages (T) */
  #devPanel{
    position:fixed; top:68px; right:12px; width:380px; max-height:85vh; overflow:auto;
    background:#111c; backdrop-filter: blur(6px); border:1px solid #2f2724; border-radius:12px; z-index:30;
    padding:12px; display:none;
  }
  #devPanel h2{margin:0 0 6px; font-size:18px}
  #devPanel h3{margin:12px 0 6px; font-size:15px; color:#ffd48a}
  #devPanel .row{display:grid; grid-template-columns:140px 1fr 64px; align-items:center; gap:6px; margin:6px 0}
  #devPanel .row input[type="range"]{width:100%}
  #devPanel .row input[type="number"]{width:64px; background:#1b1716; color:#e8d6b8; border:1px solid #3a302d; border-radius:6px; padding:6px}
  #devPanel .bar{display:flex; gap:8px; margin:8px 0 4px; flex-wrap:wrap}
  #devPanel .bar button, #devPanel .bar .seg, #devPanel .bar .toggle{padding:8px 10px; border-radius:8px; border:1px solid #3a302d; background:#1e1b1a; color:#e8d6b8; cursor:pointer}
  #devPanel .seg{display:flex; gap:6px; flex:1; align-items:center; justify-content:space-between}
  #devPanel .seg button{flex:1; border-radius:6px}
  #devPanel .seg .active{outline:2px solid var(--gold)}
  .sep{margin:10px 0; height:1px; background:#2a2322}
  .hint{font-size:11px;opacity:.7;margin-top:6px}
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="left">
      <strong>Wing Chun Simon</strong>
      <span class="chip">Score: <span id="score">0</span></span>
      <span class="chip">Meilleur: <span id="best">0</span></span>
    </div>
    <div class="right"><span class="chip">T: R√©glages</span></div>
  </header>

  <div id="stageWrap">
    <div id="stage">
      <canvas id="cx"></canvas>

      <div id="board">
        <button class="pad" data-tech="pak">Pak Sao</button>
        <button class="pad" data-tech="tan">Tan Sao</button>
        <button class="pad" data-tech="bon">Bon Sao</button>
        <button class="pad" data-tech="punch">Punch</button>
      </div>

      <img id="onoImg" alt="Onomatop√©e"/>
      <div id="flash"></div>

      <div id="menu">
        <div class="panel">
          <h1 class="title-main">Wing Chun</h1>
          <div class="title-sub">Simon Game</div>
          <p class="subtitle">Reproduis les techniques dans le bon ordre.</p>
          <div class="actions">
            <button id="startBtn" class="btn">Commencer</button>
            <button id="muteBtn"  class="btn">üîä Son</button>
            <button id="skinsBtn" class="btn">üé® Skins</button>
          </div>

          <div id="skinsPanel">
            <div style="margin-bottom:8px;opacity:.85">Choisis un skin de personnage</div>
            <div id="skinsGrid"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>Ratios: PC 4:3, Mobile 9:16. Tout est en % d‚Äô√©cran, vitesses en ‚Äú√©cran/s‚Äù. T pour ouvrir/fermer.</footer>
</div>

<div id="devPanel"></div>

<script>
/* ===== Ratios cibles ===== */
const PC_RATIO = 4/3;      // paysage
const MB_RATIO = 9/16;     // portrait

/* ===== Refs ===== */
const pads=[...document.querySelectorAll('.pad')];
const scoreEl=document.getElementById('score');
const bestEl=document.getElementById('best');
const menu=document.getElementById('menu');
const startBtn=document.getElementById('startBtn');
const muteBtn=document.getElementById('muteBtn');
const skinsBtn=document.getElementById('skinsBtn');
const skinsPanel=document.getElementById('skinsPanel');
const skinsGrid=document.getElementById('skinsGrid');
const onoImg=document.getElementById('onoImg');
const flash=document.getElementById('flash');
const devPanel=document.getElementById('devPanel');
const stageWrap=document.getElementById('stageWrap');
const stage=document.getElementById('stage');
const cx=document.getElementById('cx');
const ctx=cx.getContext('2d',{alpha:true}); ctx.imageSmoothingEnabled=false;

/* ===== Audio ===== */
const SFX = {
  pak:   new Audio('assets/sounds/pak.wav'),
  tan:   new Audio('assets/sounds/tan.wav'),
  bon:   new Audio('assets/sounds/bon.wav'),
  punch: new Audio('assets/sounds/punch.wav'),
  wrong: new Audio('assets/sounds/wrong.wav'),
  voice_pak:   new Audio('assets/sounds/Yah1.wav'),
  voice_tan:   new Audio('assets/sounds/Yah2.wav'),
  voice_bon:   new Audio('assets/sounds/Yah3.wav'),
  voice_punch: new Audio('assets/sounds/Yah4.wav'),
  music: new Audio('assets/sounds/Digital Mosaic.mp3')
};
SFX.music.loop = true; SFX.music.volume = 0.5;
SFX.voice_pak.volume=0.8; SFX.voice_tan.volume=0.8; SFX.voice_bon.volume=0.8; SFX.voice_punch.volume=0.8;

/* --- pool --- */
const POOL={};
function poolify(key,a,n=4){const v=a.volume;const clones=Array.from({length:n-1},()=>{const c=a.cloneNode();c.volume=v;return c});POOL[key]=[a,...clones]}
function playKey(key){ if(muted) return; const arr=POOL[key]; if(!arr) return; let s=arr.find(x=>x.paused); if(!s){const t=arr[0]; s=t.cloneNode(); s.volume=t.volume; if(arr.length<6) arr.push(s);} try{s.currentTime=0; s.play().catch(()=>{})}catch{} }
;['pak','tan','bon','punch','wrong','voice_pak','voice_tan','voice_bon','voice_punch','music'].forEach(k=>SFX[k]&&poolify(k,SFX[k]));
Object.values(SFX).forEach(a=>a.preload='auto');
let muted=false; muteBtn.onclick=()=>{ muted=!muted; muteBtn.textContent=muted?'üîá Muet':'üîä Son'; if(muted) SFX.music.pause(); else SFX.music.play().catch(()=>{}); };
function playTechniqueSounds(tech){ playKey(tech); }

/* ===== BG assets ===== */
function loadBG(url){ const i=new Image(); i.crossOrigin='anonymous'; i.onerror=()=>{}; i.src=url; return i; }
const SKY    = loadBG('https://i.imgur.com/QW70yEx.png');   // ciel
const MT_FAR = loadBG('https://i.imgur.com/I4gOsXm.png');   // montagnes lointaines
const MT_NEAR= loadBG('https://i.imgur.com/bQDYgSH.png');   // montagnes proches
const ALLEY  = loadBG('https://i.imgur.com/hVGwPdp.png');   // all√©e

/* ===== Sprites & skins ===== */
function load(url){ const img=new Image(); img.crossOrigin='anonymous'; img.src=url; return img; }
const SKINS = [
  { id:'classic', name:'Classique', thumb:'https://i.imgur.com/AweXMem.png',
    f:{ pak:'https://i.imgur.com/AweXMem.png', tan:'https://i.imgur.com/ZrLk97U.png', bon:'https://i.imgur.com/CG30Yh6.png', punch:'https://i.imgur.com/JYL2S46.png' } },
  { id:'classic_alt', name:'Classique (alt)', thumb:'https://i.imgur.com/ZrLk97U.png',
    f:{ pak:'https://i.imgur.com/AweXMem.png', tan:'https://i.imgur.com/ZrLk97U.png', bon:'https://i.imgur.com/CG30Yh6.png', punch:'https://i.imgur.com/JYL2S46.png' } }
];
const IMG={
  f_pak:null, f_tan:null, f_bon:null, f_punch:null,
  o_pak:   load('https://i.imgur.com/pVF4bt1.png'),
  o_tan:   load('https://i.imgur.com/2Tmv5aC.png'),
  o_bon:   load('https://i.imgur.com/TNvTSXc.png'),
  o_punch: load('https://i.imgur.com/p0nSWkS.png'),
  d_unique: load('https://i.imgur.com/LwBpPL3.png')
};
let activeSkinIdx = +localStorage.getItem('wcs_skin_idx') || 0;
function applySkin(idx){
  const s=SKINS[idx]||SKINS[0]; activeSkinIdx=idx;
  IMG.f_pak=load(s.f.pak); IMG.f_tan=load(s.f.tan); IMG.f_bon=load(s.f.bon); IMG.f_punch=load(s.f.punch);
  localStorage.setItem('wcs_skin_idx', idx);
  currentFighter = IMG['f_'+currentTech] || IMG.f_pak;
}

/* ===== Profils & stockage =====
   v7: onomatop√©es par technique (onoByTech)
   Toutes les tailles/positions sont en % d‚Äô√©cran ‚Üí rendu proportionnel.
*/
const STORAGE_KEY='wcs_tune_v7';
const TUNE_VERSION=7;

const DEFAULT_PROFILE_PC = {
  ratio: PC_RATIO,
  layers:{
    // wPct/hPct = fraction de la largeur/hauteur de l‚Äô√©cran pour UNE tuile
    sky:  { wPct:1.00, hPct:0.40, offsetXPct:0.00, yOffsetPct:-0.30, speedX:0.00 },
    far:  { wPct:0.94, hPct:0.94, offsetXPct:0.00, bottomPct:0.108,  speedX:0.05 },
    near: { wPct:1.00, hPct:1.00, offsetXPct:(49/1536), bottomPct:0.176, speedX:0.20 },
    alley:{ wPct:1.07, hPct:1.14, offsetXPct:0.00, bottomPct:0.017,  speedX:0.00 }
  },
  fighter:{ wPct:0.165, centerX:0.51, bottomPct:0.09 },
  dummy:{   wPct:0.186, centerX:0.50, bottomPct:0.083 },
  onoByTech: {
    pak:{ xPct:0.50, yPct:0.30, hPct:0.31, rotDeg:0 },
    tan:{ xPct:0.50, yPct:0.30, hPct:0.31, rotDeg:0 },
    bon:{ xPct:0.50, yPct:0.30, hPct:0.31, rotDeg:0 },
    punch:{ xPct:0.50, yPct:0.30, hPct:0.31, rotDeg:0 }
  }
};
const DEFAULT_PROFILE_MOBILE = JSON.parse(JSON.stringify(DEFAULT_PROFILE_PC));
DEFAULT_PROFILE_MOBILE.ratio = MB_RATIO;

function deepClone(o){return JSON.parse(JSON.stringify(o));}

/* Charger + migration v6 -> v7 */
let CFG;
(function loadConfig(){
  try{
    const stored=JSON.parse(localStorage.getItem(STORAGE_KEY)||'null');
    if(stored && stored.version===TUNE_VERSION){ CFG=stored; return; }
  }catch{}
  // migrer depuis v6 (ono unique -> par tech identique)
  let old=null;
  try{ old = JSON.parse(localStorage.getItem('wcs_tune_v6')||'null'); }catch{}
  if(old && old.profiles){
    const clone = prof=>{
      const p=deepClone(prof);
      // scaleX/scaleY de l‚Äôancienne version => interpr√©t√©s comme wPct/hPct
      for(const k of ['sky','far','near','alley']){
        const L=p.layers[k];
        if(L && (L.scaleX!==undefined || L.scaleY!==undefined)){
          L.wPct = (L.wPct!==undefined)?L.wPct:(L.scaleX??1);
          L.hPct = (L.hPct!==undefined)?L.hPct:(L.scaleY??1);
          delete L.scaleX; delete L.scaleY;
        }
      }
      if(p.ono && !p.onoByTech){
        p.onoByTech = { pak:deepClone(p.ono), tan:deepClone(p.ono), bon:deepClone(p.ono), punch:deepClone(p.ono) };
        delete p.ono;
      }
      return p;
    };
    CFG = {
      version:TUNE_VERSION,
      editingProfile: old.editingProfile||'pc',
      previewLock:true,
      profiles:{ pc:clone(old.profiles.pc||DEFAULT_PROFILE_PC),
                 mobile:clone(old.profiles.mobile||old.profiles.pc||DEFAULT_PROFILE_MOBILE) },
      fighterDxPxByTech: old.fighterDxPxByTech||{pak:-110,tan:110,bon:-110,punch:110}
    };
  } else {
    CFG = { version:TUNE_VERSION, editingProfile:'pc', previewLock:true,
      profiles:{ pc:deepClone(DEFAULT_PROFILE_PC), mobile:deepClone(DEFAULT_PROFILE_MOBILE) },
      fighterDxPxByTech:{pak:-110,tan:110,bon:-110,punch:110}
    };
  }
  localStorage.setItem(STORAGE_KEY, JSON.stringify(CFG));
})();
function saveCFG(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(CFG)); }

/* Profil affich√© vs runtime */
const runtimeProfileName = ()=> (innerHeight>innerWidth ? 'mobile' : 'pc');
const viewingProfileName = ()=> (CFG.previewLock ? CFG.editingProfile : runtimeProfileName());
const P = ()=> CFG.profiles[viewingProfileName()];

/* ===== Canvas / Resize ===== */
let DPR=1, W=0, H=0;
let last = performance.now();

function resize(){
  const r = P().ratio || PC_RATIO;
  const wrapW=stageWrap.clientWidth, wrapH=stageWrap.clientHeight;
  let boxW=wrapW, boxH=Math.round(wrapW / r);
  if(boxH>wrapH){ boxH=wrapH; boxW=Math.round(wrapH * r); }

  DPR = Math.max(1, Math.min(2, window.devicePixelRatio||1));
  cx.width = Math.round(boxW * DPR);
  cx.height= Math.round(boxH * DPR);
  cx.style.width=boxW+'px'; cx.style.height=boxH+'px';
  stage.style.width=boxW+'px'; stage.style.height=boxH+'px';

  ctx.setTransform(DPR,0,0,DPR,0,0);
  W=boxW; H=boxH;
  applyOnoStyle(); // garder l‚Äôaper√ßu propre au resize
}
addEventListener('resize', resize);
addEventListener('orientationchange', resize);

/* ===== D√©cor ===== */
function drawSky(){
  const img=SKY, L=P().layers.sky;
  if(img.complete && img.naturalWidth){
    const w=W*L.wPct, h=H*L.hPct;
    const dx=(W-w)/2 + (L.offsetXPct*W);
    const dy=(H-h)/2 + (L.yOffsetPct*H);
    ctx.drawImage(img, dx, dy, w, h);
  } else {
    const g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#0a0c12'); g.addColorStop(1,'#1a1f2a');
    ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  }
}
function tileScaledBottom(img, startOffsetXPct, wPct, hPct, bottomPct){
  if(!img.complete || !img.naturalWidth) return;
  const tileW = Math.max(1, W * wPct);
  const tileH = Math.max(1, H * hPct);
  const y = Math.round(H - tileH - (H*(bottomPct||0)));
  let x=((startOffsetXPct*W) % tileW); if(x>0) x-=tileW;
  for(; x<W; x+=tileW) ctx.drawImage(img, x, y, tileW, tileH);
}

/* Parallaxe (vitesses en √©cran/s) */
let offSky=0, offFar=0, offNear=0, offAlley=0;
function drawBG(dt){
  const L=P().layers;
  const f = (dt/60)*W;
  offSky  -= L.sky.speedX  * f;
  offFar  -= L.far.speedX  * f;
  offNear -= L.near.speedX * f;
  offAlley-= L.alley.speedX* f;

  drawSky();
  tileScaledBottom(MT_FAR,  L.far.offsetXPct  + (offFar/W),  L.far.wPct,  L.far.hPct,  L.far.bottomPct);
  ctx.fillStyle='rgba(0,0,0,.10)'; ctx.fillRect(0,0,W,H);
  tileScaledBottom(MT_NEAR, L.near.offsetXPct + (offNear/W), L.near.wPct, L.near.hPct, L.near.bottomPct);
  tileScaledBottom(ALLEY,   L.alley.offsetXPct+ (offAlley/W),L.alley.wPct,L.alley.hPct,L.alley.bottomPct);
}

/* ===== Mannequin & Perso (proportionnels) ===== */
let dummyAnim={until:0};
function triggerDummyAnim(){ dummyAnim.until=performance.now()+200; }
function drawDummy(){
  const img=IMG.d_unique, D=P().dummy; if(!img || !img.complete || !img.naturalWidth) return;
  let scale=1; if(performance.now()<dummyAnim.until){ const t=1-((dummyAnim.until-performance.now())/200); scale=1+0.05*Math.sin(t*Math.PI); }
  const targetW=Math.max(60, D.wPct*W)*scale;
  const s=targetW/img.naturalWidth, targetH=img.naturalHeight*s;
  const xLeft=Math.round(W*D.centerX - targetW/2);
  const yTop =Math.round(H - targetH - H*(D.bottomPct||0));
  ctx.drawImage(img, xLeft, yTop, targetW, targetH);
}

let currentTech='pak', currentFighter=null;
let actionAnim={until:0,lunge:0,scale:1};
function setSpritesFor(tech){
  currentTech=tech; triggerDummyAnim();
  const now=performance.now();
  const LUNGE={pak:10,tan:12,bon:8,punch:14}; const SCALE={pak:1.03,tan:1.035,bon:1.03,punch:1.04};
  actionAnim={until: now+260, lunge:(LUNGE[tech]||10), scale:(SCALE[tech]||1.03)};
  currentFighter = IMG['f_'+tech] || currentFighter;
  setTimeout(()=> playKey('voice_'+tech), 100);
}
function drawFighter(){
  const img=currentFighter, F=P().fighter; if(!img || !img.complete || !img.naturalWidth) return;
  const baseW=Math.max(60, F.wPct*W), baseScale=baseW/img.naturalWidth, baseH=img.naturalHeight*baseScale;
  const dxTech=(CFG.fighterDxPxByTech && CFG.fighterDxPxByTech[currentTech])||0;
  const now=performance.now(), idleBob=(now>actionAnim.until)?Math.sin(now/420)*3:0;
  let extraX=0, extraY=0, scaleMul=1;
  if(now<actionAnim.until){ const t=1-Math.max(0,(actionAnim.until-now)/260); const ease=1-Math.pow(1-t,3); extraX=actionAnim.lunge*ease; scaleMul=1+(actionAnim.scale-1)*ease; extraY=-2*ease; }
  const centerX=W*(F.centerX||0.5), finalW=baseW*scaleMul, finalH=baseH*scaleMul;
  const xBase=Math.round(centerX - finalW/2 + dxTech + extraX);
  const yBase=Math.round(H - finalH - H*(F.bottomPct||0) + idleBob + extraY);
  ctx.drawImage(img, xBase, yBase, finalW, finalH);
}

/* ===== Onomatop√©es par technique ===== */
let onoSticky=false;
let onoStickyTech='pak'; // s√©lection actuelle (exclusive)

function onoConf(tech){ return P().onoByTech[tech] || P().onoByTech.pak; }

function applyOnoStyle(){
  const O = onoConf(onoStickyTech); // pour l‚Äôaper√ßu collant on prend la tech active
  const left = (O.xPct*100).toFixed(3)+'%';
  const top  = (O.yPct*100).toFixed(3)+'%';
  const hpx  = Math.max(10, O.hPct * H);
  onoImg.style.left = left;
  onoImg.style.top  = top;
  onoImg.style.height = hpx+'px';
  onoImg.style.transform = `translate(-50%,-50%) rotate(${O.rotDeg||0}deg)`;
}
function showOno(tech){
  const img=IMG['o_'+tech]; if(!img) return;
  const O = P().onoByTech[tech] || P().onoByTech.pak;
  onoStickyTech = tech; // pour que l‚Äôaper√ßu colle √† la derni√®re tech jou√©e
  onoImg.src=img.src;
  // appliquer le style de la tech affich√©e
  const left=(O.xPct*100)+'%'; const top=(O.yPct*100)+'%'; const hpx=Math.max(10, O.hPct*H);
  onoImg.style.left=left; onoImg.style.top=top; onoImg.style.height=hpx+'px';
  onoImg.style.transform=`translate(-50%,-50%) rotate(${O.rotDeg||0}deg)`;
  if(!onoSticky){ // animation temporis√©e uniquement si pas en mode collant
    onoImg.classList.remove('onoShow'); void onoImg.offsetWidth; onoImg.classList.add('onoShow');
  } else {
    onoImg.classList.remove('onoShow');
    onoImg.style.opacity='1';
  }
}
function showOnoSticky(){
  const img=IMG['o_'+onoStickyTech]; if(!img) return;
  onoImg.src=img.src;
  applyOnoStyle();
  onoImg.classList.remove('onoShow');
  onoImg.style.opacity='1';
}
function hideOnoSticky(){
  onoImg.style.opacity='0';
  onoImg.classList.remove('onoShow');
}

/* ===== Simon ===== */
let seq=[], userIndex=0, locked=true, score=0, best=+localStorage.getItem('wcs_best')||0;
bestEl.textContent=best;
const TECHS=['pak','tan','bon','punch'];
function setLit(tech,on){ const b=pads.find(x=>x.dataset.tech===tech); if(!b) return; b.classList.toggle('lit',on); }
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
const randTech=()=>TECHS[Math.random()*TECHS.length|0];

async function playSequence(){
  locked=true; await sleep(560);
  for(const tech of seq){
    setSpritesFor(tech); setLit(tech,true); playTechniqueSounds(tech); showOno(tech);
    await sleep(460); setLit(tech,false); await sleep(160);
  }
  locked=false; userIndex=0;
}
async function press(tech){
  if(locked) return;
  setSpritesFor(tech); setLit(tech,true); playTechniqueSounds(tech); showOno(tech);
  await sleep(200); setLit(tech,false);
  if(tech!==seq[userIndex]){
    playKey('wrong'); flash.classList.remove('boom'); void flash.offsetWidth; flash.classList.add('boom');
    seq=[]; score=0; scoreEl.textContent=0; locked=true; await sleep(600); startGame(); return;
  }
  userIndex++;
  if(userIndex===seq.length){
    score++; scoreEl.textContent=score;
    if(score>best){ best=score; bestEl.textContent=best; localStorage.setItem('wcs_best',best); }
    seq.push(randTech()); await sleep(420); playSequence();
  }
}

/* ===== Entr√©es ===== */
pads.forEach(b=>{
  b.addEventListener('pointerdown',e=>{ e.preventDefault(); press(b.dataset.tech); }, {passive:false});
});
function startGame(){
  menu.style.display='none';
  if(!muted) SFX.music.play().catch(()=>{});
  seq=[randTech()]; score=0; scoreEl.textContent=0; playSequence();
}
startBtn.addEventListener('pointerdown',e=>{e.preventDefault();startGame();},{passive:false});
startBtn.addEventListener('click',e=>{e.preventDefault();startGame();});

/* ===== Skins ===== */
applySkin(activeSkinIdx);
skinsBtn.onclick=()=>{ const show=skinsPanel.style.display!=='block'; skinsPanel.style.display=show?'block':'none'; if(show) renderSkins(); };
function renderSkins(){
  skinsGrid.innerHTML=''; SKINS.forEach((s,i)=>{ const card=document.createElement('button');
    card.className='skinCard'+(i===activeSkinIdx?' skinActive':''); card.innerHTML=`<img class="skinThumb" alt="${s.name}" src="${s.thumb}"/><div style="font-weight:700">${s.name}</div>`;
    card.onclick=()=>{applySkin(i); renderSkins();}; skinsGrid.appendChild(card);
  });
}

/* ===== Boucle ===== */
function loop(t = performance.now()){
  const dt = Math.min(33, t - last) / (1000/60);
  last = t;
  ctx.clearRect(0,0,W,H);
  drawBG(dt); drawDummy(); drawFighter();
  requestAnimationFrame(loop);
}

/* ===== Panneau (T) ===== */
let onoPreviewBtn=null;
function addRange(parent,label,obj,key,{min,max,step=0.01,after}){
  const row=document.createElement('div'); row.className='row';
  const lab=document.createElement('div'); lab.textContent=label; row.appendChild(lab);
  const r=document.createElement('input'); r.type='range'; r.min=min; r.max=max; r.step=step; r.value=obj[key];
  const n=document.createElement('input'); n.type='number'; n.step=step; n.value=obj[key]; n.min=min; n.max=max;
  function sync(v){ v=+v; obj[key]=v; r.value=v; n.value=v; saveCFG(); if(after) after(); }
  r.oninput=e=>sync(e.target.value); n.oninput=e=>sync(e.target.value);
  row.append(r,n); parent.appendChild(row);
}
function section(t){ const h=document.createElement('h3'); h.textContent=t; devPanel.appendChild(h); }
function sep(){ const d=document.createElement('div'); d.className='sep'; devPanel.appendChild(d); }
function header(){ const h=document.createElement('h2'); h.textContent='R√©glages Parallax (T pour fermer)'; devPanel.appendChild(h); }
function bar(){
  const wrap=document.createElement('div'); wrap.className='bar';
  const reset=document.createElement('button'); reset.textContent='R√©initialiser';
  const copy=document.createElement('button');  copy.textContent='Copier JSON';
  const paste=document.createElement('button'); paste.textContent='Coller JSON';
  const testOno=document.createElement('button'); testOno.textContent='Tester onomatop√©e';
  const seg=document.createElement('div'); seg.className='seg';
  const pcBtn=document.createElement('button'); const mbBtn=document.createElement('button'); const lock=document.createElement('button');
  pcBtn.textContent='√âditer: PC (4:3)'; mbBtn.textContent='√âditer: Mobile (9:16)';
  lock.textContent = (CFG.previewLock?'Aper√ßu = Profil √©dit√©':'Aper√ßu auto');
  function mark(){ pcBtn.classList.toggle('active', CFG.editingProfile==='pc'); mbBtn.classList.toggle('active', CFG.editingProfile==='mobile'); }
  pcBtn.onclick=()=>{ CFG.editingProfile='pc'; saveCFG(); mark(); lock.textContent=(CFG.previewLock?'Aper√ßu = Profil √©dit√©':'Aper√ßu auto'); buildDevPanel(); resize(); };
  mbBtn.onclick=()=>{ CFG.editingProfile='mobile'; saveCFG(); mark(); lock.textContent=(CFG.previewLock?'Aper√ßu = Profil √©dit√©':'Aper√ßu auto'); buildDevPanel(); resize(); };
  lock.onclick=()=>{ CFG.previewLock=!CFG.previewLock; saveCFG(); lock.textContent=(CFG.previewLock?'Aper√ßu = Profil √©dit√©':'Aper√ßu auto'); resize(); };
  mark(); seg.append(pcBtn,mbBtn);

  reset.onclick=()=>{ CFG.profiles.pc=deepClone(DEFAULT_PROFILE_PC); CFG.profiles.mobile=deepClone(DEFAULT_PROFILE_MOBILE); saveCFG(); buildDevPanel(); resize(); };
  copy.onclick =()=>{ navigator.clipboard.writeText(JSON.stringify(CFG,null,2)).catch(()=>{}); };
  paste.onclick=()=>{ const raw=prompt('Colle la config JSON:'); if(!raw) return; try{ const o=JSON.parse(raw); Object.assign(CFG,o); saveCFG(); buildDevPanel(); resize(); }catch{ alert('JSON invalide'); } };
  testOno.onclick=()=>{ showOno(onoStickyTech); };

  wrap.append(reset,copy,paste,testOno,seg,lock); devPanel.appendChild(wrap);

  const hint=document.createElement('div'); hint.className='hint';
  const activeView = viewingProfileName()==='pc'?'PC (4:3)':'Mobile (9:16)';
  const activeRuntime = runtimeProfileName()==='pc'?'PC (4:3)':'Mobile (9:16)';
  hint.textContent='Profil en jeu (auto): '+activeRuntime+' ‚Ä¢ Profil affich√©: '+activeView;
  devPanel.appendChild(hint);
}
function buildDevPanel(){
  devPanel.innerHTML=''; header(); bar(); sep();
  const E = CFG.profiles[CFG.editingProfile];
  const editLayers = E.layers;

  function R(sectionTitle, key){
    section(sectionTitle);
    // Interpr√©tation en % d‚Äô√©cran (proportionnel)
    addRange(devPanel,'Largeur tuile % √©cran', editLayers[key],'wPct',{min:0.2,max:3,step:0.01});
    addRange(devPanel,'Hauteur tuile % √©cran', editLayers[key],'hPct',{min:0.2,max:3,step:0.01});
    addRange(devPanel,'Position X %', editLayers[key],'offsetXPct',{min:-3,max:3,step:0.001});
    if(key==='sky'){
      addRange(devPanel,'D√©calage Y %', editLayers[key],'yOffsetPct',{min:-0.8,max:0.8,step:0.001});
    } else {
      addRange(devPanel,'Bas %', editLayers[key],'bottomPct',{min:-0.2,max:0.8,step:0.001});
    }
    addRange(devPanel,'Vitesse X (√©cran/s)', editLayers[key],'speedX',{min:-3,max:3,step:0.01});
    sep();
  }
  R('Ciel','sky'); R('Montagnes lointaines','far'); R('Montagnes proches','near'); R('All√©e','alley');

  section('Mannequin');
  addRange(devPanel,'Largeur % √©cran',E.dummy,'wPct',{min:0.05,max:0.6,step:0.001});
  addRange(devPanel,'Centre X %',E.dummy,'centerX',{min:0,max:1,step:0.001});
  addRange(devPanel,'Bas %',E.dummy,'bottomPct',{min:-0.1,max:0.4,step:0.001});
  sep();

  section('Personnage');
  addRange(devPanel,'Largeur % √©cran',E.fighter,'wPct',{min:0.05,max:0.6,step:0.001});
  addRange(devPanel,'Centre X %',E.fighter,'centerX',{min:0,max:1,step:0.001});
  addRange(devPanel,'Bas %',E.fighter,'bottomPct',{min:-0.1,max:0.4,step:0.001});
  sep();

  /* Onomatop√©es par technique, s√©lection EXCLUSIVE + aper√ßu collant */
  section('Onomatop√©es (par technique)');

  const onoBar=document.createElement('div');
  onoBar.className='bar';

  // Aper√ßu ON/OFF
  onoPreviewBtn=document.createElement('button');
  function refreshPreviewBtn(){ onoPreviewBtn.textContent='Aper√ßu ON: '+(onoSticky?'ON':'OFF'); }
  onoPreviewBtn.onclick=()=>{ onoSticky=!onoSticky; if(onoSticky) showOnoSticky(); else hideOnoSticky(); refreshPreviewBtn(); };
  refreshPreviewBtn();
  onoBar.appendChild(onoPreviewBtn);

  // S√©lecteur exclusif
  const seg=document.createElement('div'); seg.className='seg';
  const btns=[];
  ['pak','tan','bon','punch'].forEach(k=>{
    const b=document.createElement('button');
    b.textContent=k; b.dataset.tech=k;
    function mark(){ b.classList.toggle('active', onoStickyTech===k); }
    b.onclick=()=>{ onoStickyTech=k; btns.forEach(x=>x.classList.toggle('active', x.dataset.tech===k)); if(onoSticky) showOnoSticky(); buildOnoSliders(); };
    btns.push(b); seg.appendChild(b); mark();
  });
  // Activer visuel d‚Äô√©tat
  btns.forEach(b=> b.classList.toggle('active', b.dataset.tech===onoStickyTech));
  onoBar.appendChild(seg);
  devPanel.appendChild(onoBar);

  // Sliders sp√©cifiques √† la technique s√©lectionn√©e
  const onoSlidersWrap=document.createElement('div'); devPanel.appendChild(onoSlidersWrap);
  function buildOnoSliders(){
    onoSlidersWrap.innerHTML='';
    const O = E.onoByTech[onoStickyTech];
    const refresh=()=>{ applyOnoStyle(); if(onoSticky) showOnoSticky(); };
    addRange(onoSlidersWrap,'Pos X % √©cran',O,'xPct',{min:0,max:1,step:0.001,after:refresh});
    addRange(onoSlidersWrap,'Pos Y % √©cran',O,'yPct',{min:0,max:1,step:0.001,after:refresh});
    addRange(onoSlidersWrap,'Hauteur % √©cran',O,'hPct',{min:0.05,max:0.8,step:0.001,after:refresh});
    addRange(onoSlidersWrap,'Rotation (deg)',O,'rotDeg',{min:-180,max:180,step:1,after:refresh});
  }
  buildOnoSliders();

  devPanel.style.display='block';
}
addEventListener('keydown',e=>{
  const k = (e.key||'').toLowerCase();
  if(k==='t'){
    const show = devPanel.style.display!=='block';
    if(show){ buildDevPanel(); resize(); applyOnoStyle(); } 
    devPanel.style.display = show?'block':'none';
  }
});

/* ===== Init ===== */
resize();
applySkin(activeSkinIdx);
applyOnoStyle();
let best=+localStorage.getItem('wcs_best')||0; bestEl.textContent=best;
requestAnimationFrame(loop);
</script>
</body>
</html>
