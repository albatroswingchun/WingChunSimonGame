<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Wing Chun - Simon Game</title>
<link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">
<style>
  :root{
    --panel:#1c1715;--panel2:#241d1b;--ink:#e8d6b8;
    --red:#d34b43;--blue:#3d74d6;--green:#4cb36c;--gold:#d1a341;
  }
  html,body{margin:0;height:100%;background:#0b0a0a;color:#eee;font-family:system-ui,Segoe UI,Roboto,Arial;overflow:hidden}
  #app{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr auto}
  header{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:8px 12px;background:linear-gradient(180deg,var(--panel),var(--panel2));border-bottom:1px solid #2a2322;z-index:20}
  .chip{padding:6px 10px;border-radius:9px;background:#2a2422;border:1px solid #3a302d}
  .btn{background:#1e1b1a;border:1px solid #3a302d;color:#e8d6b8;border-radius:10px;padding:10px 16px;cursor:pointer;font-weight:700}
  .btn:hover{filter:brightness(1.08)}
  footer{padding:6px 12px;font-size:12px;opacity:.6;text-align:center;background:linear-gradient(180deg,var(--panel2),#120f0f);z-index:5}

  /* Container plein √©cran qui centre la sc√®ne "bo√Æte" */
  #stageWrap{position:relative;display:grid;place-items:center;overflow:hidden;background:#000}
  /* La sc√®ne garde un ratio fixe; taille contr√¥l√©e en JS pour √©viter l'√©crasement */
  #stage{position:relative}
  canvas{position:absolute;left:0;top:0;touch-action:none;image-rendering:pixelated;image-rendering:crisp-edges}

  #board{position:absolute;left:50%;bottom:18px;transform:translateX(-50%);display:flex;gap:14px;z-index:10}
  .pad{width:132px;height:100px;border-radius:14px;background:linear-gradient(#2a2a2a,#1e1e1e);color:#cfcfcf;display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:inset 0 0 0 2px #000,0 6px 22px rgba(0,0,0,.45);cursor:pointer;user-select:none}
  .lit{filter:brightness(1.7);box-shadow:inset 0 0 0 2px #fff3,0 0 42px currentColor}

  #onoImg{position:absolute;left:50%;top:30%;transform:translate(-50%,0);width:auto;height:360px;opacity:0;pointer-events:none;z-index:11}
  .onoShow{animation:onoFade .9s ease forwards}
  @keyframes onoFade{0%{opacity:0;transform:translate(-50%,0) scale(.9)}20%{opacity:1;transform:translate(-50%,0) scale(1)}80%{opacity:1}100%{opacity:0}}
  #flash{position:absolute;inset:0;background:#ff000022;opacity:0;pointer-events:none;z-index:12}
  .boom{animation:boom .4s ease}@keyframes boom{0%{opacity:.65}100%{opacity:0}}

  #menu{position:absolute;inset:0;display:grid;place-items:center;background:transparent;z-index:15}
  .panel{background:rgba(0,0,0,.55);border-radius:16px;padding:28px 24px;text-align:center;border:1px solid #2f2724;min-width:560px}
  .title-main{font-family:'Permanent Marker',cursive;font-size:96px;line-height:0.9;margin:0;color:#e8d6b8;text-shadow:0 2px 0 #000,0 0 24px rgba(209,163,65,.35)}
  .title-sub{font-size:32px;margin:6px 0 12px;color:#d1a341}
  .subtitle{opacity:.95;margin:0 0 16px}
  .actions{display:flex;gap:12px;justify-content:center}

  #skinsPanel{margin-top:14px;background:#1118;border:1px solid #2f2724;border-radius:12px;padding:14px;display:none}
  #skinsGrid{display:grid;grid-template-columns:repeat(2, minmax(160px,1fr));gap:12px}
  .skinCard{background:#1a1716;border:1px solid #3a302d;border-radius:10px;padding:10px;cursor:pointer;text-align:center}
  .skinCard:hover{filter:brightness(1.05)}
  .skinActive{outline:2px solid #d1a341}
  .skinThumb{display:block;margin:0 auto 8px;height:96px;width:auto;image-rendering:pixelated}

  /* Panneau r√©glages (T) */
  #devPanel{
    position:fixed; top:68px; right:12px; width:360px; max-height:85vh; overflow:auto;
    background:#111c; backdrop-filter: blur(6px); border:1px solid #2f2724; border-radius:12px; z-index:30;
    padding:12px; display:none;
  }
  #devPanel h2{margin:0 0 6px; font-size:18px}
  #devPanel h3{margin:12px 0 6px; font-size:15px; color:#ffd48a}
  #devPanel .row{display:grid; grid-template-columns:120px 1fr 56px; align-items:center; gap:6px; margin:6px 0}
  #devPanel .row input[type="range"]{width:100%}
  #devPanel .row input[type="number"]{width:56px; background:#1b1716; color:#e8d6b8; border:1px solid #3a302d; border-radius:6px; padding:6px}
  #devPanel .bar{display:flex; gap:8px; margin:8px 0 4px}
  #devPanel .bar button{flex:1; padding:8px 10px; border-radius:8px; border:1px solid #3a302d; background:#1e1b1a; color:#e8d6b8; cursor:pointer}
  .sep{margin:10px 0; height:1px; background:#2a2322}
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="left">
      <strong>Wing Chun Simon</strong>
      <span class="chip">Score: <span id="score">0</span></span>
      <span class="chip">Meilleur: <span id="best">0</span></span>
    </div>
    <div class="right"><span class="chip">T: R√©glages</span></div>
  </header>

  <div id="stageWrap">
    <div id="stage">
       <canvas id="cx"></canvas>

      <div id="board">
        <button class="pad" data-tech="pak">Pak Sao</button>
        <button class="pad" data-tech="tan">Tan Sao</button>
        <button class="pad" data-tech="bon">Bon Sao</button>
        <button class="pad" data-tech="punch">Punch</button>
      </div>

      <img id="onoImg" alt="Onomatop√©e"/>
      <div id="flash"></div>

      <div id="menu">
        <div class="panel">
          <h1 class="title-main">Wing Chun</h1>
          <div class="title-sub">Simon Game</div>
          <p class="subtitle">Reproduis les techniques dans le bon ordre.</p>
          <div class="actions">
            <button id="startBtn" class="btn">Commencer</button>
            <button id="muteBtn"  class="btn">üîä Son</button>
            <button id="skinsBtn" class="btn">üé® Skins</button>
          </div>

          <div id="skinsPanel">
            <div style="margin-bottom:8px;opacity:.85">Choisis un skin de personnage</div>
            <div id="skinsGrid"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>Ratio 1536√ó1160, net HiDPI. R√©glages par calque + perso + mannequin. T pour ouvrir/fermer.</footer>
</div>

<!-- Panneau de r√©glages -->
<div id="devPanel"></div>

<script>
/* ====== constants ratio fixe ====== */
const BASE_W = 1536, BASE_H = 1160;

/* ====== refs ====== */
const pads=[...document.querySelectorAll('.pad')];
const scoreEl=document.getElementById('score');
const bestEl=document.getElementById('best');
const menu=document.getElementById('menu');
const startBtn=document.getElementById('startBtn');
const muteBtn=document.getElementById('muteBtn');
const skinsBtn=document.getElementById('skinsBtn');
const skinsPanel=document.getElementById('skinsPanel');
const skinsGrid=document.getElementById('skinsGrid');
const onoImg=document.getElementById('onoImg');
const flash=document.getElementById('flash');
const devPanel=document.getElementById('devPanel');

/* ====== sons ====== */
const SFX = {
  pak:   new Audio('assets/sounds/pak.wav'),
  tan:   new Audio('assets/sounds/tan.wav'),
  bon:   new Audio('assets/sounds/bon.wav'),
  punch: new Audio('assets/sounds/punch.wav'),
  wrong: new Audio('assets/sounds/wrong.wav'),
  voice_pak:   new Audio('assets/sounds/Yah1.wav'),
  voice_tan:   new Audio('assets/sounds/Yah2.wav'),
  voice_bon:   new Audio('assets/sounds/Yah3.wav'),
  voice_punch: new Audio('assets/sounds/Yah4.wav'),
  music: new Audio('assets/sounds/Digital Mosaic.mp3')
};
SFX.music.loop = true;
SFX.music.volume = 0.5;
SFX.voice_pak.volume   = 0.8;
SFX.voice_tan.volume   = 0.8;
SFX.voice_bon.volume   = 0.8;
SFX.voice_punch.volume = 0.8;

/* --- pool audio --- */
const POOL = {};
function poolify(key, audio, n = 4){
  const baseVol = audio.volume;
  const clones = Array.from({length: n-1}, ()=>{ const c = audio.cloneNode(); c.volume = baseVol; return c; });
  POOL[key] = [audio, ...clones];
}
function playKey(key){
  if (muted) return;
  const arr = POOL[key]; if (!arr) return;
  let a = arr.find(x => x.paused);
  if (!a) { const t = arr[0]; a = t.cloneNode(); a.volume=t.volume; if (arr.length < 6) arr.push(a); }
  try { a.currentTime=0; a.play().catch(()=>{}); } catch(_) {}
}
;['pak','tan','bon','punch','wrong','voice_pak','voice_tan','voice_bon','voice_punch','music'].forEach(k=>SFX[k]&&poolify(k,SFX[k]));
Object.values(SFX).forEach(a=>a.preload='auto');
let muted=false;
muteBtn.onclick=()=>{ muted=!muted; muteBtn.textContent=muted?'üîá Muet':'üîä Son'; if(muted) SFX.music.pause(); else SFX.music.play().catch(()=>{}); };
function playTechniqueSounds(tech){ playKey(tech); }

/* ====== BG loader (URLs demand√©es) ====== */
function loadBG(url){ const i=new Image(); i.crossOrigin='anonymous'; i.onerror = ()=>{}; i.src=url; return i; }
const SKY    = loadBG('https://i.imgur.com/QW70yEx.png');      // ciel
const MT_FAR = loadBG('https://i.imgur.com/I4gOsXm.png');      // montagnes lointaines
const MT_NEAR= loadBG('https://i.imgur.com/bQDYgSH.png');      // montagnes proches (remplac√©)
const ALLEY  = loadBG('https://i.imgur.com/hVGwPdp.png');      // all√©e

/* ====== sprites & skins ====== */
function load(url){ const img=new Image(); img.crossOrigin='anonymous'; img.src=url; return img; }
const SKINS = [
  { id:'classic', name:'Classique', thumb:'https://i.imgur.com/AweXMem.png',
    f:{ pak:'https://i.imgur.com/AweXMem.png', tan:'https://i.imgur.com/ZrLk97U.png', bon:'https://i.imgur.com/CG30Yh6.png', punch:'https://i.imgur.com/JYL2S46.png' } },
  { id:'classic_alt', name:'Classique (alt)', thumb:'https://i.imgur.com/ZrLk97U.png',
    f:{ pak:'https://i.imgur.com/AweXMem.png', tan:'https://i.imgur.com/ZrLk97U.png', bon:'https://i.imgur.com/CG30Yh6.png', punch:'https://i.imgur.com/JYL2S46.png' } }
];
const IMG={
  f_pak:null, f_tan:null, f_bon:null, f_punch:null,
  o_pak:   load('https://i.imgur.com/pVF4bt1.png'),
  o_tan:   load('https://i.imgur.com/2Tmv5aC.png'),
  o_bon:   load('https://i.imgur.com/TNvTSXc.png'),
  o_punch: load('https://i.imgur.com/p0nSWkS.png'),
  d_unique: load('https://i.imgur.com/LwBpPL3.png')
};

/* ====== canvas & ratio safe resize (z√©ro √©crasement) ====== */
const stageWrap=document.getElementById('stageWrap');
const stage=document.getElementById('stage');
const cx=document.getElementById('cx');
const ctx=cx.getContext('2d',{alpha:true}); ctx.imageSmoothingEnabled=false;

let DPR=1, W=BASE_W, H=BASE_H; // coordonn√©es logiques = taille CSS du canvas
function resize(){
  // calcule un scale qui "contient" BASE dans la place dispo sans changer le ratio
  const wrapW = stageWrap.clientWidth;
  const wrapH = stageWrap.clientHeight;
  const scale = Math.min(wrapW/BASE_W, wrapH/BASE_H);

  const cssW = Math.round(BASE_W * scale);
  const cssH = Math.round(BASE_H * scale);

  // buffer interne net en HiDPI
  DPR = Math.max(1, Math.min(2, window.devicePixelRatio||1));
  cx.width  = Math.round(cssW * DPR);
  cx.height = Math.round(cssH * DPR);
  cx.style.width  = cssW+'px';
  cx.style.height = cssH+'px';

  // dimensionne #stage pour tout l'UI (pads, menu)
  stage.style.width  = cssW+'px';
  stage.style.height = cssH+'px';

  // on dessine en coordonn√©es CSS
  ctx.setTransform(DPR,0,0,DPR,0,0);
  W = cssW; H = cssH;
}
window.addEventListener('resize', resize);
window.addEventListener('orientationchange', resize);

/* ====== CONFIG (d√©fauts = ta capture) + m√©moire ====== */
const TUNE_VERSION = 3;  // bump pour forcer nos nouveaux defaults
const DEFAULT_CFG = {
  version: TUNE_VERSION,
  layers: {
    sky:  { scaleX:1.00, scaleY:0.54, offsetX:0,     yOffsetPct:-0.23, speedX:0.00 },
    far:  { scaleX:0.94, scaleY:0.94, offsetX:1641,  bottomPct:0.056,  speedX:0.00 },
    near: { scaleX:0.85, scaleY:0.85, offsetX:-1103, bottomPct:0.159,  speedX:0.00 },
    alley:{ scaleX:1.00, scaleY:1.00, offsetX:0,     bottomPct:0.00,   speedX:0.00 }
  },
  fighter: { wPct:0.16, centerX:0.50, bottomPct:0.08 },
  dummy:   { wPct:0.18, centerX:0.50, bottomPct:0.08 },
  fighterDxPxByTech: { pak:-110, tan:110, bon:-110, punch:110 }
};
function deepClone(o){ return JSON.parse(JSON.stringify(o)); }

let CFG;
try{
  const stored = JSON.parse(localStorage.getItem('wcs_tune_v3')||'null');
  if(!stored || stored.version !== TUNE_VERSION){ CFG = deepClone(DEFAULT_CFG); localStorage.setItem('wcs_tune_v3', JSON.stringify(CFG)); }
  else { CFG = stored; }
}catch{ CFG = deepClone(DEFAULT_CFG); localStorage.setItem('wcs_tune_v3', JSON.stringify(CFG)); }

function saveCFG(){ localStorage.setItem('wcs_tune_v3', JSON.stringify(CFG)); }

/* ====== d√©cor helpers (stretch + position) ====== */
function drawSky(){
  const img = SKY;
  if(img.complete && img.naturalWidth){
    const sX = CFG.layers.sky.scaleX, sY = CFG.layers.sky.scaleY;
    const w  = W * sX, h = H * sY;
    const dx = (W - w)/2 + CFG.layers.sky.offsetX;
    const dy = (H - h)/2 + (CFG.layers.sky.yOffsetPct * H);
    ctx.drawImage(img, dx, dy, w, h);
  } else {
    const g = ctx.createLinearGradient(0, 0, 0, H);
    g.addColorStop(0, '#0a0c12'); g.addColorStop(1, '#1a1f2a');
    ctx.fillStyle = g; ctx.fillRect(0, 0, W, H);
  }
}
function tileScaledBottom(img, startOffsetX, scaleX, scaleY, bottomPct){
  if(!img.complete || !img.naturalWidth) return;
  const targetW = img.naturalWidth * scaleX;
  const targetH = img.naturalHeight * scaleY;
  const y = Math.round(H - targetH - (H * (bottomPct||0)));
  let x = (startOffsetX % targetW); if(x>0) x -= targetW;
  for(; x < W; x += targetW) ctx.drawImage(img, x, y, targetW, targetH);
}

/* ====== parallaxe ====== */
let offSky=0, offFar=0, offNear=0, offAlley=0;
function drawBG(dt){
  offSky  -= CFG.layers.sky.speedX  * dt;
  offFar  -= CFG.layers.far.speedX  * dt;
  offNear -= CFG.layers.near.speedX * dt;
  offAlley-= CFG.layers.alley.speedX* dt;

  const oldX = CFG.layers.sky.offsetX;
  CFG.layers.sky.offsetX = oldX + offSky;
  drawSky();
  CFG.layers.sky.offsetX = oldX;

  tileScaledBottom(MT_FAR,  offFar  + CFG.layers.far.offsetX,  CFG.layers.far.scaleX,  CFG.layers.far.scaleY,  CFG.layers.far.bottomPct);
  ctx.fillStyle='rgba(0,0,0,.10)'; ctx.fillRect(0,0,W,H);
  tileScaledBottom(MT_NEAR, offNear + CFG.layers.near.offsetX, CFG.layers.near.scaleX, CFG.layers.near.scaleY, CFG.layers.near.bottomPct);
  tileScaledBottom(ALLEY,   offAlley+ CFG.layers.alley.offsetX,CFG.layers.alley.scaleX,CFG.layers.alley.scaleY,CFG.layers.alley.bottomPct);
}

/* ====== mannequin ====== */
let dummyAnim={until:0};
function triggerDummyAnim(){ dummyAnim.until=performance.now()+200; }
function drawDummy(){
  const img = IMG.d_unique; if(!img || !img.complete || !img.naturalWidth) return;
  let scale=1;
  if(performance.now()<dummyAnim.until){
    const t=1-((dummyAnim.until-performance.now())/200);
    scale=1+0.05*Math.sin(t*Math.PI);
  }
  const targetW = Math.max(60, CFG.dummy.wPct*W) * scale;
  const s = targetW / img.naturalWidth;
  const targetH = img.naturalHeight * s;
  const xLeft = Math.round(W*CFG.dummy.centerX - targetW/2);
  const yTop  = Math.round(H - targetH - H*(CFG.dummy.bottomPct||0));
  ctx.drawImage(img, xLeft, yTop, targetW, targetH);
}

/* ====== perso ====== */
let currentTech='pak';
let currentFighter=null;
let actionAnim={until:0,lunge:0,scale:1};

function setSpritesFor(tech){
  currentTech = tech;
  triggerDummyAnim();

  const now = performance.now();
  const LUNGE = { pak:10, tan:12, bon:8, punch:14 };
  const SCALE = { pak:1.03, tan:1.035, bon:1.03, punch:1.04 };
  actionAnim = { until: now + 260, lunge: (LUNGE[tech]||10), scale: (SCALE[tech]||1.03) };

  currentFighter = IMG['f_'+tech] || currentFighter;
  setTimeout(()=> playKey('voice_'+tech), 100);
}

function drawFighter(){
  const img = currentFighter; if(!img || !img.complete || !img.naturalWidth) return;
  const baseW = Math.max(60, CFG.fighter.wPct*W);
  const baseScale = baseW / img.naturalWidth;
  const baseH = img.naturalHeight * baseScale;

  const dxTech = (CFG.fighterDxPxByTech && CFG.fighterDxPxByTech[currentTech]) || 0;

  const now = performance.now();
  const idleBob = (now > actionAnim.until) ? Math.sin(now/420)*3 : 0;

  let extraX=0, extraY=0, scaleMul=1;
  if(now < actionAnim.until){
    const t = 1 - Math.max(0,(actionAnim.until - now)/260);
    const ease = 1 - Math.pow(1 - t, 3);
    extraX = actionAnim.lunge * ease;
    scaleMul = 1 + (actionAnim.scale - 1) * ease;
    extraY = -2 * ease;
  }

  const centerX = W * (CFG.fighter.centerX || 0.5);
  const finalW = baseW * scaleMul, finalH = baseH * scaleMul;
  const xBase = Math.round(centerX - finalW/2 + dxTech + extraX);
  const yBase = Math.round(H - finalH - H*(CFG.fighter.bottomPct||0) + idleBob + extraY);

  ctx.drawImage(img, xBase, yBase, finalW, finalH);
}

/* ====== onomatop√©es ====== */
function showOno(tech){
  const img = IMG['o_'+tech];
  if(!img) return;
  onoImg.src = img.src;
  onoImg.classList.remove('onoShow'); void onoImg.offsetWidth; onoImg.classList.add('onoShow');
}

/* ====== Simon ====== */
let seq=[], userIndex=0, locked=true, score=0, best=+localStorage.getItem('wcs_best')||0;
bestEl.textContent=best;
const TECHS=['pak','tan','bon','punch'];
function setLit(tech,on){ const b=pads.find(x=>x.dataset.tech===tech); if(!b) return; b.classList.toggle('lit',on); }
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
const randTech=()=>TECHS[Math.random()*TECHS.length|0];

async function playSequence(){
  locked=true; await sleep(560);
  for(const tech of seq){
    setSpritesFor(tech);
    setLit(tech,true);
    playTechniqueSounds(tech);
    showOno(tech);
    await sleep(460);
    setLit(tech,false);
    await sleep(160);
  }
  locked=false; userIndex=0;
}

async function press(tech){
  if(locked) return;
  setSpritesFor(tech);
  setLit(tech,true);
  playTechniqueSounds(tech);
  showOno(tech);
  await sleep(200); setLit(tech,false);

  if(tech!==seq[userIndex]){
    playKey('wrong');
    flash.classList.remove('boom'); void flash.offsetWidth; flash.classList.add('boom');
    seq=[]; score=0; scoreEl.textContent=0; locked=true; await sleep(600); startGame(); return;
  }
  userIndex++;
  if(userIndex===seq.length){
    score++; scoreEl.textContent=score;
    if(score>best){ best=score; bestEl.textContent=best; localStorage.setItem('wcs_best',best); }
    seq.push(randTech()); await sleep(420); playSequence();
  }
}

/* ====== Entr√©es ====== */
pads.forEach(b=>{
  b.addEventListener('pointerdown',e=>{ e.preventDefault(); press(b.dataset.tech); }, {passive:false});
});

/* ====== D√©marrage ====== */
function startGame(){
  menu.style.display='none';
  if(!muted) SFX.music.play().catch(()=>{});
  seq=[randTech()]; score=0; scoreEl.textContent=0; playSequence();
}
startBtn.addEventListener('pointerdown',e=>{e.preventDefault();startGame();},{passive:false});

/* ====== Skins UI ====== */
let activeSkinIdx = +localStorage.getItem('wcs_skin_idx') || 0;
function applySkin(idx){
  const skin = SKINS[idx] || SKINS[0];
  activeSkinIdx = idx;
  IMG.f_pak   = load(skin.f.pak);
  IMG.f_tan   = load(skin.f.tan);
  IMG.f_bon   = load(skin.f.bon);
  IMG.f_punch = load(skin.f.punch);
  localStorage.setItem('wcs_skin_idx', idx);
  currentFighter = IMG['f_'+currentTech] || IMG.f_pak;
}
function renderSkins(){
  skinsGrid.innerHTML = '';
  SKINS.forEach((s, i)=>{
    const card = document.createElement('button');
    card.className = 'skinCard' + (i===activeSkinIdx?' skinActive':'');
    card.innerHTML = `<img class="skinThumb" alt="${s.name}" src="${s.thumb}"/><div style="font-weight:700">${s.name}</div>`;
    card.onclick = ()=>{ applySkin(i); renderSkins(); };
    skinsGrid.appendChild(card);
  });
}
skinsBtn.onclick=()=>{ const show = skinsPanel.style.display!=='block'; skinsPanel.style.display = show?'block':'none'; if(show) renderSkins(); };

/* ====== Boucle ====== */
let last=performance.now();
function loop(t=performance.now()){
  const dt = Math.min(33, t-last) / (1000/60); last=t;
  ctx.clearRect(0,0,W,H);
  drawBG(dt);
  drawDummy();
  drawFighter();
  requestAnimationFrame(loop);
}

/* ====== Panneau r√©glages (T) ====== */
function addRange(parent, label, obj, key, {min,max,step=0.01}){
  const row=document.createElement('div'); row.className='row';
  const lab=document.createElement('div'); lab.textContent=label; row.appendChild(lab);
  const r=document.createElement('input'); r.type='range'; r.min=min; r.max=max; r.step=step; r.value=obj[key];
  const n=document.createElement('input'); n.type='number'; n.step=step; n.value=obj[key]; n.min=min; n.max=max;
  function sync(v){ v=+v; obj[key]=v; r.value=v; n.value=v; saveCFG(); }
  r.oninput=e=>sync(e.target.value); n.oninput=e=>sync(e.target.value);
  row.append(r,n); parent.appendChild(row);
}
function section(title){ const h=document.createElement('h3'); h.textContent=title; devPanel.appendChild(h); }
function sep(){ const d=document.createElement('div'); d.className='sep'; devPanel.appendChild(d); }
function bar(){
  const wrap=document.createElement('div'); wrap.className='bar';
  const reset=document.createElement('button'); reset.textContent='R√©initialiser';
  const copy=document.createElement('button');  copy.textContent='Copier JSON';
  const paste=document.createElement('button'); paste.textContent='Coller JSON';
  reset.onclick=()=>{ Object.assign(CFG, deepClone(DEFAULT_CFG)); saveCFG(); buildDevPanel(); };
  copy.onclick =()=>{ navigator.clipboard.writeText(JSON.stringify(CFG,null,2)).catch(()=>{}); };
  paste.onclick=()=>{
    const raw=prompt('Colle la config JSON:'); if(!raw) return;
    try{ const o=JSON.parse(raw); Object.assign(CFG,o); saveCFG(); buildDevPanel(); }catch{ alert('JSON invalide'); }
  };
  wrap.append(reset,copy,paste); devPanel.appendChild(wrap);
}
function header(){ const h=document.createElement('h2'); h.textContent='R√©glages Parallax (T pour fermer)'; devPanel.appendChild(h); }

function buildDevPanel(){
  devPanel.innerHTML=''; header(); bar(); sep();

  // Ciel
  section('Ciel');
  addRange(devPanel,'Stretch X',   CFG.layers.sky,'scaleX',{min:0.2,max:3,step:0.01});
  addRange(devPanel,'Stretch Y',   CFG.layers.sky,'scaleY',{min:0.2,max:3,step:0.01});
  addRange(devPanel,'Position X',  CFG.layers.sky,'offsetX',{min:-3000,max:3000,step:1});
  addRange(devPanel,'D√©calage Y %',CFG.layers.sky,'yOffsetPct',{min:-0.8,max:0.8,step:0.001});
  addRange(devPanel,'Vitesse X',   CFG.layers.sky,'speedX',{min:-3,max:3,step:0.01});
  sep();

  // Montagnes lointaines
  section('Montagnes lointaines');
  addRange(devPanel,'Stretch X',   CFG.layers.far,'scaleX',{min:0.2,max:3,step:0.01});
  addRange(devPanel,'Stretch Y',   CFG.layers.far,'scaleY',{min:0.2,max:3,step:0.01});
  addRange(devPanel,'Position X',  CFG.layers.far,'offsetX',{min:-3000,max:3000,step:1});
  addRange(devPanel,'Bas %',       CFG.layers.far,'bottomPct',{min:-0.2,max:0.8,step:0.001});
  addRange(devPanel,'Vitesse X',   CFG.layers.far,'speedX',{min:-3,max:3,step:0.01});
  sep();

  // Montagnes proches
  section('Montagnes proches');
  addRange(devPanel,'Stretch X',   CFG.layers.near,'scaleX',{min:0.2,max:3,step:0.01});
  addRange(devPanel,'Stretch Y',   CFG.layers.near,'scaleY',{min:0.2,max:3,step:0.01});
  addRange(devPanel,'Position X',  CFG.layers.near,'offsetX',{min:-3000,max:3000,step:1});
  addRange(devPanel,'Bas %',       CFG.layers.near,'bottomPct',{min:-0.2,max:0.8,step:0.001});
  addRange(devPanel,'Vitesse X',   CFG.layers.near,'speedX',{min:-3,max:3,step:0.01});
  sep();

  // All√©e
  section('All√©e');
  addRange(devPanel,'Stretch X',   CFG.layers.alley,'scaleX',{min:0.2,max:3,step:0.01});
  addRange(devPanel,'Stretch Y',   CFG.layers.alley,'scaleY',{min:0.2,max:3,step:0.01});
  addRange(devPanel,'Position X',  CFG.layers.alley,'offsetX',{min:-3000,max:3000,step:1});
  addRange(devPanel,'Bas %',       CFG.layers.alley,'bottomPct',{min:-0.2,max:0.4,step:0.001});
  addRange(devPanel,'Vitesse X',   CFG.layers.alley,'speedX',{min:-3,max:3,step:0.01});
  sep();

  // Mannequin
  section('Mannequin');
  addRange(devPanel,'Largeur % √©cran', CFG.dummy,'wPct',     {min:0.05,max:0.6,step:0.001});
  addRange(devPanel,'Centre X %',      CFG.dummy,'centerX',  {min:0.0,max:1.0,step:0.001});
  addRange(devPanel,'Bas %',           CFG.dummy,'bottomPct',{min:-0.1,max:0.4,step:0.001});
  sep();

  // Personnage
  section('Personnage');
  addRange(devPanel,'Largeur % √©cran', CFG.fighter,'wPct',     {min:0.05,max:0.6,step:0.001});
  addRange(devPanel,'Centre X %',      CFG.fighter,'centerX',  {min:0.0,max:1.0,step:0.001});
  addRange(devPanel,'Bas %',           CFG.fighter,'bottomPct',{min:-0.1,max:0.4,step:0.001});

  devPanel.style.display='block';
}

window.addEventListener('keydown',e=>{
  if(e.key.toLowerCase()==='t'){
    devPanel.style.display = devPanel.style.display==='block' ? 'none' : (buildDevPanel(), 'block');
  }
});

/* ====== init ====== */
resize();
applySkin(activeSkinIdx);
requestAnimationFrame(loop);
</script>
</body>
</html>
