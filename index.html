<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Wing Chun - Simon Game</title>
<link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">
<style>
  :root{
    --panel:#1c1715; --panel2:#241d1b; --ink:#e8d6b8; --gold:#d1a341;
    --vh:100svh;           /* hauteur viewport stable */
    --stageW: 0px;         /* width du stage exposÃ©e Ã  CSS */
    --stageH: 0px;         /* height du stage exposÃ©e Ã  CSS */
  }
  @supports (height: 100dvh) { :root{ --vh: 100dvh; } }

  html,body{ margin:0; height:100%; background:#0b0a0a; color:#eee; font-family:system-ui,Segoe UI,Roboto,Arial; overflow:hidden }
  #app{ position:fixed; inset:0; display:grid; grid-template-rows:auto 1fr auto; min-height:var(--vh); }

  header{ display:flex; align-items:center; gap:8px; justify-content:space-between; padding:8px 12px; background:linear-gradient(180deg,var(--panel),var(--panel2)); border-bottom:1px solid #2a2322; z-index:20 }
  .chip{ padding:6px 10px; border-radius:9px; background:#2a2422; border:1px solid #3a302d }
  .btn{ background:#1e1b1a; border:1px solid #3a302d; color:#e8d6b8; border-radius:10px; padding:10px 16px; cursor:pointer; font-weight:700 }
  .btn:hover{ filter:brightness(1.08) }
  footer{ padding:6px 12px; font-size:12px; opacity:.6; text-align:center; background:linear-gradient(180deg,var(--panel2),#120f0f); z-index:5 }

  #stageWrap{ position:relative; display:grid; place-items:center; overflow:hidden; background:#000 }
  #stage{ position:relative }
  canvas{ position:absolute; left:0; top:0; touch-action:none; image-rendering:pixelated; image-rendering:crisp-edges }

  /* HUD Score centrÃ© */
  #hudScore{ position:absolute; left:50%; top:6%; transform:translateX(-50%); text-align:center; z-index:13; pointer-events:none; }
  #hudScore .lbl{ color:var(--gold); font-weight:800; letter-spacing:.5px;
                  font-size: clamp(12px, calc(var(--stageW) * 0.030), 28px); text-shadow:0 2px 0 #000; }
  #hudScore .val{ color:var(--gold); font-weight:900;
                  font-size: clamp(28px, calc(var(--stageW) * 0.070), 96px); line-height:0.9;
                  text-shadow:0 2px 0 #000, 0 0 18px rgba(209,163,65,.45); }

  /* Board + Pads (responsive via --stageW/--stageH) */
  #board{ position:absolute; left:50%; bottom:18px; transform:translateX(-50%); display:flex; gap:clamp(8px, calc(var(--stageW)*0.02), 22px); z-index:10 }
  .pad{
    width: clamp(84px,  calc(var(--stageW)*0.20), 200px);
    height:clamp(64px,  calc(var(--stageH)*0.12), 140px);
    border-radius:14px;
    background:linear-gradient(#2a2a2a,#1e1e1e);
    color:#cfcfcf; display:flex; align-items:center; justify-content:center; font-weight:700;
    box-shadow:inset 0 0 0 2px #000, 0 6px 22px rgba(0,0,0,.45); cursor:pointer; user-select:none;
    font-size:clamp(12px, calc(var(--stageW)*0.035), 24px);
  }
  .lit{ filter:brightness(1.7); box-shadow:inset 0 0 0 2px #fff3,0 0 42px currentColor }

  /* Portrait: grille 2x2, boutons plus petits */
  @media (orientation:portrait){
    #board{
      display:grid;
      grid-template-columns: 1fr 1fr;
      grid-auto-rows: 1fr;
      width: min(92%, calc(var(--stageW) * 0.86));
      bottom: clamp(8px, calc(var(--stageH)*0.03), 28px);
      gap: clamp(8px, calc(var(--stageW)*0.04), 26px);
    }
    .pad{
      width: 100%;
      aspect-ratio: 1.25/1;
      height: auto;
      font-size: clamp(12px, calc(var(--stageW)*0.045), 22px);
    }
  }

  /* OnomatopÃ©es */
  #onoImg{
    position:absolute; left:50%; top:50%;
    width:auto; height:360px; opacity:0; pointer-events:none; z-index:11;
    transform:translate(-50%,-50%);
  }
  .onoShow{ animation:onoFade .9s ease forwards }
  @keyframes onoFade{ 0%{opacity:0}20%{opacity:1}80%{opacity:1}100%{opacity:0} }
  #flash{ position:absolute; inset:0; background:#ff000022; opacity:0; pointer-events:none; z-index:12 }
  .boom{ animation:boom .4s ease } @keyframes boom{ 0%{opacity:.65}100%{opacity:0} }

  /* Menu fluide */
  #menu{ position:absolute; inset:0; display:grid; place-items:center; background:transparent; z-index:15 }
  .panel{
    background:rgba(0,0,0,.55); border-radius:16px; padding: clamp(14px, calc(var(--stageW)*0.05), 28px) clamp(14px, calc(var(--stageW)*0.04), 24px);
    text-align:center; border:1px solid #2f2724;
    width: clamp(240px, calc(var(--stageW)*0.72), 760px);
  }
  .title-main{
    font-family:'Permanent Marker',cursive;
    font-size: clamp(36px, calc(var(--stageW)*0.12), 96px);
    line-height:0.9; margin:0; color:#e8d6b8;
    text-shadow:0 2px 0 #000,0 0 24px rgba(209,163,65,.35);
  }
  .title-sub{ font-size: clamp(16px, calc(var(--stageW)*0.045), 32px); margin:6px 0 12px; color:var(--gold) }
  .subtitle{ opacity:.95; margin:0 0 clamp(8px, calc(var(--stageW)*0.03), 16px) }
  .actions{ display:flex; gap: clamp(6px, calc(var(--stageW)*0.02), 12px); justify-content:center; flex-wrap:wrap }
  .actions .btn{ font-size: clamp(12px, calc(var(--stageW)*0.035), 18px); padding: clamp(8px, calc(var(--stageW)*0.02), 12px) clamp(10px, calc(var(--stageW)*0.03), 16px) }

  #skinsPanel{ margin-top:14px; background:#1118; border:1px solid #2f2724; border-radius:12px; padding:14px; display:none }
  #skinsGrid{ display:grid; grid-template-columns:repeat(2, minmax(160px,1fr)); gap:12px }
  .skinCard{ background:#1a1716; border:1px solid #3a302d; border-radius:10px; padding:10px; cursor:pointer; text-align:center }
  .skinCard:hover{ filter:brightness(1.05) }
  .skinActive{ outline:2px solid var(--gold) }
  .skinThumb{ display:block; margin:0 auto 8px; height:96px; width:auto; image-rendering:pixelated }

  /* Panneau rÃ©glages (T) */
  #devPanel{
    position:fixed; top:68px; right:12px; width:380px; max-height:85vh; overflow:auto;
    background:#111c; backdrop-filter: blur(6px); border:1px solid #2f2724; border-radius:12px; z-index:30;
    padding:12px; display:none;
  }
  #devPanel h2{ margin:0 0 6px; font-size:18px }
  #devPanel h3{ margin:12px 0 6px; font-size:15px; color:#ffd48a }
  #devPanel .row{ display:grid; grid-template-columns:140px 1fr 64px; align-items:center; gap:6px; margin:6px 0 }
  #devPanel .row input[type="range"]{ width:100% }
  #devPanel .row input[type="number"]{ width:64px; background:#1b1716; color:#e8d6b8; border:1px solid #3a302d; border-radius:6px; padding:6px }
  #devPanel .bar{ display:flex; gap:8px; margin:8px 0 4px; flex-wrap:wrap }
  #devPanel .bar button, #devPanel .bar .seg{ padding:8px 10px; border-radius:8px; border:1px solid #3a302d; background:#1e1b1a; color:#e8d6b8; cursor:pointer }
  #devPanel .seg{ display:flex; gap:6px; flex:1; align-items:center; justify-content:space-between }
  #devPanel .seg button{ flex:1; border-radius:6px }
  #devPanel .seg .active{ outline:2px solid var(--gold) }
  .sep{ margin:10px 0; height:1px; background:#2a2322 }
  .hint{ font-size:11px; opacity:.7; margin-top:6px }

  /* Cache: masquer chip score header, garder meilleur si besoin */
  .chip[data-hide]{ display:none }
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="left">
      <strong>Wing Chun Simon</strong>
      <span class="chip" data-hide>Score: <span id="score">0</span></span>
      <span class="chip">Meilleur: <span id="best">0</span></span>
    </div>
    <div class="right"></div>
  </header>

  <button style="position:fixed;top:10px;right:10px;z-index:999;" onclick="toggleDevPanel()">âš™</button>

  <div id="stageWrap">
    <div id="stage">
      <canvas id="cx"></canvas>

      <!-- HUD Score -->
      <div id="hudScore" aria-hidden="true">
        <div class="lbl">Score</div>
        <div class="val" id="scoreBig">0</div>
      </div>

      <div id="board">
        <button class="pad" data-tech="pak">Pak Sao</button>
        <button class="pad" data-tech="tan">Tan Sao</button>
        <button class="pad" data-tech="bon">Bon Sao</button>
        <button class="pad" data-tech="punch">Punch</button>
      </div>

      <img id="onoImg" alt="OnomatopÃ©e"/>
      <div id="flash"></div>

      <div id="menu">
        <div class="panel">
          <h1 class="title-main">Wing Chun</h1>
          <div class="title-sub">Simon Game</div>
          <p class="subtitle">Reproduis les techniques dans le bon ordre.</p>
          <div class="actions">
            <button id="startBtn" class="btn">Commencer</button>
            <button id="muteBtn"  class="btn">ðŸ”Š Son</button>
            <button id="skinsBtn" class="btn">ðŸŽ¨ Skins</button>
          </div>

          <div id="skinsPanel">
            <div style="margin-bottom:8px;opacity:.85">Choisis un skin de personnage</div>
            <div id="skinsGrid"></div>
          </div>

          <div id="appVersion" class="hint" style="margin-top:10px;"></div>
        </div>
      </div>
    </div>
  </div>

  <footer></footer>
</div>

<div id="devPanel"></div>

<script>
/* ===== App / Cache ===== */
const APP_VERSION = 'v2.140';
const ASSET_VERSION = APP_VERSION.replace(/\W+/g,''); // simple buster
const bust = (u)=> u + (u.includes('?')?'&':'?') + 'v=' + ASSET_VERSION;

/* ===== Ratios cibles ===== */
const PC_RATIO = 4/3;      // paysage
const MB_RATIO = 9/16;     // portrait
function isPortrait(){ return window.innerHeight >= window.innerWidth; }
function activeRatio(){ return isPortrait() ? MB_RATIO : PC_RATIO; }

/* ===== Refs ===== */
const pads=[...document.querySelectorAll('.pad')];
const scoreEl=document.getElementById('score');
const scoreBigEl=document.getElementById('scoreBig');
const bestEl=document.getElementById('best');
const menu=document.getElementById('menu');
const startBtn=document.getElementById('startBtn');
const muteBtn=document.getElementById('muteBtn');
const skinsBtn=document.getElementById('skinsBtn');
const skinsPanel=document.getElementById('skinsPanel');
const skinsGrid=document.getElementById('skinsGrid');
const onoImg=document.getElementById('onoImg');
const flash=document.getElementById('flash');
const devPanel=document.getElementById('devPanel');
const stageWrap=document.getElementById('stageWrap');
const stage=document.getElementById('stage');
const cx=document.getElementById('cx');
const ctx=cx.getContext('2d',{alpha:true}); ctx.imageSmoothingEnabled=false;

/* ===== Audio (lazy) ===== */
let SFX=null, muted=false, audioReady=false;
function makeAudio(){
  if(audioReady) return;
  SFX = {
    pak:   new Audio(bust('assets/sounds/pak.wav')),
    tan:   new Audio(bust('assets/sounds/tan.wav')),
    bon:   new Audio(bust('assets/sounds/bon.wav')),
    punch: new Audio(bust('assets/sounds/punch.wav')),
    wrong: new Audio(bust('assets/sounds/wrong.wav')),
    voice_pak:   new Audio(bust('assets/sounds/Yah1.wav')),
    voice_tan:   new Audio(bust('assets/sounds/Yah2.wav')),
    voice_bon:   new Audio(bust('assets/sounds/Yah3.wav')),
    voice_punch: new Audio(bust('assets/sounds/Yah4.wav')),
    music: new Audio(bust('assets/sounds/Digital Mosaic.mp3'))
  };
  SFX.music.loop = true; SFX.music.volume = 0.5;
  SFX.voice_pak.volume=0.8; SFX.voice_tan.volume=0.8; SFX.voice_bon.volume=0.8; SFX.voice_punch.volume=0.8;
  Object.values(SFX).forEach(a=>{ a.preload='none'; a.crossOrigin='anonymous'; });
  audioReady=true;
}
const POOL={};
function poolify(key,a,n=4){const v=a.volume;const clones=Array.from({length:n-1},()=>{const c=a.cloneNode();c.volume=v;return c});POOL[key]=[a,...clones]}
function playKey(key){
  if(muted || !audioReady) return;
  const arr=POOL[key]; if(!arr) return;
  let s=arr.find(x=>x.paused);
  if(!s){const t=arr[0]; s=t.cloneNode(); s.volume=t.volume; if(arr.length<6) arr.push(s);}
  try{s.currentTime=0; s.play().catch(()=>{})}catch{}
}
muteBtn.onclick=()=>{
  if(!audioReady) makeAudioOnce();
  muted=!muted; muteBtn.textContent=muted?'ðŸ”‡ Muet':'ðŸ”Š Son';
  if(muted) SFX.music.pause(); else SFX.music.play().catch(()=>{});
};
function playTechniqueSounds(tech){ playKey(tech); }
function makeAudioOnce(){
  if(audioReady) return;
  makeAudio();
  ;['pak','tan','bon','punch','wrong','voice_pak','voice_tan','voice_bon','voice_punch','music'].forEach(k=>{
    if(SFX[k] && !POOL[k]) poolify(k,SFX[k]);
  });
}

/* ===== BG assets (lazy images + cache bust) ===== */
function loadBG(url){
  const i=new Image(); i.crossOrigin='anonymous'; i.decoding='async'; i.loading='eager'; i.src=bust(url); return i;
}
const SKY    = loadBG('https://i.imgur.com/QW70yEx.png');
const MT_FAR = loadBG('https://i.imgur.com/I4gOsXm.png');
const MT_NEAR= loadBG('https://i.imgur.com/bQDYgSH.png');
const ALLEY  = loadBG('https://i.imgur.com/hVGwPdp.png');

/* ===== Sprites & skins ===== */
function load(url){ const img=new Image(); img.crossOrigin='anonymous'; img.decoding='async'; img.loading='lazy'; img.src=bust(url); return img; }
const SKINS = [
  { id:'classic', name:'Classique', thumb:'https://i.imgur.com/AweXMem.png',
    f:{ pak:'https://i.imgur.com/AweXMem.png', tan:'https://i.imgur.com/ZrLk97U.png', bon:'https://i.imgur.com/CG30Yh6.png', punch:'https://i.imgur.com/JYL2S46.png' } },
  { id:'classic_alt', name:'Classique (alt)', thumb:'https://i.imgur.com/ZrLk97U.png',
    f:{ pak:'https://i.imgur.com/AweXMem.png', tan:'https://i.imgur.com/ZrLk97U.png', bon:'https://i.imgur.com/CG30Yh6.png', punch:'https://i.imgur.com/JYL2S46.png' } }
];
const IMG={
  f_pak:null, f_tan:null, f_bon:null, f_punch:null,
  o_pak:   load('https://i.imgur.com/pVF4bt1.png'),
  o_tan:   load('https://i.imgur.com/2Tmv5aC.png'),
  o_bon:   load('https://i.imgur.com/TNvTSXc.png'),
  o_punch: load('https://i.imgur.com/p0nSWkS.png'),
  d_unique: load('https://i.imgur.com/LwBpPL3.png')
};
let activeSkinIdx = +localStorage.getItem('wcs_skin_idx') || 0;
function applySkin(idx){
  const s=SKINS[idx]||SKINS[0]; activeSkinIdx=idx;
  IMG.f_pak=load(s.f.pak); IMG.f_tan=load(s.f.tan); IMG.f_bon=load(s.f.bon); IMG.f_punch=load(s.f.punch);
  localStorage.setItem('wcs_skin_idx', idx);
  currentFighter = IMG['f_'+currentTech] || IMG.f_pak;
}

/* ===== Profils & stockage (v8) ===== */
const STORAGE_KEY = 'wcs_tune_v8';
const TUNE_VERSION = 8;

/* SEED calibrÃ© (inclut mobile/pc) */
const SEEDED_PROFILES = {
  pc: {
    ratio: 1.3333333333333333,
    layers: {
      sky:  { zoom: 0.5,  offsetXPct: -0.031, yOffsetPct: -0.277, speedX: 0 },
      far:  { wPct: 1,    offsetXPct: -1.372, bottomPct: -0.019,  speedX: 0.004 },
      near: { wPct: 2.99, offsetXPct: 0.528,  bottomPct: 0.225,   speedX: 0.025 },
      alley:{ wPct: 1.2,  offsetXPct: 0,      bottomPct: 0,       speedX: 0 }
    },
    fighter: { wPct: 0.165, centerX: 0.51, bottomPct: 0.09 },
    dummy:   { wPct: 0.186, centerX: 0.5,  bottomPct: 0.083 },
    onoByTech: {
      pak:   { xPct: 0.598, yPct: 0.467, hPct: 0.404, rotDeg:  39 },
      tan:   { xPct: 0.417, yPct: 0.503, hPct: 0.310, rotDeg: -15 },
      bon:   { xPct: 0.593, yPct: 0.497, hPct: 0.382, rotDeg:  19 },
      punch: { xPct: 0.427, yPct: 0.513, hPct: 0.370, rotDeg: -37 }
    }
  },
  mobile: {
    ratio: 0.5625,
    layers: {
      sky:  { zoom: 0.34, offsetXPct: 0.225,  yOffsetPct: -0.35, speedX: 0 },
      far:  { wPct: 1.38, offsetXPct: 0.025,  bottomPct: 0.319,  speedX: 0.011 },
      near: { wPct: 8,    offsetXPct: -1.462, bottomPct: 0.319,  speedX: 0.035 },
      alley:{ wPct: 4,    offsetXPct: 0,      bottomPct: 0,      speedX: 0 }
    },
    fighter: { wPct: 0.437, centerX: 0.51, bottomPct: 0.124 },
    dummy:   { wPct: 0.489, centerX: 0.5,  bottomPct: 0.119 },
    onoByTech: {
      pak:   { xPct: 0.719, yPct: 0.442, hPct: 0.310, rotDeg:  37 },
      tan:   { xPct: 0.332, yPct: 0.422, hPct: 0.310, rotDeg: -26 },
      bon:   { xPct: 0.724, yPct: 0.417, hPct: 0.310, rotDeg:  23 },
      punch: { xPct: 0.332, yPct: 0.397, hPct: 0.310, rotDeg: -44 }
    }
  }
};

function deepClone(o){ return JSON.parse(JSON.stringify(o)); }

/* Charger + migration simple depuis v7 si prÃ©sent */
let CFG;
(function loadConfig(){
  try{
    const stored=JSON.parse(localStorage.getItem(STORAGE_KEY)||'null');
    if(stored && stored.version===TUNE_VERSION){ CFG=stored; }
  }catch{}

  if(!CFG){
    let v7=null;
    try{ v7 = JSON.parse(localStorage.getItem('wcs_tune_v7')||'null'); }catch{}
    if(v7 && v7.profiles){
      CFG = {
        version:TUNE_VERSION, editingProfile:v7.editingProfile||'pc', previewLock:true,
        fighterDxPxByTech:v7.fighterDxPxByTech||{pak:-110,tan:110,bon:-110,punch:110},
        profiles:{
          pc: migrate7to8(v7.profiles.pc) || deepClone(SEEDED_PROFILES.pc),
          mobile: migrate7to8(v7.profiles.mobile||v7.profiles.pc) || deepClone(SEEDED_PROFILES.mobile),
        }
      };
    } else {
      const firstIsPortrait = window.innerHeight >= window.innerWidth;
      CFG = {
        version: TUNE_VERSION,
        previewLock: false,
        editingProfile: firstIsPortrait ? 'mobile' : 'pc',
        profiles: {
          pc: deepClone(SEEDED_PROFILES.pc),
          mobile: deepClone(SEEDED_PROFILES.mobile)
        },
        fighterDxPxByTech:{pak:-110,tan:110,bon:-110,punch:110}
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(CFG));
    }
  }

  if (CFG && typeof CFG.previewLock !== 'boolean') CFG.previewLock = false;
})();

/* ===== Overrides par technique (nouveau) ===== */
(function ensurePerTechOverrides(){
  const TECHS = ['pak','tan','bon','punch'];
  if (!CFG.fighterPerTech) CFG.fighterPerTech = {};
  TECHS.forEach(k=>{
    CFG.fighterPerTech[k] = Object.assign(
      { dxPx: 0, dyPct: 0, scale: 1, centerX: null, bottomPct: null },
      CFG.fighterPerTech[k] || {}
    );
  });
  saveCFG();
})();

function migrate7to8(p){
  if(!p) return null;
  const out = deepClone(SEEDED_PROFILES.pc);
  out.ratio = p.ratio||PC_RATIO;
  const skyIn = (p.layers&&p.layers.sky)||{};
  out.layers.sky.zoom = (typeof skyIn.zoom==='number')?skyIn.zoom : (typeof skyIn.scaleX==='number'?Math.max(0.2,skyIn.scaleX):1);
  out.layers.sky.offsetXPct = skyIn.offsetXPct||0;
  out.layers.sky.yOffsetPct = skyIn.yOffsetPct||0;
  out.layers.sky.speedX = skyIn.speedX||0;

  ['far','near','alley'].forEach(k=>{
    const s=(p.layers&&p.layers[k])||{};
    out.layers[k].wPct = (typeof s.scaleX==='number') ? Math.max(0.5, s.scaleX) : out.layers[k].wPct;
    out.layers[k].offsetXPct = s.offsetXPct||0;
    out.layers[k].bottomPct  = s.bottomPct ?? out.layers[k].bottomPct;
    out.layers[k].speedX     = s.speedX||0;
  });

  out.fighter = p.fighter || out.fighter;
  out.dummy   = p.dummy   || out.dummy;
  out.onoByTech = (p.onoByTech) ? p.onoByTech
                 : (p.ono ? {pak:p.ono,tan:p.ono,bon:p.ono,punch:p.ono} : deepClone(SEEDED_PROFILES.pc.onoByTech));
  return out;
}
function saveCFG(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(CFG)); }

/* Profil affichÃ© vs runtime */
const runtimeProfileName = ()=> (innerHeight>innerWidth ? 'mobile' : 'pc');
const viewingProfileName = ()=> (CFG.previewLock ? CFG.editingProfile : runtimeProfileName());
const P = ()=> CFG.profiles[viewingProfileName()];

/* ===== Canvas / Resize ===== */
let DPR=1, W=0, H=0;
let last = performance.now();

function resize(){
  const r = activeRatio();
  const wrapW=stageWrap.clientWidth, wrapH=stageWrap.clientHeight;
  let boxW=wrapW, boxH=Math.round(wrapW / r);
  if(boxH>wrapH){ boxH=wrapH; boxW=Math.round(wrapH * r); }

  // Perf mobile: plafonner DPR Ã  1 en portrait pour charger plus vite
  DPR = Math.max(1, Math.min(isPortrait()?1:2, window.devicePixelRatio||1));
  cx.width = Math.round(boxW * DPR);
  cx.height= Math.round(boxH * DPR);
  cx.style.width=boxW+'px'; cx.style.height=boxH+'px';
  stage.style.width=boxW+'px'; stage.style.height=boxH+'px';

  // Exposer au CSS
  document.documentElement.style.setProperty('--stageW', boxW + 'px');
  document.documentElement.style.setProperty('--stageH', boxH + 'px');

  ctx.setTransform(DPR,0,0,DPR,0,0);
  W=boxW; H=boxH;

  if(onoSticky) showOnoSticky();
}
addEventListener('resize', resize, {passive:true});
addEventListener('orientationchange', resize);

/* ===== DÃ©cor ===== */
function drawSkyCover(){
  const img=SKY, L=P().layers.sky;
  if(img.complete && img.naturalWidth){
    const iw=img.naturalWidth, ih=img.naturalHeight;
    const s = Math.max(W/iw, H/ih) * (L.zoom||1);
    const dw = iw*s, dh = ih*s;
    const dx = (W-dw)/2 + (L.offsetXPct||0)*W;
    const dy = (H-dh)/2 + (L.yOffsetPct||0)*H;
    ctx.drawImage(img, dx, dy, dw, dh);
  } else {
    const g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#0a0c12'); g.addColorStop(1,'#1a1f2a');
    ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  }
}
function tileScaledBottom(img, startOffsetXPct, wPct, bottomPct){
  if(!img.complete || !img.naturalWidth) return;
  const targetW = Math.max(1, W * (wPct||1));
  const scale = targetW / img.naturalWidth;
  const targetH = img.naturalHeight * scale;
  const y = Math.round(H - targetH - (H*(bottomPct||0)));
  let x=((startOffsetXPct*W) % targetW); if(x>0) x-=targetW;
  for(; x<W; x+=targetW) ctx.drawImage(img, x, y, targetW, targetH);
}

/* Parallaxe */
let offSky=0, offFar=0, offNear=0, offAlley=0;
function drawBG(dt){
  const L=P().layers;
  const f = (dt/60)*W;
  offSky  -= (L.sky.speedX  ||0) * f;
  offFar  -= (L.far.speedX  ||0) * f;
  offNear -= (L.near.speedX ||0) * f;
  offAlley-= (L.alley.speedX||0) * f;

  drawSkyCover();
  tileScaledBottom(MT_FAR,  (L.far.offsetXPct||0)  + (offFar/W),  L.far.wPct,  L.far.bottomPct);
  ctx.fillStyle='rgba(0,0,0,.10)'; ctx.fillRect(0,0,W,H);
  tileScaledBottom(MT_NEAR, (L.near.offsetXPct||0) + (offNear/W), L.near.wPct, L.near.bottomPct);
  tileScaledBottom(ALLEY,   (L.alley.offsetXPct||0)+ (offAlley/W),L.alley.wPct,L.alley.bottomPct);
}

/* ===== Mannequin & Perso ===== */
let dummyAnim={until:0};
function triggerDummyAnim(){ dummyAnim.until=performance.now()+200; }
function drawDummy(){
  const img=IMG.d_unique, D=P().dummy; if(!img || !img.complete || !img.naturalWidth) return;
  let scale=1; if(performance.now()<dummyAnim.until){ const t=1-((dummyAnim.until-performance.now())/200); scale=1+0.05*Math.sin(t*Math.PI); }
  const targetW=Math.max(60, D.wPct*W)*scale;
  const s=targetW/img.naturalWidth, targetH=img.naturalHeight*s;
  const xLeft=Math.round(W*D.centerX - targetW/2);
  const yTop =Math.round(H - targetH - H*(D.bottomPct||0));
  ctx.drawImage(img, xLeft, yTop, targetW, targetH);
}

let currentTech='pak', currentFighter=null;
let actionAnim={until:0,lunge:0,scale:1};
function setSpritesFor(tech){
  currentTech=tech; triggerDummyAnim();
  const now=performance.now();
  const LUNGE={pak:10,tan:12,bon:8,punch:14}; const SCALE={pak:1.03,tan:1.035,bon:1.03,punch:1.04};
  actionAnim={until: now+260, lunge:(LUNGE[tech]||10), scale:(SCALE[tech]||1.03)};
  currentFighter = IMG['f_'+tech] || currentFighter;
  // voix aprÃ¨s un court dÃ©lai
  setTimeout(()=> playKey('voice_'+tech), 100);
}

/* ===== Rendu fighter avec overrides par technique ===== */
function drawFighter(){
  const img=currentFighter, F=P().fighter; if(!img || !img.complete || !img.naturalWidth) return;

  const ov = (CFG.fighterPerTech && CFG.fighterPerTech[currentTech]) || {};
  const baseScale = (ov.scale && isFinite(ov.scale) && ov.scale>0) ? ov.scale : 1;

  const baseW = Math.max(60, F.wPct*W) * baseScale;

  const now=performance.now();
  const t=1-Math.max(0,(actionAnim.until-now)/260);
  const ease=(now<actionAnim.until)?(1-Math.pow(1-t,3)):0;
  const lunge=(actionAnim.lunge||0)*ease;
  const extraY=-2*ease;

  const finalW=baseW, finalH=img.naturalHeight*(finalW/img.naturalWidth);

  const centerX = (ov.centerX!=null ? ov.centerX : (F.centerX||0.5)) * W;
  const bottomPct = (ov.bottomPct!=null ? ov.bottomPct : (F.bottomPct||0));

  const dxTechOld=(CFG.fighterDxPxByTech && CFG.fighterDxPxByTech[currentTech])||0;
  const dxPxNew = +ov.dxPx || 0;
  const dyPctNew = +ov.dyPct || 0;

  const xBase=Math.round(centerX - finalW/2 + dxTechOld + dxPxNew + lunge);
  const yBase=Math.round(H - finalH - H*(bottomPct + dyPctNew) + Math.sin(now/420)*3 + extraY);

  ctx.drawImage(img, xBase, yBase, finalW, finalH);
}

/* ===== OnomatopÃ©es ===== */
function getOnoFor(tech){
  const prof = P();
  const map = prof.onoByTech || {};
  return map[tech] || {xPct:0.5,yPct:0.3,hPct:0.31,rotDeg:0};
}
function applyOnoStyleFor(tech){
  const O=getOnoFor(tech);
  onoImg.style.left = (O.xPct*100).toFixed(3)+'%';
  onoImg.style.top  = (O.yPct*100).toFixed(3)+'%';
  onoImg.style.height = Math.max(10, O.hPct*H)+'px';
  onoImg.style.transform = `translate(-50%,-50%) rotate(${O.rotDeg||0}deg)`;
}
function showOno(tech){
  const img=IMG['o_'+tech]; if(!img) return;
  onoImg.src=img.src;
  applyOnoStyleFor(tech);
  onoImg.classList.remove('onoShow'); void onoImg.offsetWidth; onoImg.classList.add('onoShow');
}

/* AperÃ§u collant pour rÃ©glages */
let onoSticky = false;
let onoEditTech = 'pak';
function showOnoSticky(){
  const img = IMG['o_'+onoEditTech];
  if(!img) return;
  onoImg.src = img.src;
  applyOnoStyleFor(onoEditTech);
  onoImg.classList.remove('onoShow');
  onoImg.style.opacity = '1';
}
function hideOnoSticky(){
  onoImg.style.opacity = '0';
  onoImg.classList.remove('onoShow');
}

/* ===== Simon ===== */
let seq=[], userIndex=0, locked=true, score=0;
let best=+localStorage.getItem('wcs_best')||0; bestEl.textContent=best;
const TECHS=['pak','tan','bon','punch'];
function setLit(tech,on){ const b=pads.find(x=>x.dataset.tech===tech); if(!b) return; b.classList.toggle('lit',on); }
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
const randTech=()=>TECHS[Math.random()*TECHS.length|0];

async function playSequence(){
  locked=true; await sleep(560);
  for(const tech of seq){
    setSpritesFor(tech); setLit(tech,true); playTechniqueSounds(tech); showOno(tech);
    await sleep(460); setLit(tech,false); await sleep(160);
  }
  locked=false; userIndex=0;
}
async function press(tech){
  if(locked) return;
  setSpritesFor(tech); setLit(tech,true); playTechniqueSounds(tech); showOno(tech);
  await sleep(200); setLit(tech,false);
  if(tech!==seq[userIndex]){
    playKey('wrong'); flash.classList.remove('boom'); void flash.offsetWidth; flash.classList.add('boom');
    seq=[]; score=0; updateScore(0); locked=true; await sleep(600); startGame(); return;
  }
  userIndex++;
  if(userIndex===seq.length){
    score++; updateScore(score);
    if(score>best){ best=score; bestEl.textContent=best; localStorage.setItem('wcs_best',best); }
    seq.push(randTech()); await sleep(420); playSequence();
  }
}
function updateScore(v){
  scoreEl.textContent = v;
  scoreBigEl.textContent = v;
}

/* ===== EntrÃ©es ===== */
pads.forEach(b=>{
  b.addEventListener('pointerdown',e=>{ e.preventDefault(); press(b.dataset.tech); }, {passive:false});
});
function startGame(){
  menu.style.display='none';
  if(!audioReady){ makeAudioOnce(); }
  if(!muted) SFX.music.play().catch(()=>{});
  seq=[randTech()]; score=0; updateScore(0); playSequence();
}
startBtn.addEventListener('pointerdown',e=>{e.preventDefault();startGame();},{passive:false});
startBtn.addEventListener('click',e=>{e.preventDefault();startGame();});

/* ===== Skins ===== */
applySkin(activeSkinIdx);
skinsBtn.onclick=()=>{ const show=skinsPanel.style.display!=='block'; skinsPanel.style.display=show?'block':'none'; if(show) renderSkins(); };
function renderSkins(){
  skinsGrid.innerHTML=''; SKINS.forEach((s,i)=>{ const card=document.createElement('button');
    card.className='skinCard'+(i===activeSkinIdx?' skinActive':''); card.innerHTML=`<img class="skinThumb" alt="${s.name}" src="${bust(s.thumb)}"/><div style="font-weight:700">${s.name}</div>`;
    card.onclick=()=>{applySkin(i); renderSkins();}; skinsGrid.appendChild(card);
  });
}

/* ===== Boucle ===== */
function loop(t = performance.now()){
  const dt = Math.min(33, t - last) / (1000/60);
  last = t;
  ctx.clearRect(0,0,W,H);
  drawBG(dt); drawDummy(); drawFighter();
  requestAnimationFrame(loop);
}

/* ===== Panneau (T) ===== */
function addRange(parent,label,obj,key,{min,max,step=0.01,after}){
  const row=document.createElement('div'); row.className='row';
  const lab=document.createElement('div'); lab.textContent=label; row.appendChild(lab);
  const r=document.createElement('input'); r.type='range'; r.min=min; r.max=max; r.step=step; r.value=(obj[key]??0);
  const n=document.createElement('input'); n.type='number'; n.step=step; n.value=(obj[key]??0); n.min=min; n.max=max;
  function sync(v){ v=+v; obj[key]=v; r.value=v; n.value=v; saveCFG(); if(after) after(); }
  r.oninput=e=>sync(e.target.value); n.oninput=e=>sync(e.target.value);
  row.append(r,n); parent.appendChild(row);
}
function section(t){ const h=document.createElement('h3'); h.textContent=t; devPanel.appendChild(h); }
function sep(){ const d=document.createElement('div'); d.className='sep'; devPanel.appendChild(d); }
function header(){ const h=document.createElement('h2'); h.textContent='RÃ©glages (T pour fermer)'; devPanel.appendChild(h); }
function bar(){
  const wrap=document.createElement('div'); wrap.className='bar';
  const reset=document.createElement('button'); reset.textContent='RÃ©initialiser';
  const copy=document.createElement('button');  copy.textContent='Copier JSON';
  const paste=document.createElement('button'); paste.textContent='Coller JSON';
  const testOno=document.createElement('button'); testOno.textContent='Tester onomatopÃ©e';
  const seg=document.createElement('div'); seg.className='seg';
  const pcBtn=document.createElement('button'); const mbBtn=document.createElement('button'); const lock=document.createElement('button');
  pcBtn.textContent='Ã‰diter: PC (4:3)'; mbBtn.textContent='Ã‰diter: Mobile (9:16)';
  lock.textContent = (CFG.previewLock?'AperÃ§u = Profil Ã©ditÃ©':'AperÃ§u auto');
  function mark(){ pcBtn.classList.toggle('active', CFG.editingProfile==='pc'); mbBtn.classList.toggle('active', CFG.editingProfile==='mobile'); }
  pcBtn.onclick=()=>{ CFG.editingProfile='pc'; saveCFG(); mark(); lock.textContent=(CFG.previewLock?'AperÃ§u = Profil Ã©ditÃ©':'AperÃ§u auto'); buildDevPanel(); resize(); };
  mbBtn.onclick=()=>{ CFG.editingProfile='mobile'; saveCFG(); mark(); lock.textContent=(CFG.previewLock?'AperÃ§u = Profil Ã©ditÃ©':'AperÃ§u auto'); buildDevPanel(); resize(); };
  lock.onclick=()=>{ CFG.previewLock=!CFG.previewLock; saveCFG(); lock.textContent=(CFG.previewLock?'AperÃ§u = Profil Ã©ditÃ©':'AperÃ§u auto'); resize(); };
  mark(); seg.append(pcBtn,mbBtn);

  reset.onclick=()=>{ CFG.profiles.pc=deepClone(SEEDED_PROFILES.pc); CFG.profiles.mobile=deepClone(SEEDED_PROFILES.mobile); saveCFG(); buildDevPanel(); resize(); };
  copy.onclick =()=>{ navigator.clipboard.writeText(JSON.stringify(CFG,null,2)).catch(()=>{}); };
  paste.onclick=()=>{ const raw=prompt('Colle la config JSON:'); if(!raw) return; try{ const o=JSON.parse(raw); Object.assign(CFG,o); saveCFG(); buildDevPanel(); resize(); }catch{ alert('JSON invalide'); } };
  testOno.onclick=()=>{ showOno(currentTech); };

  wrap.append(reset,copy,paste,testOno,seg,lock); devPanel.appendChild(wrap);

  const hint=document.createElement('div'); hint.className='hint';
  const activeView = viewingProfileName()==='pc'?'PC (4:3)':'Mobile (9:16)';
  const activeRuntime = runtimeProfileName()==='pc'?'PC (4:3)':'Mobile (9:16)';
  hint.textContent='Profil en jeu (auto): '+activeRuntime+' â€¢ Profil affichÃ©: '+activeView;
  devPanel.appendChild(hint);
}

function buildDevPanel(){
  devPanel.innerHTML=''; header(); bar(); sep();
  const E = CFG.profiles[CFG.editingProfile];

  /* ==== ZOOMS Ã‰TENDUS SUR MOBILE ==== */
  const isMobileProfile = (CFG.editingProfile === 'mobile');
  const SCALE_RANGE = {
    sky:  { min: isMobileProfile ? 0.02 : 0.50, max: isMobileProfile ? 10.0 : 3.0 },
    far:  { min: isMobileProfile ? 0.05 : 0.50, max: isMobileProfile ?  8.0 : 3.0 },
    near: { min: isMobileProfile ? 0.05 : 0.50, max: isMobileProfile ?  8.0 : 3.0 },
    alley:{ min: isMobileProfile ? 0.20 : 0.50, max: isMobileProfile ?  4.0 : 3.0 }
  };

  /* Ciel */
  section('Ciel');
  addRange(devPanel,'Zoom',E.layers.sky,'zoom',{min:SCALE_RANGE.sky.min,max:SCALE_RANGE.sky.max,step:0.01});
  addRange(devPanel,'DÃ©calage X %',E.layers.sky,'offsetXPct',{min:-3,max:3,step:0.001});
  addRange(devPanel,'DÃ©calage Y %',E.layers.sky,'yOffsetPct',{min:-1,max:1,step:0.001});
  addRange(devPanel,'Vitesse X (Ã©cran/s)',E.layers.sky,'speedX',{min:-3,max:3,step:0.01});
  sep();

  function R(label,key){
    section(label);
    addRange(devPanel,'Largeur Ã— Ã©cran (wPct)',E.layers[key],'wPct',{min:SCALE_RANGE[key].min,max:SCALE_RANGE[key].max,step:0.01});
    addRange(devPanel,'DÃ©calage X %',E.layers[key],'offsetXPct',{min:-3,max:3,step:0.001});
    addRange(devPanel,'Bas %',E.layers[key],'bottomPct',{min:-0.2,max:0.8,step:0.001});
    addRange(devPanel,'Vitesse X (Ã©cran/s)',E.layers[key],'speedX',{min:-3,max:3,step:0.01});
    sep();
  }
  R('Montagnes lointaines','far');
  R('Montagnes proches','near');
  R('AllÃ©e','alley');

  /* Mannequin */
  section('Mannequin');
  addRange(devPanel,'Largeur % Ã©cran',E.dummy,'wPct',{min:0.05,max:0.6,step:0.001});
  addRange(devPanel,'Centre X %',E.dummy,'centerX',{min:0,max:1,step:0.001});
  addRange(devPanel,'Bas %',E.dummy,'bottomPct',{min:-0.1,max:0.4,step:0.001});
  sep();

  /* Personnage (profil global) */
  section('Personnage');
  addRange(devPanel,'Largeur % Ã©cran',E.fighter,'wPct',{min:0.05,max:0.6,step:0.001});
  addRange(devPanel,'Centre X %',E.fighter,'centerX',{min:0,max:1,step:0.001});
  addRange(devPanel,'Bas %',E.fighter,'bottomPct',{min:-0.1,max:0.4,step:0.001});
  sep();

  /* Personnage â€” Overrides par technique */
  section('Personnage â€” Overrides par technique');

  // SÃ©lecteur de technique
  const techWrap=document.createElement('div'); techWrap.className='bar';
  const techSeg=document.createElement('div'); techSeg.className='seg';
  const techs2=['pak','tan','bon','punch']; const btnsTech2=[];
  let editTech = window.__editFighterTech || 'pak';

  techs2.forEach(k=>{
    const b=document.createElement('button'); b.textContent=k.toUpperCase(); b.dataset.tech=k;
    b.onclick=()=>{ editTech=k; window.__editFighterTech=k; btnsTech2.forEach(x=>x.classList.toggle('active', x.dataset.tech===k)); buildDevPanel(); resize(); };
    btnsTech2.push(b); techSeg.appendChild(b);
  });
  btnsTech2.forEach(b=> b.classList.toggle('active', b.dataset.tech===editTech));
  techWrap.appendChild(techSeg);
  devPanel.appendChild(techWrap);

  const OVT = (CFG.fighterPerTech && CFG.fighterPerTech[editTech]) || (CFG.fighterPerTech[editTech]={dxPx:0,dyPct:0,scale:1,centerX:null,bottomPct:null});

  function addSimple(key,label,min,max,step){
    addRange(devPanel,label,OVT,key,{min,max,step,after:()=>{ saveCFG(); resize(); }});
  }
  addSimple('dxPx','DÃ©calage X (px)', -400, 400, 1);
  addSimple('dyPct','DÃ©calage Y (% Ã©cran)', -0.25, 0.25, 0.001);
  addSimple('scale','Ã‰chelle Ã—', 0.5, 2.0, 0.001);

  const nullHint=document.createElement('div'); nullHint.className='hint';
  nullHint.textContent='centerX/bottomPct: laisser vide = utiliser le profil global';
  devPanel.appendChild(nullHint);

  const centerRow=document.createElement('div'); centerRow.className='bar';
  const btnUseCX=document.createElement('button'); btnUseCX.textContent='Override centerX';
  const btnClearCX=document.createElement('button'); btnClearCX.textContent='Annuler override';
  btnUseCX.onclick=()=>{ if(OVT.centerX==null) OVT.centerX=(P().fighter.centerX||0.5); saveCFG(); buildDevPanel(); resize(); };
  btnClearCX.onclick=()=>{ OVT.centerX=null; saveCFG(); buildDevPanel(); resize(); };
  centerRow.append(btnUseCX, btnClearCX); devPanel.appendChild(centerRow);
  if(OVT.centerX!=null) addRange(devPanel,'centerX (0â†’1)',OVT,'centerX',{min:0,max:1,step:0.001,after:()=>{saveCFG();resize();}});

  const bottomRow=document.createElement('div'); bottomRow.className='bar';
  const btnUseBP=document.createElement('button'); btnUseBP.textContent='Override bottomPct';
  const btnClearBP=document.createElement('button'); btnClearBP.textContent='Annuler override';
  btnUseBP.onclick=()=>{ if(OVT.bottomPct==null) OVT.bottomPct=(P().fighter.bottomPct||0); saveCFG(); buildDevPanel(); resize(); };
  btnClearBP.onclick=()=>{ OVT.bottomPct=null; saveCFG(); buildDevPanel(); resize(); };
  bottomRow.append(btnUseBP, btnClearBP); devPanel.appendChild(bottomRow);
  if(OVT.bottomPct!=null) addRange(devPanel,'bottomPct (0â†’~0.6)',OVT,'bottomPct',{min:-0.1,max:0.6,step:0.001,after:()=>{saveCFG();resize();}});

  devPanel.style.display='block';
}

/* ===== Mot de passe pour panneau (visuel) ===== */
let devUnlocked = (localStorage.getItem('wcs_dev_ok') === '1');
function askDevPassword(){
  if (devUnlocked) return true;
  const pwd = prompt('Mot de passe dÃ©veloppeur ?');
  if (pwd === 'Tocard'){
    devUnlocked = true;
    localStorage.setItem('wcs_dev_ok','1');
    return true;
  }
  return false;
}

/* ===== Toggle panneau (T) â€” version blindÃ©e ===== */
function toggleDevPanel(){
  const open = devPanel.style.display === 'block';
  if (open) {
    devPanel.style.display = 'none';
  } else {
    if (!askDevPassword()) return;
    buildDevPanel();
    devPanel.style.display = 'block';
    resize();
  }
}
function onKeyT(e){
  const isT = (e.code === 'KeyT') || (e.key && e.key.toLowerCase() === 't');
  if (!isT || e.repeat) return;
  e.preventDefault();
  e.stopPropagation();
  toggleDevPanel();
}
if (!window.__T_BIND) {
  window.addEventListener('keydown', onKeyT, { capture: true });
  document.addEventListener('keydown', onKeyT, { capture: true });
  devPanel.addEventListener('keydown', onKeyT, { capture: true });
  window.__T_BIND = true;
}

/* ===== Init ===== */
function init(){
  resize();
  applySkin(activeSkinIdx);
  const tag = document.getElementById('appVersion');
  if (tag) tag.textContent = APP_VERSION;
  requestAnimationFrame(loop);
}
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

/* PATCH: synchronise --vh avec la hauteur visible (Android/iOS) et re-resize */
(function(){
  const applyVH = () => {
    const h = window.visualViewport ? window.visualViewport.height : window.innerHeight;
    document.documentElement.style.setProperty('--vh', h + 'px');
    resize();
  };
  applyVH();
  if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', applyVH, {passive:true});
    window.visualViewport.addEventListener('scroll', applyVH, {passive:true});
  } else {
    window.addEventListener('resize', applyVH, {passive:true});
  }
})();
</script>
</body>
</html>
